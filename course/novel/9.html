<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>é¡¹ç›®ä¼˜åŒ– | å°è¯´ç²¾å“å±‹</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="img/logo.png">
    <meta name="description" content="å°è¯´ç²¾å“å±‹é¡¹ç›®æ–‡æ¡£æ˜¯ä¸€å¥—å¼€æºé¡¹ç›®çš„Javaå­¦ä¹ å’Œé¡¹ç›®å®æˆ˜æ•™ç¨‹,åŒ…æ‹¬SpringBoot3+Vue3é¡¹ç›®å®æˆ˜æ•™ç¨‹å’ŒSpringCloudå¾®æœåŠ¡é¡¹ç›®å®æˆ˜æ•™ç¨‹,æ‰‹æŠŠæ‰‹æ•™ä½ ä»é›¶å¼€å§‹å¼€å‘ä¸Šçº¿ä¸€å¥—ç”Ÿäº§çº§åˆ«çš„å°è¯´ç³»ç»Ÿ.">
    <meta name="keywords" content="Javaæœ€æ–°æŠ€æœ¯æ ˆå­¦ä¹ ,SpringBoot3å­¦ä¹ ,SpringBoot3é¡¹ç›®å®æˆ˜,Vue3é¡¹ç›®å®æˆ˜,Javaé¡¹ç›®å®æˆ˜,å¾®æœåŠ¡é¡¹ç›®å®æˆ˜">
    
    <link rel="preload" href="/assets/css/0.styles.b9105d85.css" as="style"><link rel="preload" href="/assets/js/app.6280180d.js" as="script"><link rel="preload" href="/assets/js/3.64ef1717.js" as="script"><link rel="preload" href="/assets/js/2.954998af.js" as="script"><link rel="preload" href="/assets/js/20.2d84071d.js" as="script"><link rel="prefetch" href="/assets/js/10.28fe92ba.js"><link rel="prefetch" href="/assets/js/11.d41ee02f.js"><link rel="prefetch" href="/assets/js/12.d94c66af.js"><link rel="prefetch" href="/assets/js/13.74652e21.js"><link rel="prefetch" href="/assets/js/14.2f792e3c.js"><link rel="prefetch" href="/assets/js/15.1deae68d.js"><link rel="prefetch" href="/assets/js/16.3f0252f7.js"><link rel="prefetch" href="/assets/js/17.497a772a.js"><link rel="prefetch" href="/assets/js/18.173f78ae.js"><link rel="prefetch" href="/assets/js/19.55db8822.js"><link rel="prefetch" href="/assets/js/21.ec7b29e7.js"><link rel="prefetch" href="/assets/js/22.c0249cb5.js"><link rel="prefetch" href="/assets/js/23.95dcaf3f.js"><link rel="prefetch" href="/assets/js/24.2e655ccd.js"><link rel="prefetch" href="/assets/js/25.ae6247c4.js"><link rel="prefetch" href="/assets/js/26.f4af31aa.js"><link rel="prefetch" href="/assets/js/27.9eb4c5d8.js"><link rel="prefetch" href="/assets/js/28.db27b001.js"><link rel="prefetch" href="/assets/js/29.dfe34280.js"><link rel="prefetch" href="/assets/js/30.76ef90c1.js"><link rel="prefetch" href="/assets/js/31.ca3916c7.js"><link rel="prefetch" href="/assets/js/32.1838893a.js"><link rel="prefetch" href="/assets/js/33.e5f4a5d8.js"><link rel="prefetch" href="/assets/js/34.fc82d81e.js"><link rel="prefetch" href="/assets/js/35.6fde2e58.js"><link rel="prefetch" href="/assets/js/36.0b151136.js"><link rel="prefetch" href="/assets/js/37.3e58e69f.js"><link rel="prefetch" href="/assets/js/38.5df1893b.js"><link rel="prefetch" href="/assets/js/39.2950d598.js"><link rel="prefetch" href="/assets/js/4.05d8729e.js"><link rel="prefetch" href="/assets/js/5.8c128a4a.js"><link rel="prefetch" href="/assets/js/6.4b2b1e57.js"><link rel="prefetch" href="/assets/js/7.8bb179a1.js"><link rel="prefetch" href="/assets/js/8.480536c4.js"><link rel="prefetch" href="/assets/js/9.d0425c9f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b9105d85.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="å°è¯´ç²¾å“å±‹" class="logo"> <span class="site-name can-hide">å°è¯´ç²¾å“å±‹</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  å®˜ç½‘
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://117.72.165.13:8888" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æ¼”ç¤ºç½‘ç«™
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project Menu" class="dropdown-title"><span class="title">é¡¹ç›®æ–‡æ¡£</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project Menu" class="mobile-dropdown-title"><span class="title">é¡¹ç›®æ–‡æ¡£</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/course/novel/" class="nav-link router-link-active">
  novel
</a></li><li class="dropdown-item"><!----> <a href="/course/novelplus/" class="nav-link">
  novel-plus
</a></li><li class="dropdown-item"><!----> <a href="/course/novelcloud/" class="nav-link">
  novel-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub Menu" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub Menu" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Gitee Menu" class="dropdown-title"><span class="title">ç äº‘</span> <span class="arrow down"></span></button> <button type="button" aria-label="Gitee Menu" class="mobile-dropdown-title"><span class="title">ç äº‘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/suport/" class="nav-link">
  ğŸ’– æ”¯æŒ
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com/service.htm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  è”ç³»æˆ‘ä»¬
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  é¦–é¡µ
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  å®˜ç½‘
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://117.72.165.13:8888" target="_blank" rel="noopener noreferrer" class="nav-link external">
  æ¼”ç¤ºç½‘ç«™
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project Menu" class="dropdown-title"><span class="title">é¡¹ç›®æ–‡æ¡£</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project Menu" class="mobile-dropdown-title"><span class="title">é¡¹ç›®æ–‡æ¡£</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/course/novel/" class="nav-link router-link-active">
  novel
</a></li><li class="dropdown-item"><!----> <a href="/course/novelplus/" class="nav-link">
  novel-plus
</a></li><li class="dropdown-item"><!----> <a href="/course/novelcloud/" class="nav-link">
  novel-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub Menu" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub Menu" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Gitee Menu" class="dropdown-title"><span class="title">ç äº‘</span> <span class="arrow down"></span></button> <button type="button" aria-label="Gitee Menu" class="mobile-dropdown-title"><span class="title">ç äº‘</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/suport/" class="nav-link">
  ğŸ’– æ”¯æŒ
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com/service.htm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  è”ç³»æˆ‘ä»¬
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/course/novel/" aria-current="page" class="sidebar-link">å¿«é€Ÿå¼€å§‹</a></li><li><a href="/course/novel/1.html" class="sidebar-link">æŠ€æœ¯æ¶æ„</a></li><li><a href="/course/novel/2.html" class="sidebar-link">æŠ€æœ¯è¦ç‚¹</a></li><li><a href="/course/novel/3.html" class="sidebar-link">æ•°æ®åº“è®¾è®¡</a></li><li><a href="/course/novel/4.html" class="sidebar-link">é¡¹ç›®å¼€å‘</a></li><li><a href="/course/novel/9.html" aria-current="page" class="active sidebar-link">é¡¹ç›®ä¼˜åŒ–</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨ç­–ç•¥æ¨¡å¼é‡æ„å¤šç³»ç»Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·è®¤è¯æˆæƒ" class="sidebar-link">ä½¿ç”¨ç­–ç•¥æ¨¡å¼é‡æ„å¤šç³»ç»Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·è®¤è¯æˆæƒ</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨è£…é¥°è€…æ¨¡å¼è§£å†³è¡¨å•å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»" class="sidebar-link">ä½¿ç”¨è£…é¥°è€…æ¨¡å¼è§£å†³è¡¨å•å½¢å¼ä¼ å‚çš„ XSS æ”»å‡»</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®ç°å¯æ‹“å±•çš„æ¶ˆæ¯å‘é€å™¨" class="sidebar-link">ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®ç°å¯æ‹“å±•çš„æ¶ˆæ¯å‘é€å™¨</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä¸€è¡Œä»£ç è§£å†³-json-å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»" class="sidebar-link">ä¸€è¡Œä»£ç è§£å†³ JSON å½¢å¼ä¼ å‚çš„ XSS æ”»å‡»</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#é›†æˆ-elasticsearch-8-å®ç°æœç´¢å¼•æ“åŠ¨æ€åˆ‡æ¢" class="sidebar-link">é›†æˆ Elasticsearch 8ï¼Œå®ç°æœç´¢å¼•æ“åŠ¨æ€åˆ‡æ¢</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨-rabbitmq-åˆ·æ–°-es-redis-caffeine-ç­‰å°è¯´å‰¯æœ¬æ•°æ®" class="sidebar-link">ä½¿ç”¨ RabbitMQ åˆ·æ–° ES/Redis/Caffeine ç­‰å°è¯´å‰¯æœ¬æ•°æ®</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨-xxl-job-ä¼˜åŒ–-elasticsearch-æ•°æ®åŒæ­¥ä»»åŠ¡" class="sidebar-link">ä½¿ç”¨ XXL-JOB ä¼˜åŒ– Elasticsearch æ•°æ®åŒæ­¥ä»»åŠ¡</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨-sentinel-å®ç°æ¥å£é˜²åˆ·å’Œé™æµ" class="sidebar-link">ä½¿ç”¨ Sentinel å®ç°æ¥å£é˜²åˆ·å’Œé™æµ</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#é›†æˆ-shardingsphere-jdbc-ä¼˜åŒ–å°è¯´å†…å®¹å­˜å‚¨" class="sidebar-link">é›†æˆ ShardingSphere-JDBC ä¼˜åŒ–å°è¯´å†…å®¹å­˜å‚¨</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#é›†æˆ-spring-boot-admin-å®ç°åº”ç”¨ç®¡ç†å’Œç›‘æ§åŠŸèƒ½" class="sidebar-link">é›†æˆ Spring Boot Admin å®ç°åº”ç”¨ç®¡ç†å’Œç›‘æ§åŠŸèƒ½</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#ä½¿ç”¨-docker-compose-ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒ" class="sidebar-link">ä½¿ç”¨ Docker Compose ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒ</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#é›†æˆ-flyway-å®ç°æ•°æ®åº“çš„ç‰ˆæœ¬ç®¡ç†" class="sidebar-link">é›†æˆ Flyway å®ç°æ•°æ®åº“çš„ç‰ˆæœ¬ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#å¼€å¯è™šæ‹Ÿçº¿ç¨‹-æé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›" class="sidebar-link">å¼€å¯è™šæ‹Ÿçº¿ç¨‹ï¼Œæé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›</a></li></ul></li><li><a href="/course/novel/6.html" class="sidebar-link">é¡¹ç›®éƒ¨ç½²</a></li><li><a href="/course/novel/12.html" class="sidebar-link">æ›´å¤š</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="é¡¹ç›®ä¼˜åŒ–"><a href="#é¡¹ç›®ä¼˜åŒ–" class="header-anchor">#</a> é¡¹ç›®ä¼˜åŒ–</h1> <h2 id="ä½¿ç”¨ç­–ç•¥æ¨¡å¼é‡æ„å¤šç³»ç»Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·è®¤è¯æˆæƒ"><a href="#ä½¿ç”¨ç­–ç•¥æ¨¡å¼é‡æ„å¤šç³»ç»Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·è®¤è¯æˆæƒ" class="header-anchor">#</a> ä½¿ç”¨ç­–ç•¥æ¨¡å¼é‡æ„å¤šç³»ç»Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·è®¤è¯æˆæƒ</h2> <h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="header-anchor">#</a> éœ€æ±‚</h3> <p>å°è¯´ç²¾å“å±‹ç”±å‰å°é—¨æˆ·ç³»ç»Ÿã€ä½œå®¶åå°ç®¡ç†ç³»ç»Ÿã€å¹³å°åå°ç®¡ç†ç³»ç»Ÿå’Œçˆ¬è™«ç®¡ç†ç³»ç»Ÿä»¥åŠåé¢å¯èƒ½ä¼šæ‰©å±•çš„æ¼«ç”»ç³»ç»Ÿå’Œè§†é¢‘ç³»ç»Ÿç­‰å¤šä¸ªå­ç³»ç»Ÿæ„æˆï¼Œæ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šç³»ç»Ÿç¯å¢ƒã€‚å¹³å°ç«¯çš„åå°ç®¡ç†ç³»ç»Ÿå’Œçˆ¬è™«ç®¡ç†ç³»ç»Ÿè´¦å·æ˜¯ç‹¬ç«‹çš„ï¼Œç”¨æˆ·ç«¯å…¶å®ƒå­ç³»ç»Ÿè¦æ±‚ç»Ÿä¸€è´¦å·ç™»å½•ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è®¾è®¡æ‰èƒ½ç»Ÿä¸€å¯¹è¿™äº›ç³»ç»Ÿè¿›è¡Œè®¤è¯æˆæƒå‘¢ ï¼Ÿ</p> <h3 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="header-anchor">#</a> å®ç°æ€è·¯</h3> <p>æˆ‘ä»¬æä¾›å¹³å°ç®¡ç†åå°ã€çˆ¬è™«ç®¡ç†åå°å’Œå•ç‚¹ç™»å½•ä¸‰ä¸ªç™»å½•å…¥å£ï¼Œå‰ç«¯åœ¨æ¯ä¸ªç™»å½•å…¥å£ç™»å½•æˆåŠŸä¹‹åéƒ½ä¼šè·å¾—åç«¯è¿”å›çš„ tokenï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åˆ†åˆ«ä¿å­˜èµ·æ¥ï¼Œ
åœ¨è¯·æ±‚ç›¸åº”ç³»ç»Ÿçš„åç«¯æ¥å£æ—¶ï¼Œé€šè¿‡è¯·æ±‚å¤´æºå¸¦ä¸Šç›¸åº”çš„ tokenã€‚</p> <p>åç«¯éœ€è¦é…ç½®ä¸€ä¸ªç»Ÿä¸€çš„æ‹¦æˆªå™¨ï¼Œæ ¹æ®è¯·æ±‚çš„ URI è¯†åˆ«å‡ºç›¸åº”ç³»ç»Ÿç±»å‹ï¼Œå¹¶å¯¹è¿™äº› token è¿›è¡Œè§£æå¾—åˆ° userIdã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥æ ¹æ®ç”¨æˆ·æ¥é‰´æƒï¼Œå¦‚æœç”¨æˆ·æœ‰æƒè®¿é—®ï¼Œåˆ™æ”¾è¡Œã€‚å¦åˆ™ï¼Œè¿”å›ä¸€ä¸ªç›¸åº”çš„é”™è¯¯ç ç»™å‰ç«¯ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¡éªŒç™»å½• token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">HTTP_AUTH_HEADER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_FRONT_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ ¡éªŒé—¨æˆ·ç³»ç»Ÿç”¨æˆ·æƒé™</span>
                <span class="token class-name">Long</span> userId <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOVEL_FRONT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¹¶æ ¡éªŒè´¦å·çŠ¶æ€æ˜¯å¦æ­£å¸¸</span>
                    <span class="token comment">// TODO å…¶å®ƒæƒé™æ ¡éªŒ</span>
                    <span class="token comment">// è®¤è¯æˆåŠŸ</span>
                    <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// TODO æ ¡éªŒä½œå®¶åå°ç®¡ç†ç³»ç»Ÿç”¨æˆ·æƒé™</span>

            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_ADMIN_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// TODO æ ¡éªŒå¹³å°åå°ç®¡ç†ç³»ç»Ÿç”¨æˆ·æƒé™</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//ã€‚ã€‚ã€‚æ›´å¤šç³»ç»Ÿæƒé™æ ¡éªŒ</span>
            <span class="token comment">// å®Œæ•´å®ç°å¯èƒ½è‡³å°‘å‡ ç™¾è¡Œçš„ä»£ç </span>

        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶ï¼Œå¯ä»¥ç®€å•çš„å®ç°åŸºæœ¬çš„æƒé™æ‹¦æˆªåŠŸèƒ½ã€‚ä½†æ˜¯å› ä¸ºæ‰€æœ‰ç³»ç»Ÿçš„è®¤è¯æˆæƒé€»è¾‘éƒ½åœ¨è¿™ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œä»£ç åŠå…¶è‡ƒè‚¿éš¾ä»¥ç»´æŠ¤ã€‚æ¯å½“æŸä¸€ç³»ç»Ÿæˆæƒé€»è¾‘å‘ç”Ÿå˜åŒ–æˆ–è€…æ–°å¢åŠ äº†ä¸€ä¸ªå­ç³»ç»Ÿï¼Œéƒ½éœ€è¦ä¿®æ”¹æ­¤å¤„çš„ä»£ç ã€‚ä¿®æ”¹ä¹‹å‰ä¸ä½†å¿…é¡»å…ˆå®Œå…¨ç†è§£è¿™ä¸€å¤§æ®µä»£ç ï¼Œæ­£ç¡®å®šä½åˆ°éœ€è¦ä¿®æ”¹çš„ä½ç½®ï¼Œè€Œä¸”æå…¶å®¹æ˜“å½±å“åˆ°ä¸ç›¸å¹²çš„å…¶å®ƒç³»ç»Ÿè®¤è¯æˆæƒåŠŸèƒ½ã€‚ä¹…è€Œä¹…ä¹‹å°±æ²¡æœ‰äººæ„¿æ„ç»´æŠ¤è¿™éƒ¨åˆ†ä»£ç äº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥é‡æ„è¯¥åŠŸèƒ½ã€‚</p> <h3 id="ç­–ç•¥æ¨¡å¼å®šä¹‰"><a href="#ç­–ç•¥æ¨¡å¼å®šä¹‰" class="header-anchor">#</a> ç­–ç•¥æ¨¡å¼å®šä¹‰</h3> <blockquote><p>ç­–ç•¥æ¨¡å¼å®šä¹‰äº†ç®—æ³•æ—ï¼Œåˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥äº’ç›¸æ›¿æ¢ï¼Œæ­¤æ¨¡å¼è®©ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚</p></blockquote> <p>ç­–ç•¥æ¨¡å¼çš„æ ¸å¿ƒåœ¨äºå°è£…å˜åŒ–ï¼Œåœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­å°±æ˜¯å®šä¹‰å¤šä¸ªä¸åŒç³»ç»Ÿçš„è®¤è¯æˆæƒç­–ç•¥ï¼ˆç®—æ³•æ—ï¼‰ï¼Œåˆ†åˆ«å°è£…æˆç‹¬ç«‹çš„ç±»ã€‚æ‹¦æˆªå™¨ï¼ˆå®¢æˆ·ï¼‰åœ¨è¿è¡Œæ—¶æ ¹æ®å…·ä½“çš„è¯·æ±‚ URI æ¥åŠ¨æ€è°ƒç”¨ç›¸åº”ç³»ç»Ÿçš„è®¤è¯æˆæƒç®—æ³•ã€‚å½“æŸä¸€ç³»ç»Ÿçš„è®¤è¯æˆæƒé€»è¾‘å‘ç”Ÿå˜åŒ–æˆ–å¢åŠ æ–°çš„å­ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æˆ–å¢åŠ ç›¸åº”çš„ç­–ç•¥ç±»ï¼Œè€Œä¸ä¼šå½±å“åˆ°å…¶å®ƒçš„ç­–ç•¥ç±»ï¼ˆå­ç³»ç»Ÿï¼‰å’Œå®¢æˆ·ï¼ˆæ‹¦æˆªå™¨ï¼‰ã€‚</p> <h3 id="é‡æ„æ­¥éª¤"><a href="#é‡æ„æ­¥éª¤" class="header-anchor">#</a> é‡æ„æ­¥éª¤</h3> <ol><li>åœ¨<code>io.github.xxyopen.novel.core.auth</code>åŒ…ä¸‹åˆ›å»º AuthStrategy æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†ä¸€ä¸ªé»˜è®¤çš„æ–¹æ³•å®ç°ç”¨æˆ·ç«¯æ‰€æœ‰å­ç³»ç»Ÿéƒ½éœ€è¦çš„ç»Ÿä¸€è´¦å·è®¤è¯é€»è¾‘å’Œä¸€ä¸ªå°è£…å„ä¸ªç³»ç»Ÿç‹¬ç«‹è®¤è¯æˆæƒé€»è¾‘çš„å¾…å®ç°æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œä½œå®¶ç®¡ç†ç³»ç»Ÿè¿˜éœ€è¦éªŒè¯ä½œå®¶è´¦å·æ˜¯å¦å­˜åœ¨å’Œä½œå®¶çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼‰ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * ç­–ç•¥æ¨¡å¼å®ç°ç”¨æˆ·è®¤è¯æˆæƒåŠŸèƒ½
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * ç”¨æˆ·è®¤è¯æˆæƒ
     *
     * @param token      ç™»å½• token
     * @param requestUri è¯·æ±‚çš„ URI
     * @throws BusinessException è®¤è¯å¤±è´¥åˆ™æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
     */</span>
    <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * å‰å°å¤šç³»ç»Ÿå•ç‚¹ç™»å½•ç»Ÿä¸€è´¦å·è®¤è¯ï¼ˆé—¨æˆ·ç³»ç»Ÿã€ä½œå®¶ç³»ç»Ÿä»¥åŠåé¢ä¼šæ‰©å±•çš„æ¼«ç”»ç³»ç»Ÿå’Œè§†é¢‘ç³»ç»Ÿç­‰ï¼‰
     *
     * @param jwtUtils             jwt å·¥å…·
     * @param userInfoCacheManager ç”¨æˆ·ç¼“å­˜ç®¡ç†å¯¹è±¡
     * @param token                token ç™»å½• token
     * @return ç”¨æˆ·ID
     */</span>
    <span class="token keyword">default</span> <span class="token class-name">Long</span> <span class="token function">authSSO</span><span class="token punctuation">(</span><span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">,</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">,</span>
        <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// token ä¸ºç©º</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOVEL_FRONT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// token è§£æå¤±è´¥</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UserInfoDto</span> userInfo <span class="token operator">=</span> userInfoCacheManager<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç”¨æˆ·ä¸å­˜åœ¨</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_ACCOUNT_NOT_EXIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®¾ç½® userId åˆ°å½“å‰çº¿ç¨‹</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿”å› userId</span>
        <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>æ¥ç€åœ¨è¯¥åŒ…ä¸‹åˆ›å»ºå„ä¸ªç³»ç»Ÿçš„è®¤è¯æˆæƒç­–ç•¥ç±»ï¼Œå®ç°ä¸Šè¿°çš„ AuthStrategy æ¥å£ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * å‰å°é—¨æˆ·ç³»ç»Ÿ è®¤è¯æˆæƒç­–ç•¥
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FrontAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿä¸€è´¦å·è®¤è¯</span>
        <span class="token function">authSSO</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">,</span> userInfoCacheManager<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * ä½œå®¶åå°ç®¡ç†ç³»ç»Ÿ è®¤è¯æˆæƒç­–ç•¥
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorInfoCacheManager</span> authorInfoCacheManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ä¸éœ€è¦è¿›è¡Œä½œå®¶æƒé™è®¤è¯çš„ URI
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">EXCLUDE_URI</span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span>
        <span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;/status&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿä¸€è´¦å·è®¤è¯</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token function">authSSO</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">,</span> userInfoCacheManager<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">EXCLUDE_URI</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>requestUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¯¥è¯·æ±‚ä¸éœ€è¦è¿›è¡Œä½œå®¶æƒé™è®¤è¯</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä½œå®¶æƒé™æ ¡éªŒ</span>
        <span class="token class-name">AuthorInfoDto</span> authorInfo <span class="token operator">=</span> authorInfoCacheManager<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>authorInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä½œå®¶è´¦å·ä¸å­˜åœ¨ï¼Œæ— æƒè®¿é—®ä½œå®¶ä¸“åŒº</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_UN_AUTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è®¾ç½®ä½œå®¶IDåˆ°å½“å‰çº¿ç¨‹</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">setAuthorId</span><span class="token punctuation">(</span>authorInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * å¹³å°åå°ç®¡ç†ç³»ç»Ÿ è®¤è¯æˆæƒç­–ç•¥
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdminAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO å¹³å°åå° token æ ¡éªŒ</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>æœ€ååœ¨æ‹¦æˆªå™¨ä¸­æ ¹æ®è¯·æ±‚ URI åŠ¨æ€è°ƒç”¨ç›¸åº”ç­–ç•¥ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * è®¤è¯æˆæƒ æ‹¦æˆªå™¨
 * ä¸ºäº†æ³¨å…¥å…¶å®ƒçš„ Spring beansï¼Œéœ€è¦é€šè¿‡ @Component æ³¨è§£å°†è¯¥æ‹¦æˆªå™¨æ³¨å†Œåˆ° Spring ä¸Šä¸‹æ–‡
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">AuthStrategy</span><span class="token punctuation">&gt;</span></span> authStrategy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ç™»å½• JWT</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">HTTP_AUTH_HEADER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è·å–è¯·æ±‚çš„ URI</span>
        <span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ ¹æ®è¯·æ±‚çš„ URI å¾—åˆ°è®¤è¯ç­–ç•¥</span>
        <span class="token class-name">String</span> subUri <span class="token operator">=</span> requestUri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_URL_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> systemName <span class="token operator">=</span> subUri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>subUri<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> authStrategyName <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%sAuthStrategy&quot;</span><span class="token punctuation">,</span>systemName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¼€å§‹è®¤è¯</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            authStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>authStrategyName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BusinessException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// è®¤è¯å¤±è´¥</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getErrorCodeEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…ç†å½“å‰çº¿ç¨‹ä¿å­˜çš„ç”¨æˆ·æ•°æ®</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä½¿ç”¨è£…é¥°è€…æ¨¡å¼è§£å†³è¡¨å•å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»"><a href="#ä½¿ç”¨è£…é¥°è€…æ¨¡å¼è§£å†³è¡¨å•å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»" class="header-anchor">#</a> ä½¿ç”¨è£…é¥°è€…æ¨¡å¼è§£å†³è¡¨å•å½¢å¼ä¼ å‚çš„ XSS æ”»å‡»</h2> <h3 id="xss-æ”»å‡»å®šä¹‰"><a href="#xss-æ”»å‡»å®šä¹‰" class="header-anchor">#</a> XSS æ”»å‡»å®šä¹‰</h3> <blockquote><p>è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆXSSï¼‰ï¼Œæ˜¯æœ€æ™®éçš„ Web åº”ç”¨å®‰å…¨æ¼æ´ã€‚èƒ½å¤Ÿä½¿å¾—æ”»å‡»è€…åµŒå…¥æ¶æ„è„šæœ¬ä»£ç åˆ°æ­£å¸¸ç”¨æˆ·ä¼šè®¿é—®åˆ°çš„é¡µé¢ä¸­ï¼Œå½“æ­£å¸¸ç”¨æˆ·è®¿é—®è¯¥é¡µé¢æ—¶ï¼Œåˆ™å¯å¯¼è‡´åµŒå…¥çš„æ¶æ„è„šæœ¬ä»£ç çš„æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ¶æ„æ”»å‡»ç”¨æˆ·çš„ç›®çš„ã€‚</p></blockquote> <p>ä¾‹å¦‚ï¼Œåœ¨ novel é¡¹ç›®ä¸­ï¼Œå¦‚æœæ²¡æœ‰é¢„é˜² XSS æ”»å‡»çš„è¯ã€‚æ¶æ„ç”¨æˆ·è¿›å…¥åˆ°æˆ‘ä»¬å°è¯´è¯„è®ºåŒºï¼Œå‘è¡¨å¦‚ä¸‹è¯„è®ºï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token comment">// è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è®¤è¯ token</span>
    token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO é€šè¿‡ ajax è¯·æ±‚å‘é€è¯¥ token åˆ°æ¶æ„ç”¨æˆ·çš„æŒ‡å®šæœåŠ¡å™¨</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>å½“å…¶ä»–æ­£å¸¸ç”¨æˆ·ç™»å½•æˆåŠŸè¿›å…¥åˆ°å°è¯´è¯„è®ºåŒºåï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œä¸Šè¿°çš„ javascript è„šæœ¬ï¼Œè‡ªå·±çš„ç™»å½• token ä¼šè¢«å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ä¸Šã€‚æ”»å‡»è€…æ‹¿åˆ°è¯¥ token åå³å¯åˆ©ç”¨è¯¥ token æ¥å†’å……æ­£å¸¸ç”¨æˆ·è¿›è¡Œä¸€ç³»åˆ—ä¾‹å¦‚èµ„é‡‘è½¬è´¦ç­‰å±é™©æ“ä½œã€‚</p> <p>æ”»å‡»è€…è¿˜å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­æ’å…¥æ¶æ„å†…å®¹ï¼ˆä¾‹å¦‚å¹¿å‘Šï¼‰ã€é‡å®šå‘ç”¨æˆ·ï¼ˆé‡å®šå‘åˆ°é»„èµŒæ¯’ç½‘ç«™ï¼‰ç­‰ã€‚</p> <p>æ³¨ï¼šäººä»¬ç»å¸¸å°†è·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆCross Site Scriptingï¼‰ç¼©å†™ä¸º CSSï¼Œä½†è¿™ä¼šä¸å±‚å æ ·å¼è¡¨ï¼ˆCascading Style Sheetsï¼ŒCSSï¼‰çš„ç¼©å†™æ··æ·†ã€‚å› æ­¤ï¼Œæœ‰äººå°†è·¨ç«™è„šæœ¬æ”»å‡»ç¼©å†™ä¸º XSSã€‚</p> <h3 id="è£…é¥°è€…æ¨¡å¼å®šä¹‰"><a href="#è£…é¥°è€…æ¨¡å¼å®šä¹‰" class="header-anchor">#</a> è£…é¥°è€…æ¨¡å¼å®šä¹‰</h3> <blockquote><p>åŠ¨æ€å°†è´£ä»»é™„åŠ åˆ°å¯¹è±¡ä¸Šã€‚æƒ³è¦æ‰©å±•åŠŸèƒ½ï¼Œè£…é¥°è€…æä¾›æœ‰åˆ«äºç»§æ‰¿çš„å¦ä¸€ç§é€‰æ‹©ã€‚</p></blockquote> <p>è£…é¥°è€…å¯ä»¥åœ¨è¢«è£…é¥°è€…çš„è¡Œä¸ºå‰é¢ä¸/æˆ–åé¢åŠ ä¸Šè‡ªå·±çš„è¡Œä¸ºï¼Œç”šè‡³å°†è¢«è£…é¥°è€…çš„è¡Œä¸ºæ•´ä¸ªå–ä»£æ‰ï¼Œè€Œè¾¾åˆ°ç‰¹å®šçš„ç›®çš„ã€‚</p> <p>Spring MVC æ˜¯é€šè¿‡ HttpServletRequest çš„ getParameterValues æ–¹æ³•æ¥è·å–ç”¨æˆ·ç«¯çš„è¯·æ±‚å‚æ•°å¹¶ç»‘å®šåˆ°æˆ‘ä»¬ @RequestMapping æ–¹æ³•å®šä¹‰çš„å¯¹è±¡ä¸Šã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è£…é¥° HttpServletRequest å¯¹è±¡ï¼Œåœ¨ getParameterValues æ–¹æ³•é‡ŒåŠ ä¸Šè‡ªå·±çš„è¡Œä¸ºï¼ˆå¯¹è¯·æ±‚å‚æ•°å€¼é‡Œé¢çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼‰æ¥è§£å†³ XSS æ”»å‡»ã€‚</p> <p>ç”±äº Servlet Api æä¾›äº† HttpServletRequest æ¥å£çš„ä¾¿æ·å®ç° HttpServletRequestWrapper ç±»ï¼Œè¯¥ç±»å·²ç»å®ç°äº†è£…é¥°è€…æ¨¡å¼ï¼Œæˆ‘ä»¬ç›´æ¥ç»§æ‰¿è¯¥ç±»å¹¶é‡å†™é‡Œé¢çš„ getParameterValues æ–¹æ³•å³å¯ã€‚</p> <h3 id="å®ç°æ­¥éª¤"><a href="#å®ç°æ­¥éª¤" class="header-anchor">#</a> å®ç°æ­¥éª¤</h3> <ol><li>æ–°å»º XssHttpServletRequestWrapper è£…é¥°è€…ç±»ç»§æ‰¿ HttpServletRequestWrapper ç±»ï¼Œå¹¶é‡å†™ getParameterValues æ–¹æ³•ï¼Œå¯¹é‡Œé¢å­—ç¬¦ä¸²çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssHttpServletRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">REPLACE_RULE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;lt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">XssHttpServletRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> length <span class="token operator">=</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> escapeValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                escapeValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token operator">-&gt;</span> escapeValues<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> escapeValues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> escapeValues<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>æ–°å»º XssFilter è¿‡æ»¤å™¨ï¼Œä½¿ç”¨ XssHttpServletRequestWrapper è£…é¥°è€…å¯¹è±¡æ›¿æ¢æ‰ HttpServletRequest è¢«è£…é¥°è€…å¯¹è±¡ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">XssHttpServletRequestWrapper</span> xssRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XssHttpServletRequestWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>xssRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®ç°å¯æ‹“å±•çš„æ¶ˆæ¯å‘é€å™¨"><a href="#ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®ç°å¯æ‹“å±•çš„æ¶ˆæ¯å‘é€å™¨" class="header-anchor">#</a> ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®ç°å¯æ‹“å±•çš„æ¶ˆæ¯å‘é€å™¨</h2> <h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="header-anchor">#</a> èƒŒæ™¯</h3> <p>éšç€ç³»ç»Ÿä¸šåŠ¡çš„å‘å±•ï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦åœ¨åŒ…æ‹¬ä¼šå‘˜æ³¨å†ŒæˆåŠŸã€ä»£å¸å……å€¼æˆåŠŸã€ç§’æ€æ´»åŠ¨å³å°†å¼€å§‹ã€è´¦æˆ·å°ç¦ã€å°è¯´ä¸‹æ¶ç­‰ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶å‘é€å„ç§ç±»å‹çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé€šçŸ¥ã€é‚®ä»¶ã€çŸ­ä¿¡ã€å¾®ä¿¡é€šçŸ¥ç­‰ï¼Œæ¯ç§äº‹ä»¶å‘ç”Ÿæ—¶éœ€è¦å‘é€çš„æ¶ˆæ¯æ ¼å¼éƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦å‘é€çš„æ¶ˆæ¯ç±»å‹ä¹Ÿä¸ä¸€æ ·ï¼Œè€Œä¸”è¿™äº›éœ€æ±‚å¯èƒ½éšæ—¶éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå¦‚ä½•è®¾è®¡ä¸€ä¸ªçµæ´»çš„æ¶ˆæ¯å‘é€ç³»ç»Ÿæ¥åº”å¯¹è¿™ç§å¤šå˜çš„éœ€æ±‚å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼è¿›è¡Œè®¾è®¡ã€‚</p> <h3 id="æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®šä¹‰"><a href="#æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®šä¹‰" class="header-anchor">#</a> æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å®šä¹‰</h3> <blockquote><p>åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶ç»­åˆ°å­ç±»ä¸­ã€‚æ¨¡ç‰ˆæ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥åœ¨ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®šä¹‰ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤ã€‚æœ‰äº†æ¨¡ç‰ˆæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸“å®¶ä¸€æ ·å¤ç”¨ä»£ç ï¼ŒåŒæ—¶ä¿æŒå¯¹ç®—æ³•çš„æ§åˆ¶ã€‚</p></blockquote> <h3 id="å®ç°æ€è·¯-2"><a href="#å®ç°æ€è·¯-2" class="header-anchor">#</a> å®ç°æ€è·¯</h3> <p>åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯å‘é€çš„ç®—æ³•ï¼ˆå‘é€çš„æ­¥éª¤ï¼‰æ˜¯ä¸€è‡´çš„ï¼Œå¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹ 5 ä¸ªæ­¥éª¤ï¼š</p> <ol><li>è·å–æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆ</li> <li>è·å–æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆ</li> <li>è§£ææ¶ˆæ¯æ¨¡ç‰ˆï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯æ ‡é¢˜</li> <li>è§£ææ¶ˆæ¯å†…å®¹ï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹</li> <li>å‘é€æ¶ˆæ¯</li></ol> <p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæŠ½è±¡çš„æ¶ˆæ¯å‘é€å™¨ <code>AbstractMessageSender</code>ï¼Œå¹¶åœ¨æ¶ˆæ¯å‘é€çš„æ¨¡ç‰ˆæ–¹æ³• <code>sendMessage</code> ä¸­å°è£…æ¶ˆæ¯å‘é€çš„ç®—æ³•ï¼Œä¸ºäº†é˜²æ­¢å­ç±»ä¿®æ”¹è¯¥æ¨¡ç‰ˆä¸­å®šä¹‰çš„ç®—æ³•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°† <code>sendMessage</code> æ–¹æ³•å£°æ˜ä¸º <code>final</code>ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å®šä¹‰æ¶ˆæ¯å‘é€çš„æ¨¡ç‰ˆï¼Œå­ç±»ä¸èƒ½ä¿®æ”¹æ­¤æ¨¡ç‰ˆ
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.è·å–æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆ</span>
        <span class="token class-name">String</span> titleTemplate <span class="token operator">=</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.è·å–æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆ</span>
        <span class="token class-name">String</span> contentTemplate <span class="token operator">=</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.è§£ææ¶ˆæ¯æ¨¡ç‰ˆï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯æ ‡é¢˜</span>
        <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span>titleTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.è§£ææ¶ˆæ¯å†…å®¹ï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.å‘é€æ¶ˆæ¯</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>toUserId<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ä¸åŒç±»å‹çš„æ¶ˆæ¯å†³å®šäº†æ¶ˆæ¯å®é™…é€è¾¾çš„ä½ç½®ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼šç³»ç»Ÿé€šçŸ¥éœ€è¦å°†æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ã€é‚®ä»¶æ¶ˆæ¯éœ€è¦å‘é€åˆ°ç”¨æˆ·çš„é‚®ç®±ã€çŸ­ä¿¡æ¶ˆæ¯éœ€è¦å‘é€åˆ°å¯¹æ–¹çš„æ‰‹æœºå·ã€å¾®ä¿¡é€šçŸ¥éœ€è¦å‘é€åˆ°å¯¹æ–¹çš„å¾®ä¿¡ç­‰ç­‰ã€‚æ‰€ä»¥æ¶ˆæ¯å‘é€ç®—æ³•ä¸­çš„ç¬¬ 5 ä¸ªæ­¥éª¤åº”è¯¥å®šä¹‰æˆæŠ½è±¡çš„æ–¹æ³•ï¼Œç„¶åç”±ä¸åŒå­ç±»å‹çš„æ¶ˆæ¯å‘é€å™¨ï¼ˆé‚®ä»¶å‘é€å™¨ã€ç³»ç»Ÿé€šçŸ¥å‘é€å™¨ç­‰ï¼‰å»å®ç°è¯¥æ­¥éª¤ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO æ ¹æ®æ¶ˆæ¯æ¥æ”¶æ–¹çš„ç”¨æˆ·IDæŸ¥è¯¢å‡ºæ¶ˆæ¯æ¥æ”¶æ–¹çš„é‚®ä»¶åœ°å€</span>
        <span class="token class-name">String</span> toEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// å¼€å§‹å‘é€é‚®ä»¶</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶å¼€å§‹ï¼š{},{},{}&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä½¿ç”¨ MimeMessageï¼ŒMIME åè®®</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> helper<span class="token punctuation">;</span>
        <span class="token comment">// MimeMessageHelper å¸®åŠ©æˆ‘ä»¬è®¾ç½®æ›´ä¸°å¯Œçš„å†…å®¹</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mailProperties<span class="token punctuation">.</span><span class="token function">nickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>messageTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç¬¬äºŒä¸ªå‚æ•° true ä»£è¡¨æ”¯æŒ html</span>
            helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>messageContent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶ to {} æˆåŠŸ&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‚®ä»¶å‘é€å¤±è´¥ä¸ä¼šé‡è¯•</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶ to {} å¤±è´¥&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>ä¸åŒç±»å‹ï¼ˆç³»ç»Ÿé€šçŸ¥ã€é‚®ä»¶ã€çŸ­ä¿¡ã€å¾®ä¿¡é€šçŸ¥ç­‰ï¼‰çš„æ¶ˆæ¯ä»¥åŠä¸åŒå‘é€æ—¶æœºï¼ˆä¼šå‘˜æ³¨å†ŒæˆåŠŸã€ä»£å¸å……å€¼æˆåŠŸã€ç§’æ€æ´»åŠ¨å³å°†å¼€å§‹ã€è´¦æˆ·å°ç¦ã€å°è¯´ä¸‹æ¶ç­‰ï¼‰çš„æ¶ˆæ¯å†³å®šäº†ä¸åŒçš„æ¶ˆæ¯æ ¼å¼ï¼ˆæ¶ˆæ¯æ ‡é¢˜æ ¼å¼å’Œæ¶ˆæ¯å†…å®¹æ ¼å¼ï¼‰ï¼Œè¿™äº›æ¶ˆæ¯æ ¼å¼æ²¡æœ‰è§„å¾‹å¯å¾ªï¼Œåªæœ‰å…·ä½“çš„æ¶ˆæ¯å‘é€å™¨æ‰çŸ¥é“ï¼Œæ‰€ä»¥æ¶ˆæ¯å‘é€ç®—æ³•ä¸­çš„ç¬¬ 1 ä¸ªå’Œç¬¬ 2 ä¸ªæ­¥éª¤éœ€è¦å®šä¹‰æˆæŠ½è±¡çš„ï¼Œç„¶åç”±æ¯ä¸ªå…·ä½“çš„æ¶ˆæ¯å‘é€å™¨æ¥åˆ¶å®šæ¶ˆæ¯æ¨¡ç‰ˆã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;æ¬¢è¿æ¥åˆ°å°è¯´ç²¾å“å±‹&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    æ„Ÿè°¢ä½ æ³¨å†Œå°è¯´ç²¾å“å±‹ï¼ä½ çš„è´¦æˆ·ç°åœ¨å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”µå­é‚®ä»¶ï¼š{}
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”¨æˆ·åï¼š{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        ç™»å½•æˆ‘ä»¬çš„ç½‘ç«™
                    &lt;/a&gt;
                &lt;/div&gt;
                
                å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ {} ä¸æˆ‘ä»¬è”ç³»ã€‚
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹äºç›¸åŒç±»å‹å’Œç›¸åŒå‘é€æ—¶æœºçš„æ¶ˆæ¯æ¥è¯´ï¼Œè™½ç„¶æ¶ˆæ¯æ ‡é¢˜å’Œæ¶ˆæ¯å†…å®¹çš„æ ¼å¼ç›¸åŒï¼Œä½†æ˜¯æ–‡æœ¬å†…å®¹å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¬¬ 3 æ­¥å°†æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆè§£ææˆæœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯æ ‡é¢˜å’Œç¬¬ 4 æ­¥å°†æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆè§£ææˆæœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹æ‰èƒ½æ‰§è¡ŒçœŸæ­£æ¶ˆæ¯å‘é€çš„é€»è¾‘ã€‚</p> <p>è™½ç„¶å¦‚æ­¤ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æ¶ˆæ¯æ ‡é¢˜çš„å†…å®¹å¤§éƒ¨åˆ†éƒ½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åœ¨æŠ½è±¡çš„æ¶ˆæ¯å‘é€å™¨ <code>AbstractMessageSender</code>ä¸­ä¼šå®ç°ä¸€ä¸ªé»˜è®¤çš„æ¶ˆæ¯æ ‡é¢˜è§£æé€»è¾‘ï¼šç›´æ¥è¿”å›æ¶ˆæ¯æ¨¡ç‰ˆå†…å®¹ï¼Œä¸åšä»»ä½•è§£æï¼›æ¶ˆæ¯å†…å®¹å¤§éƒ¨åˆ†è™½ç„¶æ˜¯åŠ¨æ€çš„ï¼Œä½†ä¹Ÿæ˜¯æœ‰è§„å¾‹å¯å¾ªçš„ï¼Œæ‰€ä»¥åœ¨æŠ½è±¡çš„æ¶ˆæ¯å‘é€å™¨ <code>AbstractMessageSender</code>ä¸­ä¼šå®ç°ä¸€ä¸ªå¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚çš„æ¶ˆæ¯å†…å®¹è§£æé€»è¾‘ï¼šç›´æ¥ä½¿ç”¨åŠ¨æ€å‚æ•°åˆ—è¡¨æ›¿æ¢æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆä¸­çš„å ä½ç¬¦ã€‚ç‰¹å®šçš„æ¶ˆæ¯å‘é€å™¨å¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆå’Œæ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆçš„è§£æé€»è¾‘ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * é€šè¿‡ç»™å®šçš„å‚æ•°åˆ—è¡¨è§£ææ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆï¼Œé»˜è®¤å›ºå®šæ ‡é¢˜ï¼Œä¸éœ€è¦è§£æï¼Œå¯ä»¥ç”±å­ç±»æ¥æ‹“å±•å®ƒçš„åŠŸèƒ½
     *
     * @param titleTemplate æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆ
     * @param arguments     ç”¨æ¥è§£æçš„å‚æ•°åˆ—è¡¨
     * @return è§£æåçš„æ¶ˆæ¯æ ‡é¢˜
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> titleTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> titleTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é€šè¿‡ç»™å®šçš„å‚æ•°åˆ—è¡¨è§£ææ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆï¼Œé»˜è®¤å®ç°æ˜¯ä½¿ç”¨å‚æ•°åˆ—è¡¨æ¥æ›¿æ¢æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆä¸­çš„å ä½ç¬¦ï¼Œå¯ä»¥ç”±å­ç±»æ¥æ‹“å±•å®ƒçš„åŠŸèƒ½
     * &lt;p&gt;
     * å­ç±»å¯ä»¥æ ¹æ®ç¬¬ä¸€ä¸ª/å‰å‡ ä¸ªå‚æ•°å»æ•°æ®åº“ä¸­æŸ¥è¯¢åŠ¨æ€å†…å®¹ï¼Œç„¶åé‡ç»„å‚æ•°åˆ—è¡¨
     *
     * @param contentTemplate æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆ
     * @param args            ç”¨æ¥è§£æçš„å‚æ•°åˆ—è¡¨
     * @return è§£æåçš„æ¶ˆæ¯å†…å®¹
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> contentTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> formattedContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> start <span class="token operator">=</span> formattedContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                formattedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token constant">PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> formattedContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> contentTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;æ¬¢è¿æ¥åˆ°å°è¯´ç²¾å“å±‹&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    æ„Ÿè°¢ä½ æ³¨å†Œå°è¯´ç²¾å“å±‹ï¼ä½ çš„è´¦æˆ·ç°åœ¨å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”µå­é‚®ä»¶ï¼š{}
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”¨æˆ·åï¼š{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        ç™»å½•æˆ‘ä»¬çš„ç½‘ç«™
                    &lt;/a&gt;
                &lt;/div&gt;
                
                å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ {} ä¸æˆ‘ä»¬è”ç³»ã€‚
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO å»æ•°æ®åº“/é…ç½®æ–‡ä»¶ä¸­æŸ¥è¯¢ç½‘ç«™é…ç½®</span>
        <span class="token class-name">String</span> websiteLink <span class="token operator">=</span> <span class="token string">&quot;https://www.xxyopen.com&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> websiteEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span>
            <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>websiteLink<span class="token punctuation">,</span> websiteEmail<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœéœ€æ±‚å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªæ¶ˆæ¯ç±»å‹ï¼Œæˆ–è€…æ–°å¢ä¸€ä¸ªéœ€è¦å‘é€æ¶ˆæ¯çš„äº‹ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºç›¸åº”çš„æ¶ˆæ¯å‘é€å™¨ï¼Œä¸éœ€è¦ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œè€Œä¸”æ–°åˆ›å»ºçš„æ¶ˆæ¯å‘é€å™¨å¯ä»¥åšåˆ°åªæä¾›æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆå’Œæ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆå³å¯æ­£å¸¸å·¥ä½œçš„ç¨‹åº¦ã€‚å¤§å¤§æé«˜äº†ç¨‹åºçš„å¯æ‹“å±•æ€§å’Œä»£ç æœ€å¤§ç¨‹åº¦çš„å¤ç”¨ã€‚</p> <h3 id="å®ç°æ­¥éª¤-2"><a href="#å®ç°æ­¥éª¤-2" class="header-anchor">#</a> å®ç°æ­¥éª¤</h3> <ol><li>åˆ›å»ºæ¶ˆæ¯å‘é€å™¨æ¥å£ <code>MessageSender</code>ï¼Œå®šä¹‰æ¶ˆæ¯å‘é€çš„æ¨¡ç‰ˆæ–¹æ³•ã€‚</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æ¶ˆæ¯å‘é€å™¨æ¥å£ï¼Œç”¨æ¥å‘é€å„ç§æ¶ˆæ¯
 * &lt;p&gt;
 * æ¶ˆæ¯æŒ‰ç±»å‹åˆ†ç³»ç»Ÿé€šçŸ¥ã€é‚®ä»¶ã€çŸ­ä¿¡ã€å°ç¨‹åºé€šçŸ¥ç­‰ï¼ŒæŒ‰å‘é€æ—¶æœºåˆ†æ³¨å†ŒæˆåŠŸæ¶ˆæ¯ã€å……å€¼æˆåŠŸæ¶ˆæ¯ã€æ´»åŠ¨é€šçŸ¥æ¶ˆæ¯ã€è´¦æˆ·å°ç¦æ¶ˆæ¯ã€å°è¯´ä¸‹æ¶æ¶ˆæ¯ç­‰
 *
 * @author xiongxiaoyang
 * @date 2023/3/25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å‘é€æ¶ˆæ¯ï¼Œæ”¯æŒåŠ¨æ€æ¶ˆæ¯æ ‡é¢˜å’ŒåŠ¨æ€æ¶ˆæ¯å†…å®¹
     *
     * @param toUserId æ¶ˆæ¯æ¥æ”¶æ–¹çš„ç”¨æˆ·ID
     * @param args     ç”¨æ¥åŠ¨æ€ç”Ÿæˆæ¶ˆæ¯æ ‡é¢˜å’Œæ¶ˆæ¯å†…å®¹çš„å‚æ•°åˆ—è¡¨
     */</span>
    <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>åˆ›å»ºæŠ½è±¡çš„æ¶ˆæ¯å‘é€å™¨ <code>AbstractMessageSender</code>ï¼Œå®ç°æ¶ˆæ¯å‘é€çš„ç®—æ³•ã€‚</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æŠ½è±¡çš„æ¶ˆæ¯å‘é€å™¨
 * &lt;p&gt;
 * éµå¾ªæ¾è€¦åˆçš„è®¾è®¡åŸåˆ™ï¼Œæ‰€æœ‰çš„å±æ€§éƒ½ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ï¼Œä¸ Spring æ¡†æ¶è§£è—•
 * &lt;p&gt;
 * æ‰€æœ‰çš„æ¶ˆæ¯å‘é€å™¨æ—¢å¯ä»¥æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ï¼Œä½œä¸º Spring çš„ä¸€ä¸ªç»„ä»¶ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ new å¯¹è±¡çš„æ–¹å¼ä½¿ç”¨
 * &lt;p&gt;
 * æ¯ç§ç±»å‹çš„æ¶ˆæ¯å‘é€æ—¶æœºå¯èƒ½éƒ½ä¸ä¸€æ ·ï¼Œä¸åŒç±»å‹å’Œå‘é€æ—¶æœºçš„æ¶ˆæ¯æ ¼å¼å¯èƒ½ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç”±å„ä¸ªå­ç±»å»æ‹“å±•æ¶ˆæ¯çš„æ ¼å¼
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PLACEHOLDER</span> <span class="token operator">=</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * å®šä¹‰æ¶ˆæ¯å‘é€çš„æ¨¡ç‰ˆï¼Œå­ç±»ä¸èƒ½ä¿®æ”¹æ­¤æ¨¡ç‰ˆ
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.è·å–æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆ</span>
        <span class="token class-name">String</span> titleTemplate <span class="token operator">=</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.è·å–æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆ</span>
        <span class="token class-name">String</span> contentTemplate <span class="token operator">=</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.è§£ææ¶ˆæ¯æ¨¡ç‰ˆï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯æ ‡é¢˜</span>
        <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span>titleTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.è§£ææ¶ˆæ¯å†…å®¹ï¼Œå¾—åˆ°æœ€ç»ˆéœ€è¦å‘é€çš„æ¶ˆæ¯å†…å®¹</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.å‘é€æ¶ˆæ¯</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>toUserId<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å‘é€æ¶ˆæ¯ï¼Œå…·ä½“å‘é€åˆ°å“ªé‡Œç”±å­ç±»å†³å®š
     *
     * @param toUserId       æ¶ˆæ¯æ¥æ”¶æ–¹çš„ç”¨æˆ·ID
     * @param messageTitle   æ¶ˆæ¯æ ‡é¢˜
     * @param messageContent æ¶ˆæ¯å†…å®¹
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * è·å–æ¶ˆæ¯æ ‡é¢˜çš„æ¨¡ç‰ˆï¼Œå…·ä½“å¦‚ä½•åˆ¶å®šæ¨¡ç‰ˆç”±å­ç±»å†³å®š
     *
     * @return æ¶ˆæ¯æ ‡é¢˜
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * è·å–æ¶ˆæ¯å†…å®¹çš„æ¨¡ç‰ˆï¼Œå…·ä½“å¦‚ä½•åˆ¶å®šæ¨¡ç‰ˆç”±å­ç±»å†³å®š
     *
     * @return æ¶ˆæ¯å†…å®¹
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * é€šè¿‡ç»™å®šçš„å‚æ•°åˆ—è¡¨è§£ææ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆï¼Œé»˜è®¤å›ºå®šæ ‡é¢˜ï¼Œä¸éœ€è¦è§£æï¼Œå¯ä»¥ç”±å­ç±»æ¥æ‹“å±•å®ƒçš„åŠŸèƒ½
     *
     * @param titleTemplate æ¶ˆæ¯æ ‡é¢˜æ¨¡ç‰ˆ
     * @param arguments     ç”¨æ¥è§£æçš„å‚æ•°åˆ—è¡¨
     * @return è§£æåçš„æ¶ˆæ¯æ ‡é¢˜
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> titleTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> titleTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é€šè¿‡ç»™å®šçš„å‚æ•°åˆ—è¡¨è§£ææ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆï¼Œé»˜è®¤å®ç°æ˜¯ä½¿ç”¨å‚æ•°åˆ—è¡¨æ¥æ›¿æ¢æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆä¸­çš„å ä½ç¬¦ï¼Œå¯ä»¥ç”±å­ç±»æ¥æ‹“å±•å®ƒçš„åŠŸèƒ½
     * &lt;p&gt;
     * å­ç±»å¯ä»¥æ ¹æ®ç¬¬ä¸€ä¸ª/å‰å‡ ä¸ªå‚æ•°å»æ•°æ®åº“ä¸­æŸ¥è¯¢åŠ¨æ€å†…å®¹ï¼Œç„¶åé‡ç»„å‚æ•°åˆ—è¡¨
     *
     * @param contentTemplate æ¶ˆæ¯å†…å®¹æ¨¡ç‰ˆ
     * @param args            ç”¨æ¥è§£æçš„å‚æ•°åˆ—è¡¨
     * @return è§£æåçš„æ¶ˆæ¯å†…å®¹
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> contentTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> formattedContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> start <span class="token operator">=</span> formattedContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                formattedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token constant">PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> formattedContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> contentTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>åˆ›å»ºæŠ½è±¡çš„é‚®ä»¶å‘é€å™¨ <code>AbstractMailSender</code> å’Œç³»ç»Ÿé€šçŸ¥å‘é€å™¨ <code>AbstractSysNoticeSender</code>ï¼Œåˆ†åˆ«å‘é€é‚®ä»¶å’Œç³»ç»Ÿé€šçŸ¥ã€‚</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æŠ½è±¡çš„é‚®ä»¶æ¶ˆæ¯å‘é€è€…
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MailProperties</span> mailProperties<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JavaMailSender</span> mailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO æ ¹æ®æ¶ˆæ¯æ¥æ”¶æ–¹çš„ç”¨æˆ·IDæŸ¥è¯¢å‡ºæ¶ˆæ¯æ¥æ”¶æ–¹çš„é‚®ä»¶åœ°å€</span>
        <span class="token class-name">String</span> toEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// å¼€å§‹å‘é€é‚®ä»¶</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶å¼€å§‹ï¼š{},{},{}&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä½¿ç”¨ MimeMessageï¼ŒMIME åè®®</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> helper<span class="token punctuation">;</span>
        <span class="token comment">// MimeMessageHelper å¸®åŠ©æˆ‘ä»¬è®¾ç½®æ›´ä¸°å¯Œçš„å†…å®¹</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mailProperties<span class="token punctuation">.</span><span class="token function">nickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>messageTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç¬¬äºŒä¸ªå‚æ•° true ä»£è¡¨æ”¯æŒ html</span>
            helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>messageContent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶ to {} æˆåŠŸ&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‚®ä»¶å‘é€å¤±è´¥ä¸ä¼šé‡è¯•</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€ HTML é‚®ä»¶ to {} å¤±è´¥&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æŠ½è±¡çš„ç³»ç»Ÿé€šçŸ¥å‘é€è€…
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSysNoticeSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”Ÿæˆæ¶ˆæ¯çš„å‘é€æ—¶é—´</span>
        <span class="token class-name">LocalDateTime</span> messageDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO åœ¨æ•°æ®åº“ç³»ç»Ÿé€šçŸ¥è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç³»ç»Ÿé€šçŸ¥å‘é€æˆåŠŸï¼Œ{},{},{},{}&quot;</span><span class="token punctuation">,</span> toUserId<span class="token punctuation">,</span> messageDateTime<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token constant">ISO_DATE_TIME</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>åˆ›å»ºæ³¨å†ŒæˆåŠŸçš„é‚®ä»¶å‘é€å™¨ <code>RegisterMailSender</code> å’Œç§’æ€æ´»åŠ¨çš„ç³»ç»Ÿé€šçŸ¥å‘é€å™¨ <code>SeckillSystemNoticeSender</code>ã€‚</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æ³¨å†ŒæˆåŠŸçš„é‚®ä»¶å‘é€å™¨
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">REGISTER_MAIL_SENDER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">MailProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">RegisterMailSender</span><span class="token punctuation">(</span><span class="token class-name">MailProperties</span> mailProperties<span class="token punctuation">,</span> <span class="token class-name">JavaMailSender</span> mailSender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">,</span> mailSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;æ¬¢è¿æ¥åˆ°å°è¯´ç²¾å“å±‹&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    æ„Ÿè°¢ä½ æ³¨å†Œå°è¯´ç²¾å“å±‹ï¼ä½ çš„è´¦æˆ·ç°åœ¨å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”µå­é‚®ä»¶ï¼š{}
                    &lt;li&gt; ä½ çš„è´¦æˆ·ç”¨æˆ·åï¼š{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        ç™»å½•æˆ‘ä»¬çš„ç½‘ç«™
                    &lt;/a&gt;
                &lt;/div&gt;
                
                å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ {} ä¸æˆ‘ä»¬è”ç³»ã€‚
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO å»æ•°æ®åº“/é…ç½®æ–‡ä»¶ä¸­æŸ¥è¯¢ç½‘ç«™é…ç½®</span>
        <span class="token class-name">String</span> websiteLink <span class="token operator">=</span> <span class="token string">&quot;https://www.xxyopen.com&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> websiteEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span>
            <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>websiteLink<span class="token punctuation">,</span> websiteEmail<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * ç§’æ€æ´»åŠ¨çš„ç³»ç»Ÿé€šçŸ¥å‘é€å™¨
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">SECKILL_SYS_NOTICE_SENDER</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSystemNoticeSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSysNoticeSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ç§’æ€å³å°†å¼€å§‹&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;{}ç§’æ€ï¼Œ{}å³å°†å¼€å§‹ï¼Œä¸è¦é”™è¿‡å“¦ï¼ç‚¹å‡» {} å‰å¾€ã€‚&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>æ¶ˆæ¯å‘é€æµ‹è¯•</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">NovelApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageSenderTest</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractMessageSender</span><span class="token punctuation">&gt;</span></span> messageSenders<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> test<span class="token punctuation">{</span>
        <span class="token class-name">MessageSender</span> registerMailSender <span class="token operator">=</span> messageSenders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
            <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">REGISTER_MAIL_SENDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>registerMailSender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registerMailSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token number">11111L</span><span class="token punctuation">,</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xxyopen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">MessageSender</span> seckillSysNoticeSender <span class="token operator">=</span> messageSenders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
            <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">SECKILL_SYS_NOTICE_SENDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>registerMailSender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            seckillSysNoticeSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token number">11111L</span><span class="token punctuation">,</span> <span class="token string">&quot;å…¨åœºå•†å“&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ä»Šæ™š 9 ç‚¹&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;www.xxyopen.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä¸€è¡Œä»£ç è§£å†³-json-å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»"><a href="#ä¸€è¡Œä»£ç è§£å†³-json-å½¢å¼ä¼ å‚çš„-xss-æ”»å‡»" class="header-anchor">#</a> ä¸€è¡Œä»£ç è§£å†³ JSON å½¢å¼ä¼ å‚çš„ XSS æ”»å‡»</h2> <h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="header-anchor">#</a> é—®é¢˜</h3> <p>å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œå¯¹äº POST å’Œ PUT ç±»å‹çš„è¯·æ±‚æ–¹æ³•ï¼Œåç«¯åŸºæœ¬éƒ½æ˜¯é€šè¿‡ @RequestBody æ³¨è§£æ¥æ”¶ application/json æ ¼å¼çš„è¯·æ±‚æ•°æ®ï¼Œæ‰€ä»¥ä»¥å‰é€šè¿‡è¿‡æ»¤å™¨ + è£…é¥°å™¨ HttpServletRequestWrapper æ¥è§£å†³ XSS æ”»å‡»çš„æ–¹å¼å¹¶ä¸é€‚ç”¨ã€‚åœ¨ Spring Boot ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å…¨å±€çš„ Json ååºåˆ—åŒ–å™¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦æ¥è§£å†³ XSS æ”»å‡»ã€‚</p> <h3 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="header-anchor">#</a> å®ç°ä»£ç </h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * JSON å…¨å±€ååºåˆ—åŒ–å™¨
 *
 * @author xiongxiaoyang
 * @date 2022/5/21
 */</span>
<span class="token annotation punctuation">@JsonComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalJsonDeserializer</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å­—ç¬¦ä¸²ååºåˆ—åŒ–å™¨
     * è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ï¼Œè§£å†³ XSS æ”»å‡»
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StringDeserializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">JsonParser</span> jsonParser<span class="token punctuation">,</span> <span class="token class-name">DeserializationContext</span> deserializationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">JacksonException</span> <span class="token punctuation">{</span>
		<span class="token comment">// å®é™…ä»£ç å°±è¿™ä¸€è¡Œ</span>
            <span class="token keyword">return</span> jsonParser<span class="token punctuation">.</span><span class="token function">getValueAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;lt;&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="é›†æˆ-elasticsearch-8-å®ç°æœç´¢å¼•æ“åŠ¨æ€åˆ‡æ¢"><a href="#é›†æˆ-elasticsearch-8-å®ç°æœç´¢å¼•æ“åŠ¨æ€åˆ‡æ¢" class="header-anchor">#</a> é›†æˆ Elasticsearch 8ï¼Œå®ç°æœç´¢å¼•æ“åŠ¨æ€åˆ‡æ¢</h2> <ol><li><p><a href="/course/novel/4.html#æœç´¢å¼•æ“-elasticsearch-é›†æˆä¸é…ç½®">Elasticsearch é›†æˆä¸é…ç½®</a></p></li> <li><p>åœ¨ application.yml ä¸­å¢åŠ  <code>spring.elasticsearch.enable</code> é…ç½®é¡¹ç”¨æ¥æ§åˆ¶ Elasticsearch æœç´¢å¼•æ“åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼š</p></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token comment"># æ˜¯å¦å¼€å¯ elasticsearch æœç´¢å¼•æ“åŠŸèƒ½ï¼štrue-å¼€å¯ false-ä¸å¼€å¯</span>
    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><ol start="3"><li>æ–°å»ºæœç´¢æœåŠ¡ç±»ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æœç´¢ æœåŠ¡ç±»
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å°è¯´æœç´¢
     *
     * @param condition æœç´¢æ¡ä»¶
     * @return æœç´¢ç»“æœ
     */</span>
    <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>æ–°å»º<code>æ•°æ®åº“æœç´¢</code>æœåŠ¡å®ç°ç±»ï¼Œå®ç°ä»æ•°æ®åº“ä¸­æ£€ç´¢å°è¯´çš„ä¸šåŠ¡é€»è¾‘ï¼Œç”±é…ç½®é¡¹<code>spring.elasticsearch.enable</code>æ§åˆ¶å½“ elasticsearch å…³é—­æ—¶ç”Ÿæ•ˆï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æ•°æ®åº“æœç´¢ æœåŠ¡å®ç°ç±»
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> bookInfos <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">searchBooks</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">PageRespDto</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> bookInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token class-name">BookInfoRespDto</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bookName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">categoryId</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">categoryName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCategoryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">authorId</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getAuthorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">authorName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getAuthorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">wordCount</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">lastChapterName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getLastChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>æ–°å»º<code>Elasticsearch æœç´¢å¼•æ“æœç´¢</code>æœåŠ¡å®ç°ç±»ï¼Œå®ç°ä» Elasticsearch ä¸­æ£€ç´¢å°è¯´çš„ä¸šåŠ¡é€»è¾‘ï¼Œç”±é…ç½®é¡¹<code>spring.elasticsearch.enable</code>æ§åˆ¶å½“ elasticsearch å¼€å¯æ—¶ç”Ÿæ•ˆï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Elasticsearch æœç´¢ æœåŠ¡å®ç°ç±»
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> esClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

                    <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span> searchBuilder <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>IndexEnum</span><span class="token punctuation">.</span><span class="token constant">BOOK</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">buildSearchCondition</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> searchBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æ’åº</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        searchBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span>
                                o<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span>
                                                <span class="token punctuation">.</span><span class="token function">underlineToCamel</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// åˆ†é¡µ</span>
                    searchBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> searchBuilder<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TotalHits</span> total <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span></span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">EsBookDto</span> book <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> book <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bookName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">categoryId</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">categoryName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getCategoryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">authorId</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getAuthorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">authorName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getAuthorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">wordCount</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">lastChapterName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getLastChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">assert</span> total <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">PageRespDto</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * æ„å»ºæŸ¥è¯¢æ¡ä»¶
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildSearchCondition</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">,</span> <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span> searchBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">BoolQuery</span> boolQuery <span class="token operator">=</span> <span class="token class-name">BoolQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å…³é”®è¯åŒ¹é…</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">multiMatch</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t
                        <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token string">&quot;bookName^2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;authorName^1.8&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;bookDesc^0.1&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ç²¾ç¡®æŸ¥è¯¢</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWorkDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">TermQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;workDirection&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWorkDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">TermQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;categoryId&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// èŒƒå›´æŸ¥è¯¢</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;wordCount&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;wordCount&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getUpdateTimeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;lastChapterUpdateTime&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getUpdateTimeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> b<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li><code>BookController</code> ä¸­æ³¨å…¥ <code>SearchService</code> beanï¼Œè°ƒç”¨<code>searchBooks</code>æ–¹æ³•å®ç°æŒ‰é…ç½®åŠ¨æ€åˆ‡æ¢æœç´¢å¼•æ“çš„åŠŸèƒ½ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SearchService</span> searchService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * å°è¯´æœç´¢æ¥å£
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;search_list&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> searchService<span class="token punctuation">.</span><span class="token function">searchBooks</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä½¿ç”¨-rabbitmq-åˆ·æ–°-es-redis-caffeine-ç­‰å°è¯´å‰¯æœ¬æ•°æ®"><a href="#ä½¿ç”¨-rabbitmq-åˆ·æ–°-es-redis-caffeine-ç­‰å°è¯´å‰¯æœ¬æ•°æ®" class="header-anchor">#</a> ä½¿ç”¨ RabbitMQ åˆ·æ–° ES/Redis/Caffeine ç­‰å°è¯´å‰¯æœ¬æ•°æ®</h2> <p>åœ¨ novel åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæ•°æ®åº“ä¸­çš„å°è¯´ä¿¡æ¯å¯èƒ½ä¼šåœ¨å¤šä¸ªåœ°æ–¹ä¿å­˜ä¸€ä»½å‰¯æœ¬æ•°æ®ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†å‡è½»æ•°æ®åº“å‹åŠ›ï¼Œæé«˜å¹¶å‘å’Œç³»ç»Ÿæ€§èƒ½çš„æœ¬åœ°ç¼“å­˜ Caffeine å’Œåˆ†å¸ƒå¼ç¼“å­˜ Redisã€ä¸ºäº†å®ç°å°è¯´å…¨æ–‡é«˜çº§æ£€ç´¢çš„ Elasticsearch æœç´¢å¼•æ“ç­‰ã€‚æœ‰æ—¶ä¸ºäº†åº”å¯¹å°è¯´è¯¦æƒ…é¡µçš„é«˜å¹¶å‘è®¿é—®å’Œ SEO ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿˜ä¼šé€‰æ‹©ä¸ºæ¯ä¸€æœ¬å°è¯´ç”Ÿæˆé™æ€åŒ–çš„é¡µé¢ï¼Œé€šè¿‡ Nginx æˆ– CDN æ¥è®¿é—®ã€‚</p> <p>æ­¤æ—¶ï¼Œå¦‚æœå°è¯´ä¿¡æ¯å‘ç”Ÿå˜æ›´ï¼Œé‚£ä¹ˆå¦‚ä½•é€šçŸ¥æ‰€æœ‰çš„å‰¯æœ¬æ•°æ®å’Œé™æ€é¡µé¢æ›´æ–°å‘¢ï¼Ÿå¦‚æœéšç€ä¸šåŠ¡çš„å‘å±•å’Œç³»ç»Ÿçš„æ¼”è¿›ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ MongoDB ä¸­å¢åŠ ä¸€ä»½å­˜å‚¨å‰¯æœ¬ï¼Œé‚£ä¹ˆæ€ä¹ˆåœ¨ä¸ä¿®æ”¹è°ƒç”¨æ–¹ï¼ˆæ‰€æœ‰å°è¯´ä¿¡æ¯å‘ç”Ÿå˜æ›´çš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼Œä½œå®¶æ›´æ–°å°è¯´ä¿¡æ¯ã€ä½œå®¶å‘å¸ƒæ–°çš„ç« èŠ‚æˆ–å¹³å°ä¸‹æ¶è¿è§„å°è¯´ç­‰åœºæ™¯ï¼‰ä»£ç ï¼Œä¸å½±å“åŸå…ˆåŠŸèƒ½ï¼ˆå…¶å®ƒå‰¯æœ¬æ•°æ®çš„åˆ·æ–°ï¼‰çš„åŒæ—¶ï¼Œåˆèƒ½åŠæ—¶åˆ·æ–° MongoDB ä¸­çš„å‰¯æœ¬æ•°æ®ï¼Œå®ç°æ¨¡å—é—´çš„è§£è€¦å‘¢ï¼Ÿ</p> <p>æˆ‘ä»¬é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œå®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p> <ol><li><p><a href="/course/novel/4.html#spring-amqp-é›†æˆä¸é…ç½®">Spring AMQP é›†æˆä¸é…ç½®</a></p></li> <li><p>åœ¨<code>io.github.xxyopen.novel.core.constant</code>åŒ…ä¸‹åˆ›å»º AMQP ç›¸å…³å¸¸é‡ç±»ï¼š</p></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP ç›¸å…³å¸¸é‡
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpConsts</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å°è¯´ä¿¡æ¯æ”¹å˜ MQ
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BookChangeMq</span><span class="token punctuation">{</span>

        <span class="token comment">/**
         * å°è¯´ä¿¡æ¯æ”¹å˜äº¤æ¢æœº
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;EXCHANGE-BOOK-CHANGE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Elasticsearch book ç´¢å¼•æ›´æ–°çš„é˜Ÿåˆ—
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_ES_UPDATE</span> <span class="token operator">=</span> <span class="token string">&quot;QUEUE-ES-BOOK-UPDATE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Redis book ç¼“å­˜æ›´æ–°çš„é˜Ÿåˆ—
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_REDIS_UPDATE</span> <span class="token operator">=</span> <span class="token string">&quot;QUEUE-REDIS-BOOK-UPDATE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// ... å…¶å®ƒçš„æ›´æ–°é˜Ÿåˆ—</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>åœ¨<code>io.github.xxyopen.novel.core.config</code>åŒ…ä¸‹åˆ›å»º AMQP é…ç½®ç±»ï¼Œé…ç½®å„ä¸ªäº¤æ¢æœºã€é˜Ÿåˆ—ä»¥åŠç»‘å®šå…³ç³»ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP é…ç½®ç±»
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å°è¯´ä¿¡æ¯æ”¹å˜äº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">bookChangeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Elasticsearch book ç´¢å¼•æ›´æ–°é˜Ÿåˆ—
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">esBookUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ES_UPDATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Elasticsearch book ç´¢å¼•æ›´æ–°é˜Ÿåˆ—ç»‘å®šåˆ°å°è¯´ä¿¡æ¯æ”¹å˜äº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">esBookUpdateQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">esBookUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">bookChangeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... å…¶å®ƒçš„æ›´æ–°é˜Ÿåˆ—ä»¥åŠç»‘å®šå…³ç³»</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>åœ¨<code>io.github.xxyopen.novel.manager.mq</code>åŒ…ä¸‹åˆ›å»º AMQP æ¶ˆæ¯ç®¡ç†ç±»ï¼Œç”¨æ¥å‘é€å„ç§ AMQP æ¶ˆæ¯ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP æ¶ˆæ¯ç®¡ç†ç±»
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpMsgManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AmqpTemplate</span> amqpTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.amqp.enable}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> enableAmqp<span class="token punctuation">;</span>

    <span class="token comment">/**
     * å‘é€å°è¯´ä¿¡æ¯æ”¹å˜æ¶ˆæ¯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBookChangeMsg</span><span class="token punctuation">(</span><span class="token class-name">Long</span> bookId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>enableAmqp<span class="token punctuation">,</span> <span class="token class-name">CommonConsts</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sendAmqpMessage</span><span class="token punctuation">(</span>amqpTemplate<span class="token punctuation">,</span> <span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendAmqpMessage</span><span class="token punctuation">(</span><span class="token class-name">AmqpTemplate</span> amqpTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœåœ¨äº‹åŠ¡ä¸­åˆ™åœ¨äº‹åŠ¡æ‰§è¡Œå®Œæˆåå†å‘é€ï¼Œå¦åˆ™å¯ä»¥ç›´æ¥å‘é€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>åœ¨å°è¯´ä¿¡æ¯æ›´æ–°åï¼Œå‘é€ AMQP æ¶ˆæ¯ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveBookChapter</span><span class="token punctuation">(</span><span class="token class-name">ChapterAddReqDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1) ä¿å­˜ç« èŠ‚ç›¸å…³ä¿¡æ¯åˆ°å°è¯´ç« èŠ‚è¡¨</span>
    <span class="token comment">//  a) æŸ¥è¯¢æœ€æ–°ç« èŠ‚å·</span>
    <span class="token keyword">int</span> chapterNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookChapter</span><span class="token punctuation">&gt;</span></span> chapterQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chapterQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>BookChapterTable</span><span class="token punctuation">.</span><span class="token constant">COLUMN_BOOK_ID</span><span class="token punctuation">,</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>BookChapterTable</span><span class="token punctuation">.</span><span class="token constant">COLUMN_CHAPTER_NUM</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>SqlEnum</span><span class="token punctuation">.</span><span class="token constant">LIMIT_1</span><span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BookChapter</span> bookChapter <span class="token operator">=</span> bookChapterMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>chapterQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>bookChapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        chapterNum <span class="token operator">=</span> bookChapter<span class="token punctuation">.</span><span class="token function">getChapterNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  b) è®¾ç½®ç« èŠ‚ç›¸å…³ä¿¡æ¯å¹¶ä¿å­˜</span>
    <span class="token class-name">BookChapter</span> newBookChapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookChapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setBookId</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setChapterName</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setChapterNum</span><span class="token punctuation">(</span>chapterNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setWordCount</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setIsVip</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getIsVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookChapterMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2) ä¿å­˜ç« èŠ‚å†…å®¹åˆ°å°è¯´å†…å®¹è¡¨</span>
    <span class="token class-name">BookContent</span> bookContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setChapterId</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContentMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>bookContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3) æ›´æ–°å°è¯´è¡¨æœ€æ–°ç« èŠ‚ä¿¡æ¯å’Œå°è¯´æ€»å­—æ•°ä¿¡æ¯</span>
    <span class="token comment">//  a) æ›´æ–°å°è¯´è¡¨å…³äºæœ€æ–°ç« èŠ‚çš„ä¿¡æ¯</span>
    <span class="token class-name">BookInfoRespDto</span> bookInfo <span class="token operator">=</span> bookInfoCacheManager<span class="token punctuation">.</span><span class="token function">getBookInfo</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BookInfo</span> newBookInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterId</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterName</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setWordCount</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> newBookChapter<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookInfoMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>newBookInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  b) åˆ·æ–°å°è¯´ä¿¡æ¯ç¼“å­˜</span>
    bookInfoCacheManager<span class="token punctuation">.</span><span class="token function">cachePutBookInfo</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  c) å‘é€å°è¯´ä¿¡æ¯æ›´æ–°çš„ MQ æ¶ˆæ¯</span>
    amqpMsgManager<span class="token punctuation">.</span><span class="token function">sendBookChangeMsg</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>åœ¨<code>io.github.xxyopen.novel.core.listener</code>åŒ…ä¸‹åˆ›å»º Rabbit é˜Ÿåˆ—ç›‘å¬å™¨ï¼Œç›‘å¬å„ä¸ª RabbitMQ é˜Ÿåˆ—çš„æ¶ˆæ¯å¹¶å¤„ç†ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Rabbit é˜Ÿåˆ—ç›‘å¬å™¨
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitQueueListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> esClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç›‘å¬å°è¯´ä¿¡æ¯æ”¹å˜çš„ ES æ›´æ–°é˜Ÿåˆ—ï¼Œæ›´æ–°æœ€æ–°å°è¯´ä¿¡æ¯åˆ° ES
     * */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ES_UPDATE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateEsBook</span><span class="token punctuation">(</span><span class="token class-name">Long</span> bookId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BookInfo</span> bookInfo <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>BookIndex</span><span class="token punctuation">.</span><span class="token constant">INDEX_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... ç›‘å¬å…¶å®ƒé˜Ÿåˆ—ï¼Œåˆ·æ–°å…¶å®ƒå‰¯æœ¬æ•°æ®</span>

<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶ï¼Œå¦‚æœéœ€è¦æ›´æ–°å…¶å®ƒå‰¯æœ¬æ•°æ®ï¼Œåªéœ€è¦é…ç½®æ›´æ–°é˜Ÿåˆ—å’Œå¢åŠ ç›‘å¬å™¨ï¼Œä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ï¼Œè€Œä¸”ä»»æ„å‰¯æœ¬çš„æ•°æ®åˆ·æ–°äº’ä¸å½±å“ï¼ŒçœŸæ­£å®ç°äº†æ¨¡å—é—´çš„è§£è€¦ã€‚</p> <p><strong>æ³¨ï¼šå½“æœåŠ¡é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œç”±äºå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—æ˜¯æ— æ³•åŒæ—¶æ¶ˆè´¹çš„ï¼Œä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œæ‰€ä»¥åˆ·æ–°æœ¬åœ°ç¼“å­˜çš„ MQ é˜Ÿåˆ—å‘½ååº”è¯¥ä½¿ç”¨<code>å›ºå®šå + å”¯ä¸€éšæœºå€¼</code>è¿™ç§åŠ¨æ€å½¢å¼ã€‚è¿™æ ·æ¯æ¬¡å¯åŠ¨ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®è¯¥é˜Ÿåˆ—çš„ autoDelete = trueï¼Œè®©æ‰€æœ‰æ¶ˆè´¹å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨åˆ é™¤è¯¥é˜Ÿåˆ—ã€‚</strong></p> <h2 id="ä½¿ç”¨-xxl-job-ä¼˜åŒ–-elasticsearch-æ•°æ®åŒæ­¥ä»»åŠ¡"><a href="#ä½¿ç”¨-xxl-job-ä¼˜åŒ–-elasticsearch-æ•°æ®åŒæ­¥ä»»åŠ¡" class="header-anchor">#</a> ä½¿ç”¨ XXL-JOB ä¼˜åŒ– Elasticsearch æ•°æ®åŒæ­¥ä»»åŠ¡</h2> <ol><li><p><a href="/course/novel/4.html#åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°-xxl-job-é›†æˆä¸é…ç½®">XXL-JOB é›†æˆä¸é…ç½®</a></p></li> <li><p>ç™»å½•è°ƒåº¦ä¸­å¿ƒåå°ï¼Œæ–°å¢ novel é¡¹ç›®ä»»åŠ¡æ‰§è¡Œå™¨ï¼š</p></li></ol> <p><img src="/img/novel/xxljobexe.png" alt="åˆ›å»ºä»»åŠ¡æ‰§è¡Œå™¨"></p> <p><strong>æ³¨ï¼šAppName çš„å€¼éœ€è¦å’Œ novel é¡¹ç›® application.yml é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„å€¼ä¿æŒä¸€è‡´ã€‚</strong></p> <ol start="3"><li>æ–°å¢ Elasticsearch æ•°æ®åŒæ­¥ä»»åŠ¡ï¼š</li></ol> <p><img src="/img/novel/xxljobtask.png" alt="åˆ›å»ºä»»åŠ¡"></p> <ol start="4"><li>ä¿®æ”¹<code>io.github.xxyopen.novel.core.task</code>åŒ…ä¸‹çš„ Elasticsearch æ•°æ®åŒæ­¥ä»»åŠ¡ï¼ˆ<code>@Scheduled</code> æ³¨è§£ æ›¿æ¢ä¸º <code>@XxlJob</code>â€‹ æ³¨è§£ï¼‰ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * å°è¯´æ•°æ®åŒæ­¥åˆ° Elasticsearch ä»»åŠ¡
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookToEsTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> elasticsearchClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;saveToEsJobHandler&quot;</span><span class="token punctuation">)</span> <span class="token comment">// æ­¤å¤„éœ€è¦å’Œè°ƒåº¦ä¸­å¿ƒåˆ›å»ºä»»åŠ¡æ—¶å¡«å†™çš„ JobHandler å€¼ä¿æŒä¸€è‡´</span>
    <span class="token keyword">public</span> <span class="token class-name">ReturnT</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveToEs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> bookInfos<span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queryWrapper<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                queryWrapper
                        <span class="token punctuation">.</span><span class="token function">orderByAsc</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>CommonColumnEnum</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>CommonColumnEnum</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>SqlEnum</span><span class="token punctuation">.</span><span class="token constant">LIMIT_30</span><span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bookInfos <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bookInfos<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BookInfo</span> book <span class="token operator">:</span> bookInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    br<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op
                            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx
                                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>BookIndex</span><span class="token punctuation">.</span><span class="token constant">INDEX_NAME</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;10s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    maxId <span class="token operator">=</span> book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">BulkResponse</span> result <span class="token operator">=</span> elasticsearchClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Log errors, if any</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Bulk had errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BulkResponseItem</span> item <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ReturnT</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ReturnT</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><ol start="5"><li>æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå¯ä»¥å‘ç°å·²ç»æœ‰ä¸€å°æœºå™¨è‡ªåŠ¨æ³¨å†Œï¼š</li></ol> <p><img src="/img/novel/xxljobonline.png" alt="åœ¨çº¿æ³¨å†Œæœºå™¨"></p> <ol start="6"><li>è¿›å…¥ä»»åŠ¡ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ Elasticsearch æ•°æ®åŒæ­¥ä»»åŠ¡ï¼Œç”±é…ç½®çš„ Cron è¡¨è¾¾å¼è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼›ä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œï¼š</li></ol> <p><img src="/img/novel/xxljobtaskexe.png" alt="ä»»åŠ¡å¯åŠ¨"></p> <p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»æ‰‹åŠ¨åŒæ­¥æ•°æ®åº“çš„å°è¯´æ•°æ®åˆ° Elasticsearch æœç´¢å¼•æ“ä¸­ï¼Œæå¤§çš„æ–¹ä¾¿äº†æˆ‘ä»¬çš„å¼€å‘æµ‹è¯•å·¥ä½œã€‚</p> <h2 id="ä½¿ç”¨-sentinel-å®ç°æ¥å£é˜²åˆ·å’Œé™æµ"><a href="#ä½¿ç”¨-sentinel-å®ç°æ¥å£é˜²åˆ·å’Œé™æµ" class="header-anchor">#</a> ä½¿ç”¨ Sentinel å®ç°æ¥å£é˜²åˆ·å’Œé™æµ</h2> <h3 id="é—®é¢˜-2"><a href="#é—®é¢˜-2" class="header-anchor">#</a> é—®é¢˜</h3> <p>novel ä½œä¸ºä¸€ä¸ªäº’è”ç½‘ç³»ç»Ÿï¼Œç»å¸¸ä¼šé‡åˆ°éæ³•çˆ¬è™«ï¼ˆä¾‹å¦‚ï¼Œç›—ç‰ˆå°è¯´ç½‘ç«™ï¼‰æ¥çˆ¬å–æˆ‘ä»¬ç³»ç»Ÿçš„å°è¯´æ•°æ®ï¼Œè¿™ç§çˆ¬è™«è¡Œä¸ºæœ‰æ—¶ä¼šé«˜è¾¾æ¯ç§’å‡ ç™¾ç”šè‡³ä¸Šåƒæ¬¡è®¿é—®ã€‚é˜²åˆ·çš„ç›®çš„æ˜¯ä¸ºäº†é™åˆ¶è¿™äº›çˆ¬è™«è¯·æ±‚æˆ‘ä»¬æ¥å£çš„é¢‘ç‡ï¼Œå¦‚æœæˆ‘ä»¬ä¸åšæ¥å£é˜²åˆ·é™åˆ¶çš„è¯ï¼Œæˆ‘ä»¬ç³»ç»Ÿå¾ˆå®¹æ˜“å°±ä¼šè¢«çˆ¬è™«å¹²å€’ã€‚</p> <p>é™æµçš„ç›®çš„æ˜¯åœ¨æµé‡é«˜å³°æœŸé—´ï¼Œæ ¹æ®æˆ‘ä»¬ç³»ç»Ÿçš„æ‰¿å—èƒ½åŠ›ï¼Œé™åˆ¶åŒæ—¶è¯·æ±‚çš„æ•°é‡ï¼Œä¿è¯å¤šä½™çš„è¯·æ±‚ä¼šé˜»å¡ä¸€æ®µæ—¶é—´å†å¤„ç†ï¼Œä¸ç®€å•ç²—æš´çš„ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯è®©å®¢æˆ·ç«¯é‡è¯•ï¼ŒåŒæ—¶åˆèƒ½èµ·åˆ°æµé‡å‰Šå³°çš„ä½œç”¨ã€‚</p> <p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éƒ½æ˜¯å°½é‡å°†è¯·æ±‚æ‹¦æˆªåœ¨ç³»ç»Ÿä¸Šæ¸¸ï¼Œæ¯”å¦‚åœ¨åå‘ä»£ç†å±‚é€šè¿‡ Nginx + Lua + Redis æ¥å®ç°é™æµåŠŸèƒ½ï¼Œè¿™ä¸ªåœ¨åé¢éƒ¨ç½²ç¯‡ç« é‡Œé¢ä¼šè¯¦ç»†åœ°è®²è§£å¦‚ä½•å®ç°ã€‚å¦‚æœæˆ‘ä»¬ç³»ç»Ÿè¿˜æ²¡æœ‰ä½¿ç”¨ç±»ä¼¼äº Nginx ä¸€æ ·çš„åå‘ä»£ç†ï¼Œåˆæˆ–è€…æˆ‘ä»¬æƒ³å®ç°æ›´å¤æ‚çš„æµé‡æ§åˆ¶ï¼Œæƒ³è¦ä¸€ä¸ªäººæ€§åŒ–çš„æ§åˆ¶é¢æ¿æ¥åŠ¨æ€é™æµå’Œå®æ—¶ç›‘æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é˜¿é‡Œå·´å·´å¼€æºçš„é«˜å¯ç”¨æµæ§é˜²æŠ¤ç»„ä»¶ Sentinel æ¥å®ç°ã€‚</p> <h3 id="sentinel-ä»‹ç»"><a href="#sentinel-ä»‹ç»" class="header-anchor">#</a> Sentinel ä»‹ç»</h3> <p>Sentinel æ˜¯ä¸€ä¸ªé¢å‘äº‘åŸç”Ÿå¾®æœåŠ¡çš„é«˜å¯ç”¨æµæ§é˜²æŠ¤ç»„ä»¶ï¼Œä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p> <p>Sentinel æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œ<code>èµ„æº</code>å’Œ<code>è§„åˆ™</code>ï¼š</p> <p><strong>èµ„æº</strong>æ˜¯ Sentinel çš„å…³é”®æ¦‚å¿µã€‚å®ƒå¯ä»¥æ˜¯ Java åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›çš„æœåŠ¡ï¼Œæˆ–ç”±åº”ç”¨ç¨‹åºè°ƒç”¨çš„å…¶å®ƒåº”ç”¨æä¾›çš„æœåŠ¡ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚åªè¦é€šè¿‡ Sentinel API å®šä¹‰çš„ä»£ç ï¼Œå°±æ˜¯èµ„æºï¼Œèƒ½å¤Ÿè¢« Sentinel ä¿æŠ¤èµ·æ¥ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³•ç­¾åï¼ŒURLï¼Œç”šè‡³æœåŠ¡åç§°ä½œä¸ºèµ„æºåæ¥æ ‡ç¤ºèµ„æºã€‚</p> <p><strong>è§„åˆ™</strong>æ˜¯å›´ç»•èµ„æºçš„å®æ—¶çŠ¶æ€è®¾å®šçš„è§„åˆ™ï¼Œå¯ä»¥åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™ã€‚æ‰€æœ‰è§„åˆ™å¯ä»¥åŠ¨æ€å®æ—¶è°ƒæ•´ã€‚</p> <p>Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:</p> <ul><li><p>ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚</p></li> <li><p>å®Œå¤‡çš„å®æ—¶ç›‘æ§ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚</p></li> <li><p>å¹¿æ³›çš„å¼€æºç”Ÿæ€ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Apache Dubboã€gRPCã€Quarkus çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚åŒæ—¶ Sentinel æä¾› Java/Go/C++ ç­‰å¤šè¯­è¨€çš„åŸç”Ÿå®ç°ã€‚</p></li> <li><p>å®Œå–„çš„ SPI æ‰©å±•æœºåˆ¶ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚</p></li></ul> <p>Sentinel åˆ†ä¸º<code>æ ¸å¿ƒåº“</code>å’Œ<code>æ§åˆ¶å°</code>ä¸¤éƒ¨åˆ†ï¼Œ<code>æ ¸å¿ƒåº“</code>ä¸ä¾èµ–<code>æ§åˆ¶å°</code>ï¼Œä½†æ˜¯ç»“åˆ<code>æ§åˆ¶å°</code>å¯ä»¥å–å¾—æœ€å¥½çš„æ•ˆæœ:</p> <ul><li><p>æ ¸å¿ƒåº“ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“ï¼Œèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹ Dubbo / Spring Cloud ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚</p></li> <li><p>æ§åˆ¶å°ï¼ˆDashboardï¼‰åŸºäº Spring Boot å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„ Tomcat ç­‰åº”ç”¨å®¹å™¨ã€‚</p></li></ul> <h3 id="ä½¿ç”¨-sentinel-æ ¸å¿ƒåº“å®ç°æ¥å£é˜²åˆ·å’Œé™æµ"><a href="#ä½¿ç”¨-sentinel-æ ¸å¿ƒåº“å®ç°æ¥å£é˜²åˆ·å’Œé™æµ" class="header-anchor">#</a> ä½¿ç”¨ Sentinel æ ¸å¿ƒåº“å®ç°æ¥å£é˜²åˆ·å’Œé™æµ</h3> <ol><li>å¼•å…¥ Sentinel ç›¸å…³ä¾èµ–ï¼š</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sentinel.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-parameter-flow-control<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sentinel.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>åœ¨<code>io.github.xxyopen.novel.core.config.WebConfig</code>ä¸­æ³¨å†Œä¸€ä¸ªå…¨å±€çš„æ‹¦æˆªå™¨æ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// æµé‡é™åˆ¶æ‹¦æˆªå™¨</span>
registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>flowLimitInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>æ‹¦æˆªå™¨ä¸­å®šä¹‰èµ„æºå’Œè§„åˆ™ï¼Œèµ„æºåœ¨<code>preHandle</code>æ–¹æ³•ä¸­å®šä¹‰ï¼Œä¸ºæ‰€æœ‰è¯·æ±‚çš„å…¥å£ï¼Œ<code>æ¥å£é™æµè§„åˆ™</code>å’Œ<code>æ¥å£é˜²åˆ·è§„åˆ™</code>é€šè¿‡<code>static ä»£ç å—</code>åœ¨ç±»åŠ è½½æ—¶åˆå§‹åŒ–ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * æµé‡é™åˆ¶ æ‹¦æˆªå™¨
 * å®ç°æ¥å£é˜²åˆ·å’Œé™æµ
 *
 * @author xiongxiaoyang
 * @date 2022/6/1
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * novel é¡¹ç›®æ‰€æœ‰çš„èµ„æº
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NOVEL_RESOURCE</span> <span class="token operator">=</span> <span class="token string">&quot;novelResource&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¥å£é™æµè§„åˆ™ï¼šæ‰€æœ‰çš„è¯·æ±‚ï¼Œé™åˆ¶æ¯ç§’æœ€å¤šåªèƒ½é€šè¿‡ 2000 ä¸ªï¼Œè¶…å‡ºé™åˆ¶åŒ€é€Ÿæ’é˜Ÿ</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowRule</span> rule1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Set limit QPS to 2000.</span>
        rule1<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setControlBehavior</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_RATE_LIMITER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ¥å£é˜²åˆ·è§„åˆ™ 1ï¼šæ‰€æœ‰çš„è¯·æ±‚ï¼Œé™åˆ¶æ¯ä¸ª IP æ¯ç§’æœ€å¤šåªèƒ½é€šè¿‡ 50 ä¸ªï¼Œè¶…å‡ºé™åˆ¶ç›´æ¥æ‹’ç»</span>
        <span class="token class-name">ParamFlowRule</span> rule2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¥å£é˜²åˆ·è§„åˆ™ 2ï¼šæ‰€æœ‰çš„è¯·æ±‚ï¼Œé™åˆ¶æ¯ä¸ª IP æ¯åˆ†é’Ÿæœ€å¤šåªèƒ½é€šè¿‡ 1000 ä¸ªï¼Œè¶…å‡ºé™åˆ¶ç›´æ¥æ‹’ç»</span>
        <span class="token class-name">ParamFlowRule</span> rule3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDurationInSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>rule2<span class="token punctuation">,</span> rule3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getRealIp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è‹¥éœ€è¦é…ç½®ä¾‹å¤–é¡¹ï¼Œåˆ™ä¼ å…¥çš„å‚æ•°åªæ”¯æŒåŸºæœ¬ç±»å‹ã€‚</span>
            <span class="token comment">// EntryType ä»£è¡¨æµé‡ç±»å‹ï¼Œå…¶ä¸­ç³»ç»Ÿè§„åˆ™åªå¯¹ IN ç±»å‹çš„åŸ‹ç‚¹ç”Ÿæ•ˆ</span>
            <span class="token comment">// count å¤§å¤šæ•°æƒ…å†µéƒ½å¡« 1ï¼Œä»£è¡¨ç»Ÿè®¡ä¸ºä¸€æ¬¡è°ƒç”¨ã€‚</span>
            entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Your logic here.</span>
            <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Handle request rejection.</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;IP:{}è¢«é™æµäº†ï¼&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_REQ_MANY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ³¨æ„ï¼šexit çš„æ—¶å€™ä¹Ÿä¸€å®šè¦å¸¦ä¸Šå¯¹åº”çš„å‚æ•°ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰ç»Ÿè®¡é”™è¯¯ã€‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>è§„åˆ™å±æ€§è¯´æ˜ï¼š</p> <table><thead><tr><th>å±æ€§</th> <th>è¯´æ˜</th> <th>é»˜è®¤å€¼</th></tr></thead> <tbody><tr><td>resource</td> <td>èµ„æºåï¼Œå¿…å¡«</td> <td></td></tr> <tr><td>count</td> <td>é™æµé˜ˆå€¼ï¼Œå¿…å¡«</td> <td></td></tr> <tr><td>grade</td> <td>é™æµæ¨¡å¼</td> <td>QPS æ¨¡å¼</td></tr> <tr><td>durationInSec</td> <td>ç»Ÿè®¡çª—å£æ—¶é—´é•¿åº¦ï¼ˆå•ä½ä¸ºç§’ï¼‰ï¼Œ1.6.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ</td> <td>1s</td></tr> <tr><td>controlBehavior</td> <td>æµæ§æ•ˆæœï¼ˆæ”¯æŒå¿«é€Ÿå¤±è´¥å’ŒåŒ€é€Ÿæ’é˜Ÿæ¨¡å¼ï¼‰ï¼Œ1.6.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ</td> <td>å¿«é€Ÿå¤±è´¥</td></tr> <tr><td>maxQueueingTimeMs</td> <td>æœ€å¤§æ’é˜Ÿç­‰å¾…æ—¶é•¿ï¼ˆä»…åœ¨åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼ç”Ÿæ•ˆï¼‰ï¼Œ1.6.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ</td> <td>0ms</td></tr> <tr><td>paramIdx</td> <td>çƒ­ç‚¹å‚æ•°çš„ç´¢å¼•ï¼Œå¿…å¡«ï¼Œå¯¹åº” <code>SphU.entry(xxx, args)</code> ä¸­çš„å‚æ•°ç´¢å¼•ä½ç½®</td> <td></td></tr> <tr><td>paramFlowItemList</td> <td>å‚æ•°ä¾‹å¤–é¡¹ï¼Œå¯ä»¥é’ˆå¯¹æŒ‡å®šçš„å‚æ•°å€¼å•ç‹¬è®¾ç½®é™æµé˜ˆå€¼ï¼Œä¸å—å‰é¢ <code>count</code> é˜ˆå€¼çš„é™åˆ¶ã€‚<strong>ä»…æ”¯æŒåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ç±»å‹</strong></td> <td></td></tr> <tr><td>clusterMode</td> <td>æ˜¯å¦æ˜¯é›†ç¾¤å‚æ•°æµæ§è§„åˆ™</td> <td><code>false</code></td></tr> <tr><td>clusterConfig</td> <td>é›†ç¾¤æµæ§ç›¸å…³é…ç½®</td> <td></td></tr></tbody></table> <p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ Sentinel æä¾›çš„<code>æ³¨è§£æ”¯æŒæ¨¡å—</code>æ¥å®šä¹‰æˆ‘ä»¬çš„èµ„æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ŒhelloWorld() æ–¹æ³•æˆäº†æˆ‘ä»¬çš„ä¸€ä¸ªèµ„æºï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// èµ„æºä¸­çš„é€»è¾‘</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>æ³¨ï¼šæ³¨è§£æ”¯æŒæ¨¡å—éœ€è¦é…åˆ Spring AOP æˆ–è€… AspectJ ä¸€èµ·ä½¿ç”¨ã€‚</strong></p> <p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†æ¥å£é˜²åˆ·å’Œé™æµçš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å®æ—¶ç›‘æ§å’Œç®¡ç†é™æµè§„åˆ™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ­¥éª¤æ¥å…¥ Sentinel å¼€æºæ§åˆ¶å°ï¼š</p> <ul><li><p>ä¸‹è½½æ§åˆ¶å° jar åŒ…å¹¶åœ¨æœ¬åœ°å¯åŠ¨</p></li> <li><p>novel é¡¹ç›®å¼•å…¥ Transport æ¨¡å—æ¥ä¸ Sentinel æ§åˆ¶å°è¿›è¡Œé€šä¿¡</p></li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-transport-simple-http<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.8.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>novel é¡¹ç›®å¯åŠ¨æ—¶åŠ å…¥ JVM å‚æ•° -Dcsp.sentinel.dashboard.server=consoleIp:port æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£</li> <li>ç¡®ä¿ novel é¡¹ç›®æœ‰è®¿é—®é‡</li></ul> <p>å®Œæˆä»¥ä¸Šæ­¥éª¤åå³å¯åœ¨ Sentinel æ§åˆ¶å°ä¸Šçœ‹åˆ°å¯¹åº”çš„åº”ç”¨ï¼Œæœºå™¨åˆ—è¡¨é¡µé¢å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æœºå™¨ã€‚</p> <h2 id="é›†æˆ-shardingsphere-jdbc-ä¼˜åŒ–å°è¯´å†…å®¹å­˜å‚¨"><a href="#é›†æˆ-shardingsphere-jdbc-ä¼˜åŒ–å°è¯´å†…å®¹å­˜å‚¨" class="header-anchor">#</a> é›†æˆ ShardingSphere-JDBC ä¼˜åŒ–å°è¯´å†…å®¹å­˜å‚¨</h2> <h3 id="èƒŒæ™¯-2"><a href="#èƒŒæ™¯-2" class="header-anchor">#</a> èƒŒæ™¯</h3> <p>ä¼ ç»Ÿçš„å°†æ•°æ®é›†ä¸­å­˜å‚¨è‡³å•ä¸€èŠ‚ç‚¹çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨æ€§èƒ½ã€å¯ç”¨æ€§å’Œè¿ç»´æˆæœ¬è¿™ä¸‰æ–¹é¢å·²ç»éš¾äºæ»¡è¶³æµ·é‡æ•°æ®çš„åœºæ™¯ã€‚</p> <p>ä»æ€§èƒ½æ–¹é¢æ¥è¯´ï¼Œç”±äºå…³ç³»å‹æ•°æ®åº“å¤§å¤šé‡‡ç”¨ B+ æ ‘ç±»å‹çš„ç´¢å¼•ï¼Œåœ¨æ•°æ®é‡è¶…è¿‡é˜ˆå€¼çš„æƒ…å†µä¸‹ï¼Œç´¢å¼•æ·±åº¦çš„å¢åŠ ä¹Ÿå°†ä½¿å¾—ç£ç›˜è®¿é—®çš„ IO æ¬¡æ•°å¢åŠ ï¼Œè¿›è€Œå¯¼è‡´æŸ¥è¯¢æ€§èƒ½çš„ä¸‹é™ï¼› åŒæ—¶ï¼Œé«˜å¹¶å‘è®¿é—®è¯·æ±‚ä¹Ÿä½¿å¾—é›†ä¸­å¼æ•°æ®åº“æˆä¸ºç³»ç»Ÿçš„æœ€å¤§ç“¶é¢ˆã€‚</p> <p>ä»å¯ç”¨æ€§çš„æ–¹é¢æ¥è®²ï¼ŒæœåŠ¡åŒ–çš„æ— çŠ¶æ€æ€§ï¼Œèƒ½å¤Ÿè¾¾åˆ°è¾ƒå°æˆæœ¬çš„éšæ„æ‰©å®¹ï¼Œè¿™å¿…ç„¶å¯¼è‡´ç³»ç»Ÿçš„æœ€ç»ˆå‹åŠ›éƒ½è½åœ¨æ•°æ®åº“ä¹‹ä¸Šã€‚ è€Œå•ä¸€çš„æ•°æ®èŠ‚ç‚¹ï¼Œæˆ–è€…ç®€å•çš„ä¸»ä»æ¶æ„ï¼Œå·²ç»è¶Šæ¥è¶Šéš¾ä»¥æ‰¿æ‹…ã€‚æ•°æ®åº“çš„å¯ç”¨æ€§ï¼Œå·²æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„å…³é”®ã€‚</p> <p>ä»è¿ç»´æˆæœ¬æ–¹é¢è€ƒè™‘ï¼Œå½“ä¸€ä¸ªæ•°æ®åº“å®ä¾‹ä¸­çš„æ•°æ®è¾¾åˆ°é˜ˆå€¼ä»¥ä¸Šï¼Œå¯¹äº DBA çš„è¿ç»´å‹åŠ›å°±ä¼šå¢å¤§ã€‚ æ•°æ®å¤‡ä»½å’Œæ¢å¤çš„æ—¶é—´æˆæœ¬éƒ½å°†éšç€æ•°æ®é‡çš„å¤§å°è€Œæ„ˆå‘ä¸å¯æ§ã€‚ä¸€èˆ¬æ¥è®²ï¼Œå•ä¸€æ•°æ®åº“å®ä¾‹çš„æ•°æ®çš„é˜ˆå€¼åœ¨ 1TB ä¹‹å†…ï¼Œæ˜¯æ¯”è¾ƒåˆç†çš„èŒƒå›´ã€‚</p> <p>æ•°æ®åˆ†ç‰‡æŒ‡æŒ‰ç…§æŸä¸ªç»´åº¦å°†å­˜æ”¾åœ¨å•ä¸€æ•°æ®åº“ä¸­çš„æ•°æ®åˆ†æ•£åœ°å­˜æ”¾è‡³å¤šä¸ªæ•°æ®åº“æˆ–è¡¨ä¸­ä»¥è¾¾åˆ°æå‡æ€§èƒ½ç“¶é¢ˆä»¥åŠå¯ç”¨æ€§çš„æ•ˆæœã€‚é€šè¿‡åˆ†åº“å’Œåˆ†è¡¨è¿›è¡Œæ•°æ®çš„æ‹†åˆ†æ¥ä½¿å¾—å„ä¸ªè¡¨çš„æ•°æ®é‡ä¿æŒåœ¨é˜ˆå€¼ä»¥ä¸‹ï¼Œä»¥åŠå¯¹æµé‡è¿›è¡Œç–å¯¼åº”å¯¹é«˜è®¿é—®é‡ï¼Œæ˜¯åº”å¯¹é«˜å¹¶å‘å’Œæµ·é‡æ•°æ®ç³»ç»Ÿçš„æœ‰æ•ˆæ‰‹æ®µã€‚åˆ†åº“å’Œåˆ†è¡¨å‡å¯ä»¥æœ‰æ•ˆçš„é¿å…ç”±æ•°æ®é‡è¶…è¿‡å¯æ‰¿å—é˜ˆå€¼è€Œäº§ç”Ÿçš„æŸ¥è¯¢ç“¶é¢ˆã€‚</p> <p>å°è¯´æ•°æ®æœ‰ç€å†…å®¹å¤šã€å¢é•¿é€Ÿåº¦å¿«çš„ç‰¹ç‚¹ï¼Œä¸€æœ¬ä¸»æµçš„å®Œç»“å°è¯´ä¸€èˆ¬æ‰€éœ€å­˜å‚¨ç©ºé—´å¤§æ¦‚åœ¨ 5MB ä»¥ä¸Šã€‚ä¸€ä¸ªä¸»æµçš„å°è¯´ç½‘ç«™åœ¨å‘å±•ä¸­åæœŸï¼Œæ•°æ®é‡æ˜¯è¿œè¿œè¶…è¿‡å•ä¸€æ•°æ®åº“å®ä¾‹çš„é˜ˆå€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å°è¯´å†…å®¹è¿›è¡Œåˆ†åº“åˆ†è¡¨å­˜å‚¨æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚åœ¨å‘å±•åˆæœŸï¼Œæˆ‘ä»¬çš„æ•°æ®é‡è¿˜ä¸æ˜¯å¾ˆå¤§ï¼Œå¯ä»¥å…ˆå°†å°è¯´å†…å®¹åˆ†è¡¨å­˜å‚¨ä»¥å‡è½»æ•°æ®åº“å•è¡¨å‹åŠ›ä»¥åŠä¸ºåæœŸçš„æ•°æ®åº“åˆ†åº“åšå‡†å¤‡ã€‚ç­‰æ•°æ®é‡å³å°†è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå†è¿ç§»åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ä¸Šã€‚</p> <p><strong>æ³¨ï¼šæ•°æ®åˆ†ç‰‡åˆ†ä¸ºæŒ‰ç…§ä¸šåŠ¡å°†è¡¨è¿›è¡Œå½’ç±»ï¼Œåˆ†å¸ƒåˆ°ä¸åŒçš„æ•°æ®åº“ä¸­çš„å‚ç›´åˆ†ç‰‡å’Œé€šè¿‡æŸä¸ªå­—æ®µï¼ˆæˆ–æŸå‡ ä¸ªå­—æ®µï¼‰æŒ‰ç…§æŸç§è§„åˆ™å°†æ•°æ®åˆ†æ•£è‡³å¤šä¸ªåº“æˆ–è¡¨ä¸­çš„æ°´å¹³åˆ†ç‰‡ã€‚</strong></p> <h3 id="apache-shardingsphere-ä»‹ç»"><a href="#apache-shardingsphere-ä»‹ç»" class="header-anchor">#</a> Apache ShardingSphere ä»‹ç»</h3> <p>Apache ShardingSphere äº§å“å®šä½ä¸º Database Plusï¼Œå®ƒå…³æ³¨å¦‚ä½•å……åˆ†åˆç†åœ°åˆ©ç”¨æ•°æ®åº“çš„è®¡ç®—å’Œå­˜å‚¨èƒ½åŠ›ï¼Œè€Œå¹¶éå®ç°ä¸€ä¸ªå…¨æ–°çš„æ•°æ®åº“ã€‚ShardingSphere ç«™åœ¨æ•°æ®åº“çš„ä¸Šå±‚è§†è§’ï¼Œå…³æ³¨ä»–ä»¬ä¹‹é—´çš„åä½œå¤šäºæ•°æ®åº“è‡ªèº«ï¼Œç”± JDBCã€Proxy å’Œ Sidecarï¼ˆè§„åˆ’ä¸­ï¼‰è¿™ 3 æ¬¾æ—¢èƒ½å¤Ÿç‹¬ç«‹éƒ¨ç½²ï¼Œåˆæ”¯æŒæ··åˆéƒ¨ç½²é…åˆä½¿ç”¨çš„äº§å“ç»„æˆã€‚ å®ƒä»¬å‡æä¾›æ ‡å‡†åŒ–çš„åŸºäºæ•°æ®åº“ä½œä¸ºå­˜å‚¨èŠ‚ç‚¹çš„å¢é‡åŠŸèƒ½ï¼Œå¯é€‚ç”¨äºå¦‚ Java åŒæ„ã€å¼‚æ„è¯­è¨€ã€äº‘åŸç”Ÿç­‰å„ç§å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ã€‚</p> <p>ShardingSphere-JDBC å®šä½ä¸ºè½»é‡çº§ Java æ¡†æ¶ï¼Œåœ¨ Java çš„ JDBC å±‚æä¾›é¢å¤–æœåŠ¡ã€‚ å®ƒä½¿ç”¨å®¢æˆ·ç«¯ç›´è¿æ•°æ®åº“ï¼Œä»¥ jar åŒ…å½¢å¼æä¾›æœåŠ¡ï¼Œæ— éœ€é¢å¤–éƒ¨ç½²å’Œä¾èµ–ï¼Œå¯ç†è§£ä¸ºå¢å¼ºç‰ˆçš„ JDBC é©±åŠ¨ï¼Œå®Œå…¨å…¼å®¹ JDBC å’Œå„ç§ ORM æ¡†æ¶ã€‚</p> <p>ShardingSphere-Proxy å®šä½ä¸ºé€æ˜åŒ–çš„æ•°æ®åº“ä»£ç†ç«¯ï¼Œæä¾›å°è£…äº†æ•°æ®åº“äºŒè¿›åˆ¶åè®®çš„æœåŠ¡ç«¯ç‰ˆæœ¬ï¼Œç”¨äºå®Œæˆå¯¹å¼‚æ„è¯­è¨€çš„æ”¯æŒã€‚</p> <p>ShardingSphere-Sidecar å®šä½ä¸º Kubernetes çš„äº‘åŸç”Ÿæ•°æ®åº“ä»£ç†ï¼Œä»¥ Sidecar çš„å½¢å¼ä»£ç†æ‰€æœ‰å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚ é€šè¿‡æ— ä¸­å¿ƒã€é›¶ä¾µå…¥çš„æ–¹æ¡ˆæä¾›ä¸æ•°æ®åº“äº¤äº’çš„å•®åˆå±‚ï¼Œå³ Database Meshï¼Œåˆå¯ç§°æ•°æ®åº“ç½‘æ ¼ã€‚</p> <p>è¿æ¥ã€å¢é‡ å’Œ å¯æ’æ‹” æ˜¯ Apache ShardingSphere çš„æ ¸å¿ƒæ¦‚å¿µï¼š</p> <ul><li><p>è¿æ¥ï¼šé€šè¿‡å¯¹æ•°æ®åº“åè®®ã€SQL æ–¹è¨€ä»¥åŠæ•°æ®åº“å­˜å‚¨çš„çµæ´»é€‚é…ï¼Œå¿«é€Ÿçš„è¿æ¥åº”ç”¨ä¸å¤šæ¨¡å¼çš„å¼‚æ„æ•°æ®åº“ï¼›</p></li> <li><p>å¢é‡ï¼šè·å–æ•°æ®åº“çš„è®¿é—®æµé‡ï¼Œå¹¶æä¾›æµé‡é‡å®šå‘ï¼ˆæ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€å½±å­åº“ï¼‰ã€æµé‡å˜å½¢ï¼ˆæ•°æ®åŠ å¯†ã€æ•°æ®è„±æ•ï¼‰ã€æµé‡é‰´æƒï¼ˆå®‰å…¨ã€å®¡è®¡ã€æƒé™ï¼‰ã€æµé‡æ²»ç†ï¼ˆç†”æ–­ã€é™æµï¼‰ä»¥åŠæµé‡åˆ†æï¼ˆæœåŠ¡è´¨é‡åˆ†æã€å¯è§‚å¯Ÿæ€§ï¼‰ç­‰é€æ˜åŒ–å¢é‡åŠŸèƒ½ï¼›</p></li> <li><p>å¯æ’æ‹”ï¼šé¡¹ç›®é‡‡ç”¨å¾®å†…æ ¸ + ä¸‰å±‚å¯æ’æ‹”æ¨¡å‹ï¼Œä½¿å†…æ ¸ã€åŠŸèƒ½ç»„ä»¶ä»¥åŠç”Ÿæ€å¯¹æ¥å®Œå…¨èƒ½å¤Ÿçµæ´»çš„æ–¹å¼è¿›è¡Œæ’æ‹”å¼æ‰©å±•ï¼Œå¼€å‘è€…èƒ½å¤Ÿåƒä½¿ç”¨ç§¯æœ¨ä¸€æ ·å®šåˆ¶å±äºè‡ªå·±çš„ç‹¬ç‰¹ç³»ç»Ÿã€‚</p></li></ul> <p>Apache ShardingSphere çš„æ•°æ®åˆ†ç‰‡æ¨¡å—é€æ˜åŒ–äº†åˆ†åº“åˆ†è¡¨æ‰€å¸¦æ¥çš„å½±å“ï¼Œè®©ä½¿ç”¨æ–¹å°½é‡åƒä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ä¸€æ ·ä½¿ç”¨æ°´å¹³åˆ†ç‰‡ä¹‹åçš„æ•°æ®åº“é›†ç¾¤ã€‚</p> <h3 id="é›†æˆæ­¥éª¤"><a href="#é›†æˆæ­¥éª¤" class="header-anchor">#</a> é›†æˆæ­¥éª¤</h3> <ol><li>MySQL æ‰§è¡Œä»¥ä¸‹çš„æ•°æ®è¿ç§»è„šæœ¬ï¼š</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> createBookChapterTable<span class="token punctuation">;</span>
<span class="token comment">-- åˆ›å»ºå°è¯´ç« èŠ‚è¡¨çš„å­˜å‚¨è¿‡ç¨‹</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> createBookChapterTable <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- å®šä¹‰å˜é‡</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
			i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">DO</span>
			
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_chapter'</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'create table '</span><span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> <span class="token string">'(
				`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
				`book_id` bigint(20) unsigned NOT NULL COMMENT \'å°è¯´ID\',
				`chapter_num` smallint(5) unsigned NOT NULL COMMENT \'ç« èŠ‚å·\',
				`chapter_name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT \'ç« èŠ‚å\',
				`word_count` int(10) unsigned NOT NULL COMMENT \'ç« èŠ‚å­—æ•°\',
				`is_vip` tinyint(3) unsigned NOT NULL DEFAULT \'0\' COMMENT \'æ˜¯å¦æ”¶è´¹;1-æ”¶è´¹ 0-å…è´¹\',
				`create_time` datetime DEFAULT NULL,
				`update_time` datetime DEFAULT NULL,
				PRIMARY KEY (`id`) USING BTREE,
				UNIQUE KEY `uk_bookId_chapterNum` (`book_id`,`chapter_num`) USING BTREE,
				UNIQUE KEY `pk_id` (`id`) USING BTREE,
				KEY `idx_bookId` (`book_id`) USING BTREE
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\'å°è¯´ç« èŠ‚\''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> createBookChapterTable <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> createBookContentTable<span class="token punctuation">;</span>
<span class="token comment">-- åˆ›å»ºå°è¯´å†…å®¹è¡¨çš„å­˜å‚¨è¿‡ç¨‹</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> createBookContentTable <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- å®šä¹‰å˜é‡</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
			i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">DO</span>
			
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_content'</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'create table '</span><span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> <span class="token string">'(
				`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT \'ä¸»é”®\',
				`chapter_id` bigint(20) unsigned NOT NULL COMMENT \'ç« èŠ‚ID\',
				`content` mediumtext CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT \'å°è¯´ç« èŠ‚å†…å®¹\',
				`create_time` datetime DEFAULT NULL,
				`update_time` datetime DEFAULT NULL,
				PRIMARY KEY (`id`) USING BTREE,
				UNIQUE KEY `uk_chapterId` (`chapter_id`) USING BTREE,
				UNIQUE KEY `pk_id` (`id`) USING BTREE
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\'å°è¯´å†…å®¹\''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> createBookContentTable <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> copyBookChapterData<span class="token punctuation">;</span>
<span class="token comment">-- è¿ç§»å°è¯´ç« èŠ‚æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> copyBookChapterData <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- å®šä¹‰å˜é‡</span>
	<span class="token keyword">DECLARE</span>
		s <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		bookId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterNum <span class="token keyword">SMALLINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterName <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		wordCount <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		isVip <span class="token keyword">TINYINT</span> <span class="token punctuation">(</span> <span class="token number">64</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		createTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		updateTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableNumber <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">-- å®šä¹‰æ¸¸æ ‡</span>
	<span class="token keyword">DECLARE</span>
		report <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span>
		id<span class="token punctuation">,</span>
		book_id<span class="token punctuation">,</span>
		chapter_num<span class="token punctuation">,</span>
		chapter_name<span class="token punctuation">,</span>
		word_count<span class="token punctuation">,</span>
		is_vip<span class="token punctuation">,</span>
		create_time<span class="token punctuation">,</span>
		update_time 
	<span class="token keyword">FROM</span>
		book_chapter<span class="token punctuation">;</span>
	<span class="token comment">-- å£°æ˜å½“æ¸¸æ ‡éå†å®Œåå°†æ ‡å¿—å˜é‡ç½®æˆæŸä¸ªå€¼</span>
	<span class="token keyword">DECLARE</span>
		<span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND 
		<span class="token keyword">SET</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- æ‰“å¼€æ¸¸æ ‡</span>
	<span class="token keyword">OPEN</span> report<span class="token punctuation">;</span>
	<span class="token comment">-- å°†æ¸¸æ ‡ä¸­çš„å€¼èµ‹å€¼ç»™å˜é‡ï¼Œæ³¨æ„ï¼šå˜é‡åä¸è¦å’Œè¿”å›çš„åˆ—ååŒåï¼Œå˜é‡é¡ºåºè¦å’Œsqlç»“æœåˆ—çš„é¡ºåºä¸€è‡´</span>
	<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> chapterId<span class="token punctuation">,</span>
	bookId<span class="token punctuation">,</span>
	chapterNum<span class="token punctuation">,</span>
	chapterName<span class="token punctuation">,</span>
	wordCount<span class="token punctuation">,</span>
	isVip<span class="token punctuation">,</span>
	createTime<span class="token punctuation">,</span>
	updateTime<span class="token punctuation">;</span>
	<span class="token comment">-- å¾ªç¯éå†</span>
	<span class="token keyword">WHILE</span>
			s <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token keyword">DO</span>
			<span class="token comment">-- æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span>
			
			<span class="token keyword">SET</span> tableNumber <span class="token operator">=</span> bookId <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_chapter'</span><span class="token punctuation">,</span> tableNumber <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span>
				<span class="token string">'insert into '</span><span class="token punctuation">,</span>
				tableName<span class="token punctuation">,</span>
				<span class="token string">'(`id`, `book_id`, `chapter_num`, `chapter_name`, `word_count`, `is_vip`, `create_time`, `update_time`) VALUES ('</span><span class="token punctuation">,</span>
				chapterId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				bookId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				chapterNum<span class="token punctuation">,</span>
				<span class="token string">', \''</span><span class="token punctuation">,</span>
				chapterName<span class="token punctuation">,</span>
				<span class="token string">'\', '</span><span class="token punctuation">,</span>
				wordCount<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				isVip<span class="token punctuation">,</span>
				<span class="token string">', \''</span><span class="token punctuation">,</span>
				createTime<span class="token punctuation">,</span>
				<span class="token string">'\', \''</span><span class="token punctuation">,</span>
				updateTime<span class="token punctuation">,</span>
				<span class="token string">'\')'</span> 
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> chapterId<span class="token punctuation">,</span>
			bookId<span class="token punctuation">,</span>
			chapterNum<span class="token punctuation">,</span>
			chapterName<span class="token punctuation">,</span>
			wordCount<span class="token punctuation">,</span>
			isVip<span class="token punctuation">,</span>
			createTime<span class="token punctuation">,</span>
			updateTime<span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token comment">-- å…³é—­æ¸¸æ ‡</span>
	<span class="token keyword">CLOSE</span> report<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> copyBookChapterData <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> copyBookContentData<span class="token punctuation">;</span>
<span class="token comment">-- è¿ç§»å°è¯´å†…å®¹æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> copyBookContentData <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- å®šä¹‰å˜é‡</span>
	<span class="token keyword">DECLARE</span>
		s <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		contentId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		bookContent <span class="token keyword">MEDIUMTEXT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		createTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		updateTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableNumber <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">-- å®šä¹‰æ¸¸æ ‡</span>
	<span class="token keyword">DECLARE</span>
		report <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span>
		id<span class="token punctuation">,</span>
		chapter_id<span class="token punctuation">,</span>
		content<span class="token punctuation">,</span>
		create_time<span class="token punctuation">,</span>
		update_time 
	<span class="token keyword">FROM</span>
		book_content<span class="token punctuation">;</span>
	<span class="token comment">-- å£°æ˜å½“æ¸¸æ ‡éå†å®Œåå°†æ ‡å¿—å˜é‡ç½®æˆæŸä¸ªå€¼</span>
	<span class="token keyword">DECLARE</span>
		<span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND 
		<span class="token keyword">SET</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- æ‰“å¼€æ¸¸æ ‡</span>
	<span class="token keyword">OPEN</span> report<span class="token punctuation">;</span>
	<span class="token comment">-- å°†æ¸¸æ ‡ä¸­çš„å€¼èµ‹å€¼ç»™å˜é‡ï¼Œæ³¨æ„ï¼šå˜é‡åä¸è¦å’Œè¿”å›çš„åˆ—ååŒåï¼Œå˜é‡é¡ºåºè¦å’Œsqlç»“æœåˆ—çš„é¡ºåºä¸€è‡´</span>
	<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> contentId<span class="token punctuation">,</span>
	chapterId<span class="token punctuation">,</span>
	bookContent<span class="token punctuation">,</span>
	createTime<span class="token punctuation">,</span>
	updateTime<span class="token punctuation">;</span>
	<span class="token comment">-- å¾ªç¯éå†</span>
	<span class="token keyword">WHILE</span>
			s <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token keyword">DO</span>
			<span class="token comment">-- æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span>
			
			<span class="token keyword">SET</span> tableNumber <span class="token operator">=</span> chapterId <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_content'</span><span class="token punctuation">,</span> tableNumber <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> bookContent <span class="token operator">=</span> <span class="token keyword">REPLACE</span> <span class="token punctuation">(</span> bookContent<span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">&quot;\\'&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span>
				<span class="token string">'insert into '</span><span class="token punctuation">,</span>
				tableName<span class="token punctuation">,</span>
				<span class="token string">'(`id`, `chapter_id`, `content`) VALUES ('</span><span class="token punctuation">,</span>
				contentId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				chapterId<span class="token punctuation">,</span>
				<span class="token string">',\''</span><span class="token punctuation">,</span>
				bookContent<span class="token punctuation">,</span>
				<span class="token string">'\')'</span> 
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> contentId<span class="token punctuation">,</span>
			chapterId<span class="token punctuation">,</span>
			bookContent<span class="token punctuation">,</span>
			createTime<span class="token punctuation">,</span>
			updateTime<span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token comment">-- å…³é—­æ¸¸æ ‡</span>
	<span class="token keyword">CLOSE</span> report<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> copyBookContentData <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>å¼•å…¥ ShardingSphere-JDBC å®˜æ–¹æä¾›çš„ Spring Boot Starter ä¾èµ–ï¼š</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shardingsphere-jdbc-core-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>application.yml ä¸­æ·»åŠ  ShardingSphere-JDBC çš„é…ç½®ï¼š</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token comment"># æ˜¯å¦å¼€å¯ shardingsphere</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># æ˜¯å¦åœ¨æ—¥å¿—ä¸­æ‰“å° SQL</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æ¨¡å¼é…ç½®</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span>
      <span class="token comment"># å•æœºæ¨¡å¼</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Standalone
      <span class="token key atrule">repository</span><span class="token punctuation">:</span>
        <span class="token comment"># æ–‡ä»¶æŒä¹…åŒ–</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> File
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># å…ƒæ•°æ®å­˜å‚¨è·¯å¾„</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> .shardingsphere
      <span class="token comment"># ä½¿ç”¨æœ¬åœ°é…ç½®è¦†ç›–æŒä¹…åŒ–é…ç½®</span>
      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># æ•°æ®æºé…ç½®</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> ds_0
      <span class="token key atrule">ds_0</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
        <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/novel_test<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> test123456
    <span class="token comment"># è§„åˆ™é…ç½®</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token comment"># æ•°æ®åˆ†ç‰‡</span>
      <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
        <span class="token key atrule">tables</span><span class="token punctuation">:</span>
          <span class="token comment"># book_content è¡¨</span>
          <span class="token key atrule">book_content</span><span class="token punctuation">:</span>
            <span class="token comment"># æ•°æ®èŠ‚ç‚¹</span>
            <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>.book_content$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..9<span class="token punctuation">}</span>
            <span class="token comment"># åˆ†è¡¨ç­–ç•¥</span>
            <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
              <span class="token key atrule">standard</span><span class="token punctuation">:</span>
                <span class="token comment"># åˆ†ç‰‡åˆ—åç§°</span>
                <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> chapter_id
                <span class="token comment"># åˆ†ç‰‡ç®—æ³•åç§°</span>
                <span class="token key atrule">sharding-algorithm-name</span><span class="token punctuation">:</span> bookContentSharding
        <span class="token key atrule">sharding-algorithms</span><span class="token punctuation">:</span>
          <span class="token key atrule">bookContentSharding</span><span class="token punctuation">:</span>
            <span class="token comment"># è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ç®—æ³•ï¼Œä½¿ç”¨ Groovy çš„è¡¨è¾¾å¼ï¼Œæä¾›å¯¹ SQL è¯­å¥ä¸­çš„ = å’Œ IN çš„åˆ†ç‰‡æ“ä½œæ”¯æŒ</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token comment"># åˆ†ç‰‡ç®—æ³•çš„è¡Œè¡¨è¾¾å¼</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> book_content$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>chapter_id % 10<span class="token punctuation">}</span>
</code></pre></div><p>é…ç½®æ˜¯ ShardingSphere-JDBC ä¸­å”¯ä¸€ä¸åº”ç”¨å¼€å‘è€…äº¤äº’çš„æ¨¡å—ï¼Œé€šè¿‡å®ƒå¯ä»¥å¿«é€Ÿæ¸…æ™°çš„ç†è§£ ShardingSphere-JDBC æ‰€æä¾›çš„åŠŸèƒ½ã€‚</p> <ul><li><p>æ¨¡å¼é…ç½®ï¼š Apache ShardingSphere æä¾›çš„ 3 ç§è¿è¡Œæ¨¡å¼åˆ†åˆ«æ˜¯é€‚ç”¨äºé›†æˆæµ‹è¯•çš„ç¯å¢ƒå¯åŠ¨ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜åœ¨æ•´åˆåŠŸèƒ½æµ‹è¯•ä¸­é›†æˆ Apache ShardingSphere è€Œæ— éœ€æ¸…ç†è¿è¡Œç—•è¿¹<code>å†…å­˜æ¨¡å¼</code>ã€èƒ½å¤Ÿå°†æ•°æ®æºå’Œè§„åˆ™ç­‰å…ƒæ•°æ®ä¿¡æ¯æŒä¹…åŒ–ï¼Œä½†æ— æ³•å°†å…ƒæ•°æ®åŒæ­¥è‡³å¤šä¸ª Apache ShardingSphere å®ä¾‹ï¼Œæ— æ³•åœ¨é›†ç¾¤ç¯å¢ƒä¸­ç›¸äº’æ„ŸçŸ¥çš„<code>å•æœºæ¨¡å¼</code>å’Œæä¾›äº†å¤šä¸ª Apache ShardingSphere å®ä¾‹ä¹‹é—´çš„å…ƒæ•°æ®å…±äº«å’Œåˆ†å¸ƒå¼åœºæ™¯ä¸‹çŠ¶æ€åè°ƒèƒ½åŠ›çš„<code>é›†ç¾¤æ¨¡å¼</code>ã€‚</p></li> <li><p>æ•°æ®æºé…ç½®ï¼šåŒ…æ‹¬ä½¿ç”¨æœ¬åœ°æ•°æ®æºé…ç½®ï¼ˆæœ¬é¡¹ç›®ä¸­ï¼‰å’Œä½¿ç”¨ JNDI æ•°æ®æºçš„é…ç½®ã€‚å¦‚æœè®¡åˆ’ä½¿ç”¨ JNDI é…ç½®æ•°æ®åº“ï¼Œåœ¨åº”ç”¨å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰ä¸­ä½¿ç”¨ ShardingSphere-JDBC æ—¶ï¼Œ å¯ä½¿ç”¨ spring.shardingsphere.datasource.${datasourceName}.jndiName æ¥ä»£æ›¿æ•°æ®æºçš„ä¸€ç³»åˆ—é…ç½®ã€‚</p></li> <li><p>è§„åˆ™é…ç½®ï¼šè§„åˆ™æ˜¯ Apache ShardingSphere é¢å‘å¯æ’æ‹”çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ•°æ®åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ã€é«˜å¯ç”¨ã€æ•°æ®åŠ å¯†ã€å½±å­åº“ã€SQL è§£æã€æ··åˆè§„åˆ™ç­‰ã€‚</p></li></ul> <p>ä»¥ä¸‹æ˜¯æ•°æ®åˆ†ç‰‡çš„é…ç½®é¡¹è¯´æ˜ï¼š</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># æ ‡å‡†åˆ†ç‰‡è¡¨é…ç½®</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.actual-data-nodes</span><span class="token punctuation">=</span> <span class="token value attr-value"># ç”±æ•°æ®æºå + è¡¨åç»„æˆï¼Œä»¥å°æ•°ç‚¹åˆ†éš”ã€‚å¤šä¸ªè¡¨ä»¥é€—å·åˆ†éš”ï¼Œæ”¯æŒ inline è¡¨è¾¾å¼ã€‚ç¼ºçœè¡¨ç¤ºä½¿ç”¨å·²çŸ¥æ•°æ®æºä¸é€»è¾‘è¡¨åç§°ç”Ÿæˆæ•°æ®èŠ‚ç‚¹ï¼Œç”¨äºå¹¿æ’­è¡¨ï¼ˆå³æ¯ä¸ªåº“ä¸­éƒ½éœ€è¦ä¸€ä¸ªåŒæ ·çš„è¡¨ç”¨äºå…³è”æŸ¥è¯¢ï¼Œå¤šä¸ºå­—å…¸è¡¨ï¼‰æˆ–åªåˆ†åº“ä¸åˆ†è¡¨ä¸”æ‰€æœ‰åº“çš„è¡¨ç»“æ„å®Œå…¨ä¸€è‡´çš„æƒ…å†µ</span>

<span class="token comment"># åˆ†åº“ç­–ç•¥ï¼Œç¼ºçœè¡¨ç¤ºä½¿ç”¨é»˜è®¤åˆ†åº“ç­–ç•¥ï¼Œä»¥ä¸‹çš„åˆ†ç‰‡ç­–ç•¥åªèƒ½é€‰å…¶ä¸€</span>

<span class="token comment"># ç”¨äºå•åˆ†ç‰‡é”®çš„æ ‡å‡†åˆ†ç‰‡åœºæ™¯</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.standard.sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡åˆ—åç§°</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.standard.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡ç®—æ³•åç§°</span>

<span class="token comment"># ç”¨äºå¤šåˆ†ç‰‡é”®çš„å¤åˆåˆ†ç‰‡åœºæ™¯</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.complex.sharding-columns</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡åˆ—åç§°ï¼Œå¤šä¸ªåˆ—ä»¥é€—å·åˆ†éš”</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.complex.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡ç®—æ³•åç§°</span>

<span class="token comment"># ç”¨äº Hint çš„åˆ†ç‰‡ç­–ç•¥</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.hint.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡ç®—æ³•åç§°</span>

<span class="token comment"># åˆ†è¡¨ç­–ç•¥ï¼ŒåŒåˆ†åº“ç­–ç•¥</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.table-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># çœç•¥</span>

<span class="token comment"># è‡ªåŠ¨åˆ†ç‰‡è¡¨é…ç½®</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.actual-data-sources</span><span class="token punctuation">=</span> <span class="token value attr-value"># æ•°æ®æºå</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.sharding-strategy.standard.sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡åˆ—åç§°</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.sharding-strategy.standard.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># è‡ªåŠ¨åˆ†ç‰‡ç®—æ³•åç§°</span>

<span class="token comment"># åˆ†å¸ƒå¼åºåˆ—ç­–ç•¥é…ç½®</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.key-generate-strategy.column</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†å¸ƒå¼åºåˆ—åˆ—åç§°</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.key-generate-strategy.key-generator-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†å¸ƒå¼åºåˆ—ç®—æ³•åç§°</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[0]</span><span class="token punctuation">=</span> <span class="token value attr-value"># ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[1]</span><span class="token punctuation">=</span> <span class="token value attr-value"># ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[x]</span><span class="token punctuation">=</span> <span class="token value attr-value"># ç»‘å®šè¡¨è§„åˆ™åˆ—è¡¨</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[0]</span><span class="token punctuation">=</span> <span class="token value attr-value"># å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[1]</span><span class="token punctuation">=</span> <span class="token value attr-value"># å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[x]</span><span class="token punctuation">=</span> <span class="token value attr-value"># å¹¿æ’­è¡¨è§„åˆ™åˆ—è¡¨</span>

<span class="token key attr-name">spring.shardingsphere.sharding.default-database-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># é»˜è®¤æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-table-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># é»˜è®¤è¡¨åˆ†ç‰‡ç­–ç•¥</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-key-generate-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># é»˜è®¤åˆ†å¸ƒå¼åºåˆ—ç­–ç•¥</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># é»˜è®¤åˆ†ç‰‡åˆ—åç§°</span>

<span class="token comment"># åˆ†ç‰‡ç®—æ³•é…ç½®</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.sharding-algorithms.&lt;sharding-algorithm-name&gt;.type</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡ç®—æ³•ç±»å‹</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.sharding-algorithms.&lt;sharding-algorithm-name&gt;.props.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†ç‰‡ç®—æ³•å±æ€§é…ç½®</span>

<span class="token comment"># åˆ†å¸ƒå¼åºåˆ—ç®—æ³•é…ç½®</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.key-generators.&lt;key-generate-algorithm-name&gt;.type</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†å¸ƒå¼åºåˆ—ç®—æ³•ç±»å‹</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.key-generators.&lt;key-generate-algorithm-name&gt;.props.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># åˆ†å¸ƒå¼åºåˆ—ç®—æ³•å±æ€§é…ç½®</span>
</code></pre></div><p>å…¶ä¸­ï¼Œåˆ†ç‰‡ç®—æ³•åˆ†ä¸ºåŒ…å«å–æ¨¡åˆ†ç‰‡ã€å“ˆå¸Œå–æ¨¡åˆ†ç‰‡ã€åŸºäºåˆ†ç‰‡å®¹é‡çš„èŒƒå›´åˆ†ç‰‡ã€åŸºäºåˆ†ç‰‡è¾¹ç•Œçš„èŒƒå›´åˆ†ç‰‡ã€è‡ªåŠ¨æ—¶é—´æ®µåˆ†ç‰‡åœ¨å†…çš„<code>è‡ªåŠ¨åˆ†ç‰‡ç®—æ³•</code>å’ŒåŒ…å«è¡Œè¡¨è¾¾å¼åˆ†ç‰‡ã€æ—¶é—´èŒƒå›´åˆ†ç‰‡åœ¨å†…çš„<code>æ ‡å‡†åˆ†ç‰‡ç®—æ³•</code>ä»¥åŠ<code>å¤åˆåˆ†ç‰‡ç®—æ³•</code>å’Œ<code>Hint åˆ†ç‰‡ç®—æ³•</code>ã€‚æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åˆ†ç‰‡ç®—æ³•ï¼Œé€šè¿‡é…ç½®åˆ†ç‰‡ç­–ç•¥ç±»å‹å’Œç®—æ³•ç±»åï¼Œå®ç°è‡ªå®šä¹‰æ‰©å±•ã€‚</p> <p>åˆ†å¸ƒå¼åºåˆ—ç®—æ³•åŒ…æ‹¬é›ªèŠ±ç®—æ³•å’Œ UUIDã€‚</p> <h2 id="é›†æˆ-spring-boot-admin-å®ç°åº”ç”¨ç®¡ç†å’Œç›‘æ§åŠŸèƒ½"><a href="#é›†æˆ-spring-boot-admin-å®ç°åº”ç”¨ç®¡ç†å’Œç›‘æ§åŠŸèƒ½" class="header-anchor">#</a> é›†æˆ Spring Boot Admin å®ç°åº”ç”¨ç®¡ç†å’Œç›‘æ§åŠŸèƒ½</h2> <h3 id="spring-boot-actuator-ä»‹ç»"><a href="#spring-boot-actuator-ä»‹ç»" class="header-anchor">#</a> Spring Boot Actuator ä»‹ç»</h3> <p>å½“æˆ‘ä»¬å°†åº”ç”¨ç¨‹åºæŠ•å…¥ç”Ÿäº§æ—¶ï¼ŒSpring Boot åŒ…å«äº†è®¸å¤šå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¹å…¶è¿›è¡Œç›‘æ§å’Œç®¡ç†çš„<code>ç”Ÿäº§å°±ç»ªåŠŸèƒ½</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ HTTP ç«¯ç‚¹æˆ– JMX æ¥ç®¡ç†å’Œç›‘æ§æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p> <p>Spring Boot Actuator æ¨¡å—æä¾›äº† Spring Boot çš„æ‰€æœ‰<code>ç”Ÿäº§å°±ç»ªåŠŸèƒ½</code>ï¼Œæˆ‘ä»¬é€šè¿‡æ·»åŠ  spring-boot-starter-actuator <code>Starter</code>ä¾èµ–æ¥å¯ç”¨è¿™äº›åŠŸèƒ½ã€‚</p> <p><code>ç«¯ç‚¹</code>ï¼ˆendpointsï¼‰è®©æˆ‘ä»¬å¯ä»¥ç›‘æ§åº”ç”¨ç¨‹åºå¹¶ä¸ä¹‹äº¤äº’ã€‚Spring Boot åŒ…å«è®¸å¤šå†…ç½®ç«¯ç‚¹ï¼Œå¹¶å…è®¸æˆ‘ä»¬æ·»åŠ è‡ªå·±çš„ç«¯ç‚¹ã€‚ä¾‹å¦‚ï¼Œhealth ç«¯ç‚¹æä¾›åŸºæœ¬çš„åº”ç”¨ç¨‹åºå¥åº·ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥å•ç‹¬<code>å¯ç”¨</code>æˆ–<code>ç¦ç”¨</code>æ¯ä¸€ä¸ªç«¯ç‚¹å¹¶é€šè¿‡ HTTP æˆ– JMX <code>å…¬å¼€</code>å®ƒä»¬ï¼ˆä½¿å®ƒä»¬å¯ä»¥è¿œç¨‹è®¿é—®ï¼‰ã€‚å½“ç«¯ç‚¹è¢«<code>å¯ç”¨</code>å’Œ<code>å…¬å¼€</code>æ—¶ï¼Œå®ƒè¢«è®¤ä¸ºæ˜¯<code>å¯ç”¨</code>çš„ï¼Œå†…ç½®ç«¯ç‚¹ä»…åœ¨å¯ç”¨æ—¶æ‰ä¼šè‡ªåŠ¨é…ç½®ã€‚</p> <p>å¤§å¤šæ•°åº”ç”¨ç¨‹åºé€‰æ‹©é€šè¿‡ HTTP å…¬å¼€ç«¯ç‚¹ï¼Œå…¶ä¸­ç«¯ç‚¹çš„ ID å’Œå‰ç¼€ /actuator è¢«æ˜ å°„åˆ°ä¸€ä¸ª URL åœ°å€ã€‚ä¾‹å¦‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œhealth ç«¯ç‚¹æ˜ å°„åˆ° /actuator/healthã€‚</p> <p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé™¤äº† shutdown ä¹‹å¤–çš„æ‰€æœ‰ç«¯ç‚¹éƒ½æ˜¯å¯ç”¨çš„ï¼Œå¦‚æœè¦é…ç½®ä¸€ä¸ªç«¯ç‚¹çš„å¯ç”¨ï¼Œéœ€è¦ä½¿ç”¨ <code>management.endpoint.&lt;id&gt;.enabled</code> é…ç½®å±æ€§ã€‚</p> <p>ç”±äºç«¯ç‚¹å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œæˆ‘ä»¬åº”è¯¥ä»”ç»†è€ƒè™‘ä½•æ—¶å…¬å¼€å®ƒä»¬ã€‚ä¸‹è¡¨æ˜¾ç¤ºäº†å†…ç½®ç«¯ç‚¹çš„é»˜è®¤å…¬å¼€æƒ…å†µï¼š</p> <table><thead><tr><th style="text-align:left;">ID</th> <th style="text-align:left;">JMX</th> <th style="text-align:left;">Web</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>auditevents</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>beans</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>caches</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>conditions</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>configprops</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>env</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>flyway</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>health</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">Yes</td></tr> <tr><td style="text-align:left;"><code>heapdump</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>httptrace</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>info</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>integrationgraph</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>jolokia</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>logfile</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>loggers</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>liquibase</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>metrics</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>mappings</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>prometheus</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>quartz</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>scheduledtasks</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>sessions</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>shutdown</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>startup</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>threaddump</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr></tbody></table> <p>å¦‚æœæƒ³è¦æ›´æ”¹å…¬å¼€çš„ç«¯ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç‰¹å®šæŠ€æœ¯çš„ <code>include</code>å’Œ<code>exclude</code>é…ç½®å±æ€§ï¼š</p> <table><thead><tr><th style="text-align:left;">Property</th> <th style="text-align:left;">Default</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>management.endpoints.jmx.exposure.exclude</code></td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.jmx.exposure.include</code></td> <td style="text-align:left;"><code>*</code></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.web.exposure.exclude</code></td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.web.exposure.include</code></td> <td style="text-align:left;"><code>health</code></td></tr></tbody></table> <p>include å±æ€§åˆ—å‡ºéœ€è¦å…¬å¼€çš„ç«¯ç‚¹ IDã€‚exclude å±æ€§åˆ—å‡ºä¸åº”å…¬å¼€çš„ç«¯ç‚¹ IDï¼Œexclude ä¼˜å…ˆäº includeã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç«¯ç‚¹ ID åˆ—è¡¨æ¥é…ç½® include å’Œ exclude å±æ€§ã€‚</p> <p><code>åº”ç”¨ç¨‹åºä¿¡æ¯</code>ï¼ˆApplication Informationï¼‰å…¬å¼€äº† ApplicationContext ä¸­å®šä¹‰çš„æ‰€æœ‰ InfoContributor bean æ”¶é›†çš„å„ç§ä¿¡æ¯ã€‚ Spring Boot åŒ…å«è®¸å¤šè‡ªåŠ¨é…ç½®çš„ InfoContributor beanï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„ InfoContributor beanã€‚</p> <p>åœ¨é€‚å½“çš„æ—¶å€™ï¼ŒSpring Boot ä¼šè‡ªåŠ¨é…ç½®ä»¥ä¸‹çš„ InfoContributor beanï¼š</p> <table><thead><tr><th style="text-align:left;">ID</th> <th style="text-align:left;">Bean</th> <th style="text-align:left;">æè¿°</th> <th style="text-align:left;">å…ˆå†³æ¡ä»¶</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>build</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/BuildInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>BuildInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å…¬å¼€æ„å»ºä¿¡æ¯</td> <td style="text-align:left;">èµ„æºæ–‡ä»¶<code>META-INF/build-info.properties</code> å­˜åœ¨</td></tr> <tr><td style="text-align:left;"><code>env</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/EnvironmentInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>EnvironmentInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å…¬å¼€æ‰€æœ‰ä»¥ <code>info.</code>å¼€å¤´çš„ç¯å¢ƒå±æ€§</td> <td style="text-align:left;">æ— </td></tr> <tr><td style="text-align:left;"><code>git</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/GitInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>GitInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å…¬å¼€ git ä¿¡æ¯</td> <td style="text-align:left;">èµ„æºæ–‡ä»¶<code>git.properties</code> å­˜åœ¨</td></tr> <tr><td style="text-align:left;"><code>java</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/JavaInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>JavaInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å…¬å¼€ Java è¿è¡Œæ—¶ä¿¡æ¯</td> <td style="text-align:left;">æ— </td></tr> <tr><td style="text-align:left;"><code>os</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/OsInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>OsInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å…¬å¼€æ“ä½œç³»ç»Ÿä¿¡æ¯</td> <td style="text-align:left;">æ— </td></tr></tbody></table> <p><code>management.info.&lt;id&gt;.enabled</code> å±æ€§æ§åˆ¶å•ä¸ª InfoContributor bean æ˜¯å¦å¯ç”¨ï¼Œä¸åŒçš„ InfoContributor bean å¯¹æ­¤å±æ€§æœ‰ä¸åŒçš„é»˜è®¤å€¼ï¼Œè¿™å–å†³äºå®ƒä»¬çš„å…ˆå†³æ¡ä»¶å’Œå®ƒä»¬å…¬å¼€ä¿¡æ¯çš„æ€§è´¨ã€‚é»˜è®¤æƒ…å†µä¸‹ envã€java å’Œ os è¢«ç¦ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å…¶ <code>management.info.&lt;id&gt;.enabled</code> å±æ€§è®¾ç½®ä¸º true æ¥å¼€å¯ã€‚build å’Œ git é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å…¶ <code>management.info.&lt;id&gt;.enabled</code> å±æ€§è®¾ç½®ä¸º false æ¥ç¦ç”¨ã€‚</p> <p><code>å¥åº·ä¿¡æ¯</code>ï¼ˆHealth Informationï¼‰å¯ä»¥ç”¨æ¥æ£€æŸ¥æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºçŠ¶æ€ã€‚å½“ç”Ÿäº§ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ï¼Œç›‘æ§è½¯ä»¶ç»å¸¸ä½¿ç”¨å®ƒæ¥æé†’æŸäººã€‚</p> <p>å¥åº·ä¿¡æ¯æ˜¯ä» HealthContributorRegistry çš„å†…å®¹ä¸­æ”¶é›†çš„ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰åœ¨ ApplicationContext ä¸­å®šä¹‰çš„ HealthContributor å®ä¾‹ï¼‰ã€‚ Spring Boot åŒ…å«è®¸å¤šè‡ªåŠ¨é…ç½®çš„ HealthContributorï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„ã€‚</p> <p>åœ¨é€‚å½“çš„æ—¶å€™ï¼ŒSpring Boot ä¼šè‡ªåŠ¨é…ç½®ä»¥ä¸‹çš„ HealthIndicator beanï¼š</p> <table><thead><tr><th style="text-align:left;">Key</th> <th style="text-align:left;">Bean</th> <th style="text-align:left;">æè¿°</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>cassandra</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/cassandra/CassandraDriverHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>CassandraDriverHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Cassandra æ•°æ®åº“æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>couchbase</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/couchbase/CouchbaseHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>CouchbaseHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Couchbase é›†ç¾¤æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>db</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/jdbc/DataSourceHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>DataSourceHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥æ˜¯å¦å¯ä»¥è·å¾—<code>DataSource</code>è¿æ¥ã€‚</td></tr> <tr><td style="text-align:left;"><code>diskspace</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/system/DiskSpaceHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>DiskSpaceHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦ä¸è¶³ã€‚</td></tr> <tr><td style="text-align:left;"><code>elasticsearch</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/elasticsearch/ElasticsearchRestHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>ElasticsearchRestHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Elasticsearch é›†ç¾¤æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>hazelcast</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/hazelcast/HazelcastHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>HazelcastHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Hazelcast æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>influxdb</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/influx/InfluxDbHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>InfluxDbHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ InfluxDB æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>jms</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/jms/JmsHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>JmsHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ JMS ä»£ç†æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>ldap</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/ldap/LdapHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>LdapHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ LDAP æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>mail</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mail/MailHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>MailHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥é‚®ä»¶æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>mongo</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mongo/MongoHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>MongoHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Mongo æ•°æ®åº“æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>neo4j</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/neo4j/Neo4jHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>Neo4jHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Neo4j æ•°æ®åº“æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>ping</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/health/PingHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>PingHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">å§‹ç»ˆä»¥ <code>UP</code>å“åº”ã€‚</td></tr> <tr><td style="text-align:left;"><code>rabbit</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/amqp/RabbitHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>RabbitHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Rabbit æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr> <tr><td style="text-align:left;"><code>redis</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/redis/RedisHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>RedisHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">æ£€æŸ¥ Redis æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</td></tr></tbody></table> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>management.health.&lt;key&gt;.enabled</code> é…ç½®æ¥å¯ç”¨æˆ–ç¦ç”¨é€‰å®šçš„å¥åº·æ£€æŸ¥ã€‚</p> <h3 id="spring-boot-admin-ä»‹ç»"><a href="#spring-boot-admin-ä»‹ç»" class="header-anchor">#</a> Spring Boot Admin ä»‹ç»</h3> <p>Spring Boot Admin æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å’Œç›‘æ§æˆ‘ä»¬ Spring Boot åº”ç”¨ç¨‹åºçš„å¼€æºé¡¹ç›®ï¼Œç”±æœåŠ¡ç«¯ï¼ˆSpring Boot Admin Serverï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆSpring Boot Admin Clientï¼‰ä¸¤éƒ¨åˆ†æ„æˆã€‚</p> <p>åº”ç”¨ç¨‹åºä½¿ç”¨ Spring Boot Admin Clientï¼ˆé€šè¿‡ HTTPï¼‰æˆ–ä½¿ç”¨ Spring Cloud è‡ªåŠ¨å‘ç°ï¼ˆä¾‹å¦‚ Eurekaã€Consulã€Nacos ç­‰ï¼‰å‘ Spring Boot Admin Server æ³¨å†Œã€‚</p> <p>Spring Boot Admin Server UI æ˜¯æ„å»ºåœ¨ Spring Boot Actuator ç«¯ç‚¹ä¹‹ä¸Šçš„ Vue.js åº”ç”¨ç¨‹åºï¼ŒSpring Boot Admin Server çš„ç›‘æ§ä¿¡æ¯å‡æ¥è‡ª Spring Boot Actuator ç«¯ç‚¹ï¼Œå¹¶ä¸”é€šè¿‡ç«¯ç‚¹æ¥ç®¡ç†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p> <h3 id="æ„å»º-spring-boot-admin-server"><a href="#æ„å»º-spring-boot-admin-server" class="header-anchor">#</a> æ„å»º Spring Boot Admin Server</h3> <ol><li>ä½¿ç”¨ <a href="https://start.spring.io/" target="_blank" rel="noopener noreferrer">Spring Initializr<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> åˆå§‹åŒ–ä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œå¹¶åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0-M1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>åœ¨ application.properties é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  Spring Security ç”¨æˆ·åã€å¯†ç çš„é…ç½®å±æ€§ï¼Œç”¨äºç™»å½• Spring Boot Admin Serverï¼š</li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">spring.security.user.name</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>
<span class="token key attr-name">spring.security.user.password</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>
</code></pre></div><ol start="3"><li>åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  @EnableAdminServer æ³¨è§£ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableAdminServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitorApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MonitorApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>æ·»åŠ  Spring Security é…ç½®ç±»ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Spring Security é…ç½®
 *
 * @author xiongxiaoyang
 * @date 2022/6/8
 */</span>
<span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecuritySecureConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AdminServerProperties</span> adminServer<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityProperties</span> security<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecuritySecureConfig</span><span class="token punctuation">(</span><span class="token class-name">AdminServerProperties</span> adminServer<span class="token punctuation">,</span> <span class="token class-name">SecurityProperties</span> security<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>adminServer <span class="token operator">=</span> adminServer<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>security <span class="token operator">=</span> security<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span> successHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        successHandler<span class="token punctuation">.</span><span class="token function">setTargetUrlParameter</span><span class="token punctuation">(</span><span class="token string">&quot;redirectTo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        successHandler<span class="token punctuation">.</span><span class="token function">setDefaultTargetUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>
                        authorizeRequests <span class="token operator">-&gt;</span> authorizeRequests
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/assets/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/health&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span>
                        formLogin <span class="token operator">-&gt;</span> formLogin
                                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>successHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>
                        logout <span class="token operator">-&gt;</span> logout<span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>csrf <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">csrfTokenRepository</span><span class="token punctuation">(</span><span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">.</span><span class="token function">withHttpOnlyFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ignoringRequestMatchers</span><span class="token punctuation">(</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/instances&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/instances/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span>rememberMe <span class="token operator">-&gt;</span> rememberMe
                        <span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">1209600</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Required to provide UserDetailsService for &quot;remember functionality&quot;
     * */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span>security<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;{noop}&quot;</span> <span class="token operator">+</span> security<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶ï¼Œè¿è¡Œåº”ç”¨ç¨‹åºï¼Œæµè§ˆå™¨ä¸­è®¿é—® 8080 ç«¯å£ï¼Œè¾“å…¥ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç å³å¯è¿›å…¥ Spring Boot Admin Server æ§åˆ¶å°ç®¡ç†å’Œç›‘æ§æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p> <h3 id="é€šè¿‡-spring-boot-admin-client-æ³¨å†Œ-novel-æœåŠ¡"><a href="#é€šè¿‡-spring-boot-admin-client-æ³¨å†Œ-novel-æœåŠ¡" class="header-anchor">#</a> é€šè¿‡ Spring Boot Admin Client æ³¨å†Œ novel æœåŠ¡</h3> <ol><li>åœ¨æˆ‘ä»¬ novel é¡¹ç›®ä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0-M1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>åœ¨ novel é¡¹ç›®çš„ application.yml é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹é…ç½®ï¼š</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># Spring Boot åº”ç”¨ç®¡ç†å’Œç›‘æ§</span>
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># æ˜¯å¦å¼€å¯ Spring Boot Admin å®¢æˆ·ç«¯</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># Spring Boot Admin æœåŠ¡ç«¯æ³¨å†Œåœ°å€</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token comment"># Spring Boot Admin æœåŠ¡ç«¯è®¤è¯ç”¨æˆ·å</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> novel
        <span class="token comment"># Spring Boot Admin æœåŠ¡ç«¯è®¤è¯å¯†ç </span>
        <span class="token key atrule">password</span><span class="token punctuation">:</span> novel
        <span class="token key atrule">instance</span><span class="token punctuation">:</span>
          <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
            <span class="token comment"># SBA Client</span>
            <span class="token key atrule">user.name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.security.user.name<span class="token punctuation">}</span>
            <span class="token key atrule">user.password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.security.user.password<span class="token punctuation">}</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token comment"># Actuator ç«¯ç‚¹ä¿æŠ¤é…ç½®</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ENDPOINT_ADMIN
      <span class="token key atrule">password</span><span class="token punctuation">:</span> ENDPOINT_ADMIN
      <span class="token key atrule">roles</span><span class="token punctuation">:</span> ENDPOINT_ADMIN

<span class="token comment"># Actuator ç«¯ç‚¹ç®¡ç†</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token comment"># ç«¯ç‚¹å…¬å¼€é…ç½®</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token comment"># é€šè¿‡ HTTP å…¬å¼€çš„ Web ç«¯ç‚¹</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment"># å…¬å¼€æ‰€æœ‰çš„ Web ç«¯ç‚¹</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>

  <span class="token comment"># ç«¯ç‚¹å¯ç”¨é…ç½®</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">logfile</span><span class="token punctuation">:</span>
      <span class="token comment"># å¯ç”¨è¿”å›æ—¥å¿—æ–‡ä»¶å†…å®¹çš„ç«¯ç‚¹</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># å¤–éƒ¨æ—¥å¿—æ–‡ä»¶è·¯å¾„</span>
      <span class="token key atrule">external-file</span><span class="token punctuation">:</span> logs/novel.log

  <span class="token key atrule">info</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># å…¬å¼€æ‰€æœ‰ä»¥ info. å¼€å¤´çš„ç¯å¢ƒå±æ€§</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">health</span><span class="token punctuation">:</span>
    <span class="token key atrule">rabbit</span><span class="token punctuation">:</span>
      <span class="token comment"># å…³é—­ rabbitmq çš„å¥åº·æ£€æŸ¥</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
      <span class="token comment"># å…³é—­ elasticsearch çš„å¥åº·æ£€æŸ¥</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

</code></pre></div><ol start="3"><li>novel é¡¹ç›®å¯åŠ¨ç±»ä¸­æ·»åŠ  Spring Boot Actuator ç«¯ç‚¹ä¿æŠ¤çš„ Spring Security é…ç½®ï¼š</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span><span class="token class-name">EndpointRequest</span><span class="token punctuation">.</span><span class="token function">toAnyEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>requests <span class="token operator">-&gt;</span> requests<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;ENDPOINT_ADMIN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ­¤æ—¶ï¼Œå¯åŠ¨ novel é¡¹ç›®ï¼Œç™»å½• Spring Boot Admin Server æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç›‘æ§ä¿¡æ¯ï¼š</p> <p><img src="/img/novel/springbootadmin1.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin2.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin3.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin4.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin5.png" alt="Spring Boot Admin"></p> <p>è¸©å‘ï¼šåœ¨å¯åŠ¨ Spring Boot Admin Server ä¹‹å‰æœ‰ä¸ª node ç¨‹åºç›‘å¬äº† 8080 ç«¯å£æ²¡æœ‰é‡Šæ”¾ï¼Œç„¶åå¯åŠ¨ Spring Boot Admin Serverï¼ˆé»˜è®¤ä¹Ÿæ˜¯ 8080 ç«¯å£ï¼‰ï¼Œæ­¤æ—¶æµè§ˆå™¨ä¸­å¯ä»¥æ­£å¸¸è®¿é—®åˆ° Spring Boot Admin Server çš„ç•Œé¢ï¼Œä½†æ˜¯ novel æœåŠ¡æ— æ³•æ³¨å†Œåˆ° Spring Boot Admin Server ä¸Šï¼Œæç¤º404 é”™è¯¯ã€‚åæ¥å‘ç° novel æœåŠ¡çš„æ³¨å†Œè¢«ç›‘å¬ 8080 ç«¯å£çš„ node ç¨‹åºå¤„ç†äº†ï¼Œå…³é—­è¯¥ node ç¨‹åºå³å¯æ­£å¸¸æ³¨å†Œã€‚ è¯¥æœºåˆ¶è¯·å‚è€ƒ <a href="https://segmentfault.com/a/1190000014701988" target="_blank" rel="noopener noreferrer">Node.Js çš„ç«¯å£é‡ç”¨<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <h2 id="ä½¿ç”¨-docker-compose-ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒ"><a href="#ä½¿ç”¨-docker-compose-ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒ" class="header-anchor">#</a> ä½¿ç”¨ Docker Compose ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒ</h2> <ol><li>Docker Compose å®‰è£…ã€‚ï¼ˆé™¤äº†ç¬¬ä¸€æ­¥éœ€è¦æ ¹æ®è‡ªå·±çš„å¹³å°å»å®‰è£… Docker Compose ä»¥å¤–ï¼Œå…¶å®ƒæ­¥éª¤éƒ½ä¸€æ ·ï¼‰</li></ol> <p>åœ¨ Ubuntu ä¸‹æ‰§è¡Œå¦‚ä¸‹çš„å®‰è£…å‘½ä»¤ï¼š</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-y</span>
</code></pre></div><p>æŸ¥çœ‹ Docker Compose å’Œ Docker çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">docker-compose</span> version

<span class="token function">docker</span> <span class="token parameter variable">--version</span>

<span class="token function">docker</span> version
</code></pre></div><ol start="2"><li>åˆ›å»º <code>.env</code> æ–‡ä»¶ï¼Œç”¨æ¥è®¾ç½®å®¹å™¨ç¼–æ’çš„ç¯å¢ƒå˜é‡ã€‚</li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># MYSQL é…ç½®</span>
<span class="token key attr-name">MYSQL_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.0</span>
<span class="token key attr-name">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>

<span class="token comment"># Redis é…ç½®</span>
<span class="token key attr-name">REDIS_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">7.0</span>
<span class="token key attr-name">REDIS_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>

<span class="token comment"># RabbitMQ é…ç½®</span>
<span class="token key attr-name">RABBITMQ_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">3-management</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_USER</span><span class="token punctuation">=</span><span class="token value attr-value">xxyopen</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_PASS</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_VHOST</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>

<span class="token comment"># Elasticsearch é…ç½®</span>
<span class="token key attr-name">ELASTIC_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.6.2</span>
<span class="token comment"># 'elastic' è´¦æˆ·çš„å¯†ç  (è‡³å°‘ 6 ä¸ªå­—ç¬¦)</span>
<span class="token key attr-name">ELASTIC_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">Fy2JWjJ1hcO2mi1USFL1</span>
<span class="token comment"># 'kibana_system' è´¦å·çš„å¯†ç  (è‡³å°‘ 6 ä¸ªå­—ç¬¦)</span>
<span class="token key attr-name">KIBANA_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">5JbbVsW9TkYcJu9Y9</span>

<span class="token comment"># Kibana é…ç½®</span>
<span class="token key attr-name">KIBANA_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.6.2</span>

<span class="token comment"># XXL-JOB é…ç½®</span>
<span class="token key attr-name">XXLJOB_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">2.3.1</span>
<span class="token key attr-name">XXLJOB_ACCESSTOKEN</span><span class="token punctuation">=</span><span class="token value attr-value">123</span>

</code></pre></div><ol start="3"><li>åˆ›å»º Docker Compose çš„å®¹å™¨ç¼–æ’æ–‡ä»¶ <code>docker-compose.yml</code>ã€‚</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.9'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">novel-mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>$<span class="token punctuation">{</span>MYSQL_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=$<span class="token punctuation">{</span>MYSQL_ROOT_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;/data/docker/mysql/data:/var/lib/mysql&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;/data/docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>max_allowed_packet=100M
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;3306:3306&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>redis
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>$<span class="token punctuation">{</span>REDIS_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>redis
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>save 60 1 <span class="token punctuation">-</span><span class="token punctuation">-</span>loglevel warning <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass &quot;$<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">}</span>&quot;
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;6379:6379&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>rabbitmq
    <span class="token key atrule">image</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">:</span>$<span class="token punctuation">{</span>RABBITMQ_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>rabbitmq
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_USER=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_USER<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_PASS=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_PASS<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_VHOST=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_VHOST<span class="token punctuation">}</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;15672:15672&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5672:5672&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-elasticsearch-setup</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>$<span class="token punctuation">{</span>ELASTIC_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">&quot;0&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
      bash -c '
        echo &quot;Waiting for Elasticsearch availability&quot;;
        until curl -s http://novel-elasticsearch:9200 | grep -q &quot;missing authentication credentials&quot;; do sleep 30; done;
        echo &quot;Setting kibana_system password&quot;;
        until curl -s -X POST -u &quot;elastic:${ELASTIC_PASSWORD}&quot; -H &quot;Content-Type: application/json&quot; http://novel-elasticsearch:9200/_security/user/kibana_system/_password -d &quot;{\&quot;password\&quot;:\&quot;${KIBANA_PASSWORD}\&quot;}&quot; | grep -q &quot;^{}&quot;; do sleep 10; done;
        echo &quot;All done!&quot;;
      '</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>$<span class="token punctuation">{</span>ELASTIC_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms125m -Xmx512m&quot;</span>
      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node
      <span class="token punctuation">-</span> ELASTIC_PASSWORD=$<span class="token punctuation">{</span>ELASTIC_PASSWORD<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> KIBANA_PASSWORD=$<span class="token punctuation">{</span>KIBANA_PASSWORD<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> xpack.security.http.ssl.enabled=false
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>kibana
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kibana<span class="token punctuation">:</span>$<span class="token punctuation">{</span>KIBANA_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>kibana
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ELASTICSEARCH_HOSTS=http<span class="token punctuation">:</span>//novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> ELASTICSEARCH_USERNAME=kibana_system
      <span class="token punctuation">-</span> ELASTICSEARCH_PASSWORD=$<span class="token punctuation">{</span>KIBANA_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-xxl-job-admin</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">image</span><span class="token punctuation">:</span> xuxueli/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin<span class="token punctuation">:</span>$<span class="token punctuation">{</span>XXLJOB_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PARAMS=<span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.url=jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//novel<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span>3306/xxl_job<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.username=root <span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.password=$<span class="token punctuation">{</span>MYSQL_ROOT_PASSWORD<span class="token punctuation">}</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>xxl.job.accessToken=$<span class="token punctuation">{</span>XXLJOB_ACCESSTOKEN<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> JAVA_OPTS=<span class="token punctuation">-</span>Xmx512m
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin/data/applogs<span class="token punctuation">:</span>/data/applogs
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8080:8080&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">novelnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre></div><blockquote><p>æ³¨æ„ï¼šElasticsearch å®¹å™¨æŒ‚è½½æœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶æ—¶ï¼Œéœ€è¦ä¿®æ”¹ç›®å½•æˆ–æ–‡ä»¶çš„è¯»å†™æƒé™ï¼Œå¦åˆ™å¯åŠ¨ä¸æˆåŠŸã€‚å®˜æ–¹åŸæ–‡å¦‚ä¸‹ï¼š</p> <p>If you are bind-mounting a local directory or file, it must be readable by the elasticsearch user. In addition, this user must have write access to the data and log dirs. A good strategy is to grant group access to gid 1000 or 0 for the local directory.</p> <p>For example, to prepare a local directory for storing data through a bind-mount:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> esdatadir
<span class="token function">chmod</span> g+rwx esdatadir
<span class="token function">chgrp</span> <span class="token number">1000</span> esdatadir
</code></pre></div></blockquote> <ol start="4"><li>åœ¨åå°è¿è¡Œæ‰€æœ‰ç¼–æ’æ–‡ä»¶ä¸­çš„å®¹å™¨ã€‚</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre></div><ol start="5"><li>ä½¿ç”¨ <code>.env</code> ç¯å¢ƒæ–‡ä»¶ä¸­é…ç½®çš„ <code>elastic</code> è´¦å·å¯†ç æ¥ç™»å½• kibana æ§åˆ¶å°ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>elastic
Fy2JWjJ1hcO2mi1USFL1
</code></pre></div><blockquote><p><strong>æ³¨æ„ï¼šéœ€è¦å…ˆå°† xxl-job çš„æ•°æ®åº“æ–‡ä»¶å¯¼å…¥ MySQL åï¼Œxxl-job-admin æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚</strong></p></blockquote> <h2 id="é›†æˆ-flyway-å®ç°æ•°æ®åº“çš„ç‰ˆæœ¬ç®¡ç†"><a href="#é›†æˆ-flyway-å®ç°æ•°æ®åº“çš„ç‰ˆæœ¬ç®¡ç†" class="header-anchor">#</a> é›†æˆ Flyway å®ç°æ•°æ®åº“çš„ç‰ˆæœ¬ç®¡ç†</h2> <p>ä½ æ˜¯å¦æ—¶å¸¸ä¸ºä»¥ä¸‹é—®é¢˜æ‰€å›°æ‰°ï¼š</p> <ul><li>æˆ‘çš„æ•°æ®åº“å½“å‰å¤„äºå“ªä¸ªç‰ˆæœ¬ï¼Ÿ</li> <li>å“ªäº› SQL è„šæœ¬å·²ç»è¢«æ‰§è¡Œï¼Ÿ</li> <li>å¦‚ä½•é«˜æ•ˆåœ°åˆ›å»ºæ–°çš„æ•°æ®åº“å®ä¾‹ï¼Ÿ</li></ul> <p>æ•°æ®åº“è¿ç§»ä¸€ç›´æ˜¯ Java å¼€å‘è€…åœ¨è½¯ä»¶å¼€å‘å‘¨æœŸä¸­é¢ä¸´çš„é‡è¦æŒ‘æˆ˜ä¹‹ä¸€ã€‚éšç€ä¸šåŠ¡éœ€æ±‚çš„ä¸æ–­æ‰©å±•å’ŒåŠŸèƒ½çš„æŒç»­è¿­ä»£ï¼Œæ•°æ®åº“ç»“æ„é€šå¸¸éœ€è¦è¿›è¡Œç›¸åº”çš„è°ƒæ•´å’Œä¼˜åŒ–ã€‚ä¸ºäº†ä¿éšœæ•°æ®åº“ä¸åº”ç”¨ç¨‹åºç‰ˆæœ¬ä¹‹é—´çš„ä¸€è‡´æ€§ï¼ŒåŒæ—¶ç®€åŒ–æ•°æ®åº“å˜æ›´çš„ç®¡ç†æµç¨‹ï¼Œ<a href="https://github.com/flyway/flyway" target="_blank" rel="noopener noreferrer">Flyway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> è¿™ä¸€å·¥å…·åº”è¿è€Œç”Ÿï¼Œæˆä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜çš„å¾—åŠ›åŠ©æ‰‹ã€‚</p> <p>Flyway å¼•å…¥äº†æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶çš„æ¦‚å¿µï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿè½»æ¾å®ç°ä»ä»»æ„ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬å…¨æ–°çš„ç©ºç™½æ•°æ®åº“ï¼‰åˆ°æœ€æ–°æ•°æ®åº“çŠ¶æ€çš„è¿ç§»ã€‚æ— è®ºä½ æ˜¯ç»éªŒä¸°å¯Œçš„æ•°æ®åº“ç®¡ç†å‘˜è¿˜æ˜¯å…·å¤‡åŸºç¡€ SQL çŸ¥è¯†çš„å¼€å‘è€…ï¼ŒFlyway çš„ç›´è§‚æ€§å’Œæ˜“ç”¨æ€§éƒ½ä½¿å¾—æ•°æ®åº“è¿ç§»è¿‡ç¨‹å˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚å› æ­¤ï¼ŒFlyway åœ¨ Spring Boot å›¢é˜Ÿä¸­å¤‡å—æ¨å´‡ï¼Œæˆä¸ºäº†è®¸å¤šé¡¹ç›®ä¸­ä¸å¯æˆ–ç¼ºçš„æ•°æ®åº“è¿ç§»å·¥å…·ã€‚</p> <p>ç”±äº Spring Boot å®˜æ–¹å·²ç»å¯¹ Flyway æ•°æ®åº“è¿ç§»å·¥å…·è¿›è¡Œäº†é›†æˆï¼Œå› æ­¤åœ¨ Spring Boot é¡¹ç›®ä¸­åˆ©ç”¨ Flyway è¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å˜å¾—æä¸ºç®€ä¾¿ï¼š</p> <p>1.æ·»åŠ  Flyway çš„ Maven ä¾èµ–é¡¹ã€‚</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2.åˆ›å»ºè¿ç§»è„šæœ¬ç›®å½•<code>src/main/resources/db/migration</code>ã€‚</p> <p>Spring Boot é…ç½®çš„é»˜è®¤è¿ç§»è„šæœ¬ç›®å½•æ˜¯<code>src/main/resources/db/migration</code>ï¼Œå¯ä»¥é€šè¿‡<code>spring.flyway.locations</code>é…ç½®é¡¹è¿›è¡Œä¿®æ”¹ã€‚</p> <p>3.åœ¨è¿ç§»è„šæœ¬ç›®å½•ä¸‹é¢åˆ›å»ºè¿ç§»è„šæœ¬ã€‚</p> <p>Flyway å…è®¸æˆ‘ä»¬é€šè¿‡ç¼–å†™ç®€å•çš„ SQL è„šæœ¬æ¥å®šä¹‰æ•°æ®åº“çš„å˜æ›´é›†ã€‚è¿™äº›è„šæœ¬æŒ‰ç…§ç‰¹å®šçš„å‘½åè§„åˆ™è¿›è¡Œæ’åºå’Œæ‰§è¡Œï¼Œä»è€Œç¡®ä¿æ•°æ®åº“è¿ç§»çš„é¡ºåºæ€§å’Œå¯è¿½è¸ªæ€§ã€‚</p> <p>è¿ç§»è„šæœ¬æœ‰ä¸¤ç§å‘½åè§„åˆ™ï¼š</p> <ul><li><code>V&lt;version&gt;__&lt;description&gt;.sql</code>ï¼šè¿™äº›æ˜¯å†…å®¹ä¸å¯ä»¥å˜æ›´ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡çš„è¿ç§»è„šæœ¬ï¼ŒæŒ‰ç…§ç‰ˆæœ¬å·ä»å°åˆ°å¤§æ‰§è¡Œã€‚</li> <li><code>R__&lt;description&gt;.sql</code>ï¼šè¿™äº›æ˜¯å†…å®¹å¯ä»¥å˜æ›´ä¸”æ”¯æŒé‡å¤æ‰§è¡Œçš„è¿ç§»è„šæœ¬ã€‚Flyway èƒ½å¤Ÿç²¾å‡†åœ°è¯†åˆ«è„šæœ¬å†…å®¹æ˜¯å¦æœ‰æ‰€å˜åŠ¨ï¼Œå¹¶åœ¨æ£€æµ‹åˆ°ä»»ä½•å˜åŠ¨æ—¶è‡ªåŠ¨é‡å¤æ‰§è¡Œç›¸åº”çš„è„šæœ¬ã€‚ä¾‹å¦‚ï¼ŒR_novel_data.sql å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¸“é—¨è®¾è®¡çš„è„šæœ¬ï¼Œå®ƒè´Ÿè´£å®šæœŸå‘æ•°æ®åº“ä¸­æ’å…¥æ–°çš„å°è¯´æµ‹è¯•æ•°æ®ã€‚ä¸ºäº†æœ‰æ•ˆç®¡ç†è„šæœ¬æ–‡ä»¶çš„æ•°é‡å’Œå¤§å°ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ç§ç­–ç•¥ï¼Œå³æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½ä¼šç”¨æ–°çš„æ’å…¥è„šæœ¬è¦†ç›–æ‰æ—§çš„æ’å…¥è„šæœ¬ï¼Œä»è€Œä¿æŒæ•°æ®æ›´æ–°çš„åŒæ—¶ï¼Œä¹Ÿä¿è¯äº†è„šæœ¬æ–‡ä»¶çš„ç®€æ´å’Œé«˜æ•ˆã€‚</li></ul> <div align="center"><img src="/img/novel/flyway1.png"></div> <p>4.åœ¨ IntelliJ IDEA ä¸­å¯åŠ¨ novel é¡¹ç›®æ—¶ï¼Œæ§åˆ¶å°ä¼šæ¸…æ™°åœ°æ˜¾ç¤º Flyway çš„è¿ç§»æ—¥å¿—ã€‚Flyway ä¼šæ™ºèƒ½åœ°æ£€æµ‹å°šæœªåº”ç”¨çš„æ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œå¹¶æŒ‰ç…§å…¶ç‰ˆæœ¬å·çš„é¡ºåºè‡ªåŠ¨æ‰§è¡Œè¿™äº›è„šæœ¬ï¼Œä»è€Œç¡®ä¿æ•°æ®åº“ç»“æ„çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ç”±äºè¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡å¯åŠ¨é¡¹ç›®ï¼ŒFlyway å·²ç»è¯†åˆ«åˆ°æ‰€æœ‰å¿…è¦çš„è¿ç§»éƒ½å·²æˆåŠŸåº”ç”¨ï¼Œå› æ­¤å®ƒä¸ä¼šå†æ¬¡æ‰§è¡Œè¿™äº›è„šæœ¬ï¼Œä»è€Œé¿å…äº†ä¸å¿…è¦çš„é‡å¤æ“ä½œã€‚è¿™ç§æœºåˆ¶å¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ï¼Œå¹¶ç¡®ä¿äº†æ•°æ®åº“è¿ç§»è¿‡ç¨‹çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p> <div align="center"><img src="/img/novel/flyway2.png"></div> <p>å½“ä½ æ£€æŸ¥æ•°æ®åº“æ—¶ï¼Œä¼šæ³¨æ„åˆ°å­˜åœ¨ä¸€ä¸ªåä¸º flyway_schema_history çš„è‡ªåŠ¨ç”Ÿæˆæ•°æ®è¡¨ã€‚è¿™å¼ è¡¨è¯¦ç»†è®°å½•äº† Flyway æ‰€æ‰§è¡Œçš„æ‰€æœ‰è¿ç§»æ“ä½œï¼ŒåŒ…æ‹¬æ¯æ¬¡è¿ç§»çš„è¯¦ç»†ä¿¡æ¯å’ŒçŠ¶æ€ã€‚é€šè¿‡æŸ¥é˜…è¿™å¼ è¡¨ï¼Œä½ å¯ä»¥æ¸…æ™°åœ°è¿½è¸ªåˆ°æ•°æ®åº“ç»“æ„çš„æ¼”å˜å†ç¨‹ï¼Œå¹¶éªŒè¯è¿ç§»åçš„æ•°æ®è¡¨ç»“æ„æ˜¯å¦å·²æ­£ç¡®åº”ç”¨ã€‚è¿™ç§è¯¦å°½çš„è®°å½•æœºåˆ¶ä¸ºä½ æä¾›äº†å¯¹æ•°æ®åº“å˜æ›´çš„æ·±å…¥æ´å¯Ÿå’Œå¼ºå¤§çš„å®¡è®¡èƒ½åŠ›ã€‚</p> <div align="center"><img src="/img/novel/flyway3.png"></div> <p>å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ Flyway æä¾›çš„å‘½ä»¤è¡Œå·¥å…·æˆ– API æ¥éªŒè¯è¿ç§»çš„æ­£ç¡®æ€§ï¼Œç”šè‡³åœ¨å¿…è¦æ—¶è¿›è¡Œå›æ»šæ“ä½œã€‚</p> <p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒFlyway åœ¨ novel é¡¹ç›®ä¸­å¸®åŠ©æˆ‘ä»¬å®ç°äº†æ•°æ®åº“è¿ç§»çš„ç‰ˆæœ¬ç®¡ç†å’Œè‡ªåŠ¨è¿ç§»ï¼Œå¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡å’Œæ•°æ®åº“å˜æ›´çš„å¯æ§æ€§ã€‚</p> <p>éšç€æŒç»­äº¤ä»˜ç­‰æŠ€æœ¯çš„æ™®åŠï¼Œæ•°æ®åº“è¿ç§»çš„è‡ªåŠ¨åŒ–å·²ç»æˆä¸ºè®¸å¤šè½¯ä»¶å›¢é˜Ÿä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚Flyway å¯ä»¥ä¸ CI/CD å·¥å…·é›†æˆï¼Œå¦‚ Jenkinsã€Travis CIã€GitLab CI ç­‰ï¼Œå®ç°æ•°æ®åº“è¿ç§»çš„è‡ªåŠ¨åŒ–ã€‚</p> <h2 id="å¼€å¯è™šæ‹Ÿçº¿ç¨‹-æé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›"><a href="#å¼€å¯è™šæ‹Ÿçº¿ç¨‹-æé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›" class="header-anchor">#</a> å¼€å¯è™šæ‹Ÿçº¿ç¨‹ï¼Œæé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›</h2> <p>è™šæ‹Ÿçº¿ç¨‹æ˜¯åœ¨ Java 21 ä¸­å¼•å…¥çš„ä¸€ç§çº¿ç¨‹æŠ½è±¡ã€‚å®ƒæä¾›äº†è½»é‡çº§çš„çº¿ç¨‹å®ç°æ–¹å¼ï¼Œç”± JVM æ¥è°ƒåº¦ï¼Œå¯ä»¥å®ç°ç”¨æˆ·çº§åˆ«çš„çº¿ç¨‹è°ƒåº¦å’Œç®¡ç†ã€‚å®ƒå’Œæ“ä½œç³»ç»Ÿè¿›è¡Œçº¿ç¨‹è°ƒåº¦å’Œç®¡ç†ä¸€æ ·ï¼Œä½†æ˜¯å®ƒä¸éœ€è¦ç³»ç»Ÿå†…æ ¸ä»‹å…¥ï¼Œä¸éœ€è¦è¿›è¡Œå¼€é”€éå¸¸å¤§çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œèƒ½å¤Ÿå¤§å¹…åº¦æé«˜ Java çš„å¹¶å‘èƒ½åŠ›ã€‚å› æ­¤ï¼Œè™šæ‹Ÿçº¿ç¨‹åœ¨ Java 21 ä¸­è¢«å¾ˆå¤šäººç§°ä½œæ˜¯å²è¯—çº§çš„æ›´æ–°ã€‚</p> <p>Spring Boot 3.2.0 å¼€å§‹æ”¯æŒè™šæ‹Ÿçº¿ç¨‹ï¼ˆProject Loomï¼‰ï¼Œå¯ä»¥é€šè¿‡å°†å±æ€§ spring.threads.virtual.enabled è®¾ç½®ä¸º true æ¥å¯ç”¨è™šæ‹Ÿçº¿ç¨‹ã€‚ å¦‚æœå¯ç”¨äº†è™šæ‹Ÿçº¿ç¨‹ï¼Œé…ç½®çº¿ç¨‹æ± çš„å±æ€§å°†ä¸å†èµ·ä½œç”¨ï¼Œå› ä¸ºè™šæ‹Ÿçº¿ç¨‹æ˜¯åœ¨ JVM èŒƒå›´çš„å¹³å°çº¿ç¨‹æ± ä¸Šè€Œä¸æ˜¯åœ¨ä¸“ç”¨çº¿ç¨‹æ± ä¸Šè°ƒåº¦çš„ã€‚</p> <p>ç”±äº novel ä½¿ç”¨çš„ Spring Boot ç‰ˆæœ¬æ˜¯ 3.3.0ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ novel é¡¹ç›®ä¸­é€šè¿‡å¼€å¯è™šæ‹Ÿçº¿ç¨‹æ¥æé«˜é¡¹ç›®çš„å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯é¦–å…ˆå¿…é¡»åœ¨ Java 21 ä¸Šè¿è¡Œè™šæ‹Ÿçº¿ç¨‹æ‰èƒ½ç”Ÿæ•ˆï¼Œç„¶åå°†å±æ€§ spring.threads.virtual.enabled è®¾ç½®ä¸º trueã€‚å¯ç”¨è™šæ‹Ÿçº¿ç¨‹åï¼ŒTomcat å’Œ Jetty å°†ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹è¿›è¡Œè¯·æ±‚å¤„ç†ï¼ˆUndertow æš‚ä¸æ”¯æŒï¼‰ã€‚è¿™æ„å‘³ç€å¤„ç† Web è¯·æ±‚çš„åº”ç”¨ç¨‹åºä»£ç ï¼ˆå¦‚æ§åˆ¶å™¨ä¸­çš„æ–¹æ³•ï¼‰å°†åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸Šè¿è¡Œã€‚</p> <blockquote><p>æ³¨æ„ï¼šè™šæ‹Ÿçº¿ç¨‹çš„ä¸€ä¸ªæ½œåœ¨å‰¯ä½œç”¨æ˜¯å®ƒä»¬ä½œä¸ºå®ˆæŠ¤çº¿ç¨‹è¿è¡Œã€‚å¦‚æœ JVM ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œåˆ™ JVM ä¼šç›´æ¥é€€å‡ºï¼Œä¸ä¼šç­‰å¾…è¿™äº›çº¿ç¨‹å®Œæˆå…¶æ‰§è¡Œã€‚å¦‚æœåº”ç”¨ç¨‹åºæ˜¯ä¾èµ– <code>@Scheduled bean</code> çš„è°ƒåº¦ä»»åŠ¡çº¿ç¨‹æ¥ä¿æŒ JVM è¿è¡Œçš„è¯ï¼Œå¼€å¯è™šæ‹Ÿçº¿ç¨‹åï¼Œ<code>@Scheduled bean</code> è°ƒåº¦ä»»åŠ¡çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œæ— æ³•é˜»æ­¢ JVM çš„å…³é—­ï¼Œå…¶ä»–ä¾èµ–äºçº¿ç¨‹å­˜æ´»çš„æŠ€æœ¯ä¹Ÿä¼šå¦‚æ­¤ã€‚ä¸ºäº†åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä¿æŒ JVM è¿è¡Œï¼Œå»ºè®®å°†å±æ€§ <code>spring.main.keep-alive</code> è®¾ç½®ä¸º <code>true</code>ã€‚è¿™ä¼šç¡®ä¿ JVM ä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œå³ä½¿æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯è™šæ‹Ÿçº¿ç¨‹ã€‚</p></blockquote> <p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥åœ¨<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹å±æ€§å³å¯å¼€å¯è™šæ‹Ÿçº¿ç¨‹ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># å¯ç”¨è™šæ‹Ÿçº¿ç¨‹</span>
  <span class="token key atrule">threads</span><span class="token punctuation">:</span>
    <span class="token key atrule">virtual</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># å³ä½¿æ‰€æœ‰çš„ç”¨æˆ·çº¿ç¨‹ï¼ˆåŒ…æ‹¬è™šæ‹Ÿçº¿ç¨‹ï¼‰éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼ŒJVM ä¹Ÿä¸ä¼šç«‹å³é€€å‡ºï¼Œ</span>
  <span class="token comment"># Spring Boot å®˜æ–¹å»ºè®®åœ¨å¼€å¯è™šæ‹Ÿçº¿ç¨‹æ—¶è®¾ç½®è¯¥å±æ€§</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5 months ago</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/course/novel/4.html" class="prev">
        é¡¹ç›®å¼€å‘
      </a></span> <span class="next"><a href="/course/novel/6.html">
        é¡¹ç›®éƒ¨ç½²
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6280180d.js" defer></script><script src="/assets/js/3.64ef1717.js" defer></script><script src="/assets/js/2.954998af.js" defer></script><script src="/assets/js/20.2d84071d.js" defer></script>
  </body>
</html>
