<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>项目优化 | 小说精品屋</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="img/logo.png">
    <meta name="description" content="小说精品屋项目文档是一套开源项目的Java学习和项目实战教程,包括SpringBoot3+Vue3项目实战教程和SpringCloud微服务项目实战教程,手把手教你从零开始开发上线一套生产级别的小说系统.">
    <meta name="keywords" content="Java最新技术栈学习,SpringBoot3学习,SpringBoot3项目实战,Vue3项目实战,Java项目实战,微服务项目实战">
    
    <link rel="preload" href="/assets/css/0.styles.b9105d85.css" as="style"><link rel="preload" href="/assets/js/app.6280180d.js" as="script"><link rel="preload" href="/assets/js/3.64ef1717.js" as="script"><link rel="preload" href="/assets/js/2.954998af.js" as="script"><link rel="preload" href="/assets/js/20.2d84071d.js" as="script"><link rel="prefetch" href="/assets/js/10.28fe92ba.js"><link rel="prefetch" href="/assets/js/11.d41ee02f.js"><link rel="prefetch" href="/assets/js/12.d94c66af.js"><link rel="prefetch" href="/assets/js/13.74652e21.js"><link rel="prefetch" href="/assets/js/14.2f792e3c.js"><link rel="prefetch" href="/assets/js/15.1deae68d.js"><link rel="prefetch" href="/assets/js/16.3f0252f7.js"><link rel="prefetch" href="/assets/js/17.497a772a.js"><link rel="prefetch" href="/assets/js/18.173f78ae.js"><link rel="prefetch" href="/assets/js/19.55db8822.js"><link rel="prefetch" href="/assets/js/21.ec7b29e7.js"><link rel="prefetch" href="/assets/js/22.c0249cb5.js"><link rel="prefetch" href="/assets/js/23.95dcaf3f.js"><link rel="prefetch" href="/assets/js/24.2e655ccd.js"><link rel="prefetch" href="/assets/js/25.ae6247c4.js"><link rel="prefetch" href="/assets/js/26.f4af31aa.js"><link rel="prefetch" href="/assets/js/27.9eb4c5d8.js"><link rel="prefetch" href="/assets/js/28.db27b001.js"><link rel="prefetch" href="/assets/js/29.dfe34280.js"><link rel="prefetch" href="/assets/js/30.76ef90c1.js"><link rel="prefetch" href="/assets/js/31.ca3916c7.js"><link rel="prefetch" href="/assets/js/32.1838893a.js"><link rel="prefetch" href="/assets/js/33.e5f4a5d8.js"><link rel="prefetch" href="/assets/js/34.fc82d81e.js"><link rel="prefetch" href="/assets/js/35.6fde2e58.js"><link rel="prefetch" href="/assets/js/36.0b151136.js"><link rel="prefetch" href="/assets/js/37.3e58e69f.js"><link rel="prefetch" href="/assets/js/38.5df1893b.js"><link rel="prefetch" href="/assets/js/39.2950d598.js"><link rel="prefetch" href="/assets/js/4.05d8729e.js"><link rel="prefetch" href="/assets/js/5.8c128a4a.js"><link rel="prefetch" href="/assets/js/6.4b2b1e57.js"><link rel="prefetch" href="/assets/js/7.8bb179a1.js"><link rel="prefetch" href="/assets/js/8.480536c4.js"><link rel="prefetch" href="/assets/js/9.d0425c9f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b9105d85.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="小说精品屋" class="logo"> <span class="site-name can-hide">小说精品屋</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://117.72.165.13:8888" target="_blank" rel="noopener noreferrer" class="nav-link external">
  演示网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project Menu" class="dropdown-title"><span class="title">项目文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project Menu" class="mobile-dropdown-title"><span class="title">项目文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/course/novel/" class="nav-link router-link-active">
  novel
</a></li><li class="dropdown-item"><!----> <a href="/course/novelplus/" class="nav-link">
  novel-plus
</a></li><li class="dropdown-item"><!----> <a href="/course/novelcloud/" class="nav-link">
  novel-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub Menu" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub Menu" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Gitee Menu" class="dropdown-title"><span class="title">码云</span> <span class="arrow down"></span></button> <button type="button" aria-label="Gitee Menu" class="mobile-dropdown-title"><span class="title">码云</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/suport/" class="nav-link">
  💖 支持
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com/service.htm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  联系我们
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://117.72.165.13:8888" target="_blank" rel="noopener noreferrer" class="nav-link external">
  演示网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Project Menu" class="dropdown-title"><span class="title">项目文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="Project Menu" class="mobile-dropdown-title"><span class="title">项目文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/course/novel/" class="nav-link router-link-active">
  novel
</a></li><li class="dropdown-item"><!----> <a href="/course/novelplus/" class="nav-link">
  novel-plus
</a></li><li class="dropdown-item"><!----> <a href="/course/novelcloud/" class="nav-link">
  novel-cloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub Menu" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub Menu" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/201206030/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Gitee Menu" class="dropdown-title"><span class="title">码云</span> <span class="arrow down"></span></button> <button type="button" aria-label="Gitee Menu" class="mobile-dropdown-title"><span class="title">码云</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-plus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-plus
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/novel_dev_team/novel-cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  novel-cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/suport/" class="nav-link">
  💖 支持
</a></div><div class="nav-item"><a href="https://novel.xxyopen.com/service.htm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  联系我们
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/course/novel/" aria-current="page" class="sidebar-link">快速开始</a></li><li><a href="/course/novel/1.html" class="sidebar-link">技术架构</a></li><li><a href="/course/novel/2.html" class="sidebar-link">技术要点</a></li><li><a href="/course/novel/3.html" class="sidebar-link">数据库设计</a></li><li><a href="/course/novel/4.html" class="sidebar-link">项目开发</a></li><li><a href="/course/novel/9.html" aria-current="page" class="active sidebar-link">项目优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用策略模式重构多系统环境下的用户认证授权" class="sidebar-link">使用策略模式重构多系统环境下的用户认证授权</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用装饰者模式解决表单形式传参的-xss-攻击" class="sidebar-link">使用装饰者模式解决表单形式传参的 XSS 攻击</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用模版方法模式实现可拓展的消息发送器" class="sidebar-link">使用模版方法模式实现可拓展的消息发送器</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#一行代码解决-json-形式传参的-xss-攻击" class="sidebar-link">一行代码解决 JSON 形式传参的 XSS 攻击</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#集成-elasticsearch-8-实现搜索引擎动态切换" class="sidebar-link">集成 Elasticsearch 8，实现搜索引擎动态切换</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用-rabbitmq-刷新-es-redis-caffeine-等小说副本数据" class="sidebar-link">使用 RabbitMQ 刷新 ES/Redis/Caffeine 等小说副本数据</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用-xxl-job-优化-elasticsearch-数据同步任务" class="sidebar-link">使用 XXL-JOB 优化 Elasticsearch 数据同步任务</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用-sentinel-实现接口防刷和限流" class="sidebar-link">使用 Sentinel 实现接口防刷和限流</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#集成-shardingsphere-jdbc-优化小说内容存储" class="sidebar-link">集成 ShardingSphere-JDBC 优化小说内容存储</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#集成-spring-boot-admin-实现应用管理和监控功能" class="sidebar-link">集成 Spring Boot Admin 实现应用管理和监控功能</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#使用-docker-compose-一键安装开发环境" class="sidebar-link">使用 Docker Compose 一键安装开发环境</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#集成-flyway-实现数据库的版本管理" class="sidebar-link">集成 Flyway 实现数据库的版本管理</a></li><li class="sidebar-sub-header"><a href="/course/novel/9.html#开启虚拟线程-提高项目的并发能力" class="sidebar-link">开启虚拟线程，提高项目的并发能力</a></li></ul></li><li><a href="/course/novel/6.html" class="sidebar-link">项目部署</a></li><li><a href="/course/novel/12.html" class="sidebar-link">更多</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="项目优化"><a href="#项目优化" class="header-anchor">#</a> 项目优化</h1> <h2 id="使用策略模式重构多系统环境下的用户认证授权"><a href="#使用策略模式重构多系统环境下的用户认证授权" class="header-anchor">#</a> 使用策略模式重构多系统环境下的用户认证授权</h2> <h3 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h3> <p>小说精品屋由前台门户系统、作家后台管理系统、平台后台管理系统和爬虫管理系统以及后面可能会扩展的漫画系统和视频系统等多个子系统构成，是一个复杂的多系统环境。平台端的后台管理系统和爬虫管理系统账号是独立的，用户端其它子系统要求统一账号登录。那么我们应该如何设计才能统一对这些系统进行认证授权呢 ？</p> <h3 id="实现思路"><a href="#实现思路" class="header-anchor">#</a> 实现思路</h3> <p>我们提供平台管理后台、爬虫管理后台和单点登录三个登录入口，前端在每个登录入口登录成功之后都会获得后端返回的 token，这个时候需要分别保存起来，
在请求相应系统的后端接口时，通过请求头携带上相应的 token。</p> <p>后端需要配置一个统一的拦截器，根据请求的 URI 识别出相应系统类型，并对这些 token 进行解析得到 userId。这个时候就可以根据用户来鉴权，如果用户有权访问，则放行。否则，返回一个相应的错误码给前端。具体代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 校验登录 token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">HTTP_AUTH_HEADER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_FRONT_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 校验门户系统用户权限</span>
                <span class="token class-name">Long</span> userId <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOVEL_FRONT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// TODO 查询用户信息并校验账号状态是否正常</span>
                    <span class="token comment">// TODO 其它权限校验</span>
                    <span class="token comment">// 认证成功</span>
                    <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// TODO 校验作家后台管理系统用户权限</span>

            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestUri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_ADMIN_URL_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// TODO 校验平台后台管理系统用户权限</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//。。。更多系统权限校验</span>
            <span class="token comment">// 完整实现可能至少几百行的代码</span>

        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时，可以简单的实现基本的权限拦截功能。但是因为所有系统的认证授权逻辑都在这一个方法中，代码及其臃肿难以维护。每当某一系统授权逻辑发生变化或者新增加了一个子系统，都需要修改此处的代码。修改之前不但必须先完全理解这一大段代码，正确定位到需要修改的位置，而且极其容易影响到不相干的其它系统认证授权功能。久而久之就没有人愿意维护这部分代码了。为了解决这个问题，下面我们使用策略模式来重构该功能。</p> <h3 id="策略模式定义"><a href="#策略模式定义" class="header-anchor">#</a> 策略模式定义</h3> <blockquote><p>策略模式定义了算法族，分别封装起来，让它们之间可以互相替换，此模式让算法的变化独立于使用算法的客户。</p></blockquote> <p>策略模式的核心在于封装变化，在我们系统中就是定义多个不同系统的认证授权策略（算法族），分别封装成独立的类。拦截器（客户）在运行时根据具体的请求 URI 来动态调用相应系统的认证授权算法。当某一系统的认证授权逻辑发生变化或增加新的子系统时，我们只需要修改或增加相应的策略类，而不会影响到其它的策略类（子系统）和客户（拦截器）。</p> <h3 id="重构步骤"><a href="#重构步骤" class="header-anchor">#</a> 重构步骤</h3> <ol><li>在<code>io.github.xxyopen.novel.core.auth</code>包下创建 AuthStrategy 接口，该接口定义了一个默认的方法实现用户端所有子系统都需要的统一账号认证逻辑和一个封装各个系统独立认证授权逻辑的待实现方法（例如，作家管理系统还需要验证作家账号是否存在和作家状态是否正常）：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 策略模式实现用户认证授权功能
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 用户认证授权
     *
     * @param token      登录 token
     * @param requestUri 请求的 URI
     * @throws BusinessException 认证失败则抛出业务异常
     */</span>
    <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 前台多系统单点登录统一账号认证（门户系统、作家系统以及后面会扩展的漫画系统和视频系统等）
     *
     * @param jwtUtils             jwt 工具
     * @param userInfoCacheManager 用户缓存管理对象
     * @param token                token 登录 token
     * @return 用户ID
     */</span>
    <span class="token keyword">default</span> <span class="token class-name">Long</span> <span class="token function">authSSO</span><span class="token punctuation">(</span><span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">,</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">,</span>
        <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// token 为空</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">NOVEL_FRONT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// token 解析失败</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LOGIN_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UserInfoDto</span> userInfo <span class="token operator">=</span> userInfoCacheManager<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用户不存在</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_ACCOUNT_NOT_EXIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置 userId 到当前线程</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回 userId</span>
        <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>接着在该包下创建各个系统的认证授权策略类，实现上述的 AuthStrategy 接口：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 前台门户系统 认证授权策略
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FrontAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统一账号认证</span>
        <span class="token function">authSSO</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">,</span> userInfoCacheManager<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 作家后台管理系统 认证授权策略
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserInfoCacheManager</span> userInfoCacheManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthorInfoCacheManager</span> authorInfoCacheManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 不需要进行作家权限认证的 URI
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">EXCLUDE_URI</span> <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span>
        <span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_AUTHOR_URL_PREFIX</span> <span class="token operator">+</span> <span class="token string">&quot;/status&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统一账号认证</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token function">authSSO</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">,</span> userInfoCacheManager<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">EXCLUDE_URI</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>requestUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 该请求不需要进行作家权限认证</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 作家权限校验</span>
        <span class="token class-name">AuthorInfoDto</span> authorInfo <span class="token operator">=</span> authorInfoCacheManager<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>authorInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 作家账号不存在，无权访问作家专区</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_UN_AUTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置作家ID到当前线程</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">setAuthorId</span><span class="token punctuation">(</span>authorInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 平台后台管理系统 认证授权策略
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdminAuthStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">AuthStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> requestUri<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BusinessException</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO 平台后台 token 校验</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>最后在拦截器中根据请求 URI 动态调用相应策略：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 认证授权 拦截器
 * 为了注入其它的 Spring beans，需要通过 @Component 注解将该拦截器注册到 Spring 上下文
 *
 * @author xiongxiaoyang
 * @date 2022/5/18
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">AuthStrategy</span><span class="token punctuation">&gt;</span></span> authStrategy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取登录 JWT</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SystemConfigConsts</span><span class="token punctuation">.</span><span class="token constant">HTTP_AUTH_HEADER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取请求的 URI</span>
        <span class="token class-name">String</span> requestUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据请求的 URI 得到认证策略</span>
        <span class="token class-name">String</span> subUri <span class="token operator">=</span> requestUri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">ApiRouterConsts</span><span class="token punctuation">.</span><span class="token constant">API_URL_PREFIX</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> systemName <span class="token operator">=</span> subUri<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>subUri<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> authStrategyName <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%sAuthStrategy&quot;</span><span class="token punctuation">,</span>systemName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 开始认证</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            authStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>authStrategyName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BusinessException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 认证失败</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getErrorCodeEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;NullableProblems&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 清理当前线程保存的用户数据</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="使用装饰者模式解决表单形式传参的-xss-攻击"><a href="#使用装饰者模式解决表单形式传参的-xss-攻击" class="header-anchor">#</a> 使用装饰者模式解决表单形式传参的 XSS 攻击</h2> <h3 id="xss-攻击定义"><a href="#xss-攻击定义" class="header-anchor">#</a> XSS 攻击定义</h3> <blockquote><p>跨站脚本攻击（XSS），是最普遍的 Web 应用安全漏洞。能够使得攻击者嵌入恶意脚本代码到正常用户会访问到的页面中，当正常用户访问该页面时，则可导致嵌入的恶意脚本代码的执行，从而达到恶意攻击用户的目的。</p></blockquote> <p>例如，在 novel 项目中，如果没有预防 XSS 攻击的话。恶意用户进入到我们小说评论区，发表如下评论：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token comment">// 获取当前登录用户的认证 token</span>
    token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 通过 ajax 请求发送该 token 到恶意用户的指定服务器</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>当其他正常用户登录成功进入到小说评论区后，会自动执行上述的 javascript 脚本，自己的登录 token 会被发送到攻击者的服务器上。攻击者拿到该 token 后即可利用该 token 来冒充正常用户进行一系列例如资金转账等危险操作。</p> <p>攻击者还可以利用该漏洞在我们系统中插入恶意内容（例如广告）、重定向用户（重定向到黄赌毒网站）等。</p> <p>注：人们经常将跨站脚本攻击（Cross Site Scripting）缩写为 CSS，但这会与层叠样式表（Cascading Style Sheets，CSS）的缩写混淆。因此，有人将跨站脚本攻击缩写为 XSS。</p> <h3 id="装饰者模式定义"><a href="#装饰者模式定义" class="header-anchor">#</a> 装饰者模式定义</h3> <blockquote><p>动态将责任附加到对象上。想要扩展功能，装饰者提供有别于继承的另一种选择。</p></blockquote> <p>装饰者可以在被装饰者的行为前面与/或后面加上自己的行为，甚至将被装饰者的行为整个取代掉，而达到特定的目的。</p> <p>Spring MVC 是通过 HttpServletRequest 的 getParameterValues 方法来获取用户端的请求参数并绑定到我们 @RequestMapping 方法定义的对象上。所以我们可以装饰 HttpServletRequest 对象，在 getParameterValues 方法里加上自己的行为（对请求参数值里面的特殊字符进行转义）来解决 XSS 攻击。</p> <p>由于 Servlet Api 提供了 HttpServletRequest 接口的便捷实现 HttpServletRequestWrapper 类，该类已经实现了装饰者模式，我们直接继承该类并重写里面的 getParameterValues 方法即可。</p> <h3 id="实现步骤"><a href="#实现步骤" class="header-anchor">#</a> 实现步骤</h3> <ol><li>新建 XssHttpServletRequestWrapper 装饰者类继承 HttpServletRequestWrapper 类，并重写 getParameterValues 方法，对里面字符串的特殊字符进行转义：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssHttpServletRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token constant">REPLACE_RULE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;lt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">XssHttpServletRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> length <span class="token operator">=</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> escapeValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                escapeValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token constant">REPLACE_RULE</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token operator">-&gt;</span> escapeValues<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> escapeValues<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> escapeValues<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>新建 XssFilter 过滤器，使用 XssHttpServletRequestWrapper 装饰者对象替换掉 HttpServletRequest 被装饰者对象：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">XssHttpServletRequestWrapper</span> xssRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XssHttpServletRequestWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>xssRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="使用模版方法模式实现可拓展的消息发送器"><a href="#使用模版方法模式实现可拓展的消息发送器" class="header-anchor">#</a> 使用模版方法模式实现可拓展的消息发送器</h2> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>随着系统业务的发展，为了更好的用户体验，需要在包括会员注册成功、代币充值成功、秒杀活动即将开始、账户封禁、小说下架等特定事件发生时发送各种类型的消息，包括系统通知、邮件、短信、微信通知等，每种事件发生时需要发送的消息格式都不一样，需要发送的消息类型也不一样，而且这些需求可能随时都会发生变化，那么如何设计一个灵活的消息发送系统来应对这种多变的需求呢？为了解决这个问题，我们使用模版方法模式进行设计。</p> <h3 id="模版方法模式定义"><a href="#模版方法模式定义" class="header-anchor">#</a> 模版方法模式定义</h3> <blockquote><p>在一个方法中定义一个算法的骨架，而将一些步骤延续到子类中。模版方法使得子类可以在不改变算法结构的情况下，重新定义算法中的某些步骤。有了模版方法，我们可以像专家一样复用代码，同时保持对算法的控制。</p></blockquote> <h3 id="实现思路-2"><a href="#实现思路-2" class="header-anchor">#</a> 实现思路</h3> <p>在我们系统中，消息发送的算法（发送的步骤）是一致的，大概分为以下 5 个步骤：</p> <ol><li>获取消息标题模版</li> <li>获取消息内容模版</li> <li>解析消息模版，得到最终需要发送的消息标题</li> <li>解析消息内容，得到最终需要发送的消息内容</li> <li>发送消息</li></ol> <p>这个时候我们可以定义一个抽象的消息发送器 <code>AbstractMessageSender</code>，并在消息发送的模版方法 <code>sendMessage</code> 中封装消息发送的算法，为了防止子类修改该模版中定义的算法，我们还需要将 <code>sendMessage</code> 方法声明为 <code>final</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 定义消息发送的模版，子类不能修改此模版
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取消息标题模版</span>
        <span class="token class-name">String</span> titleTemplate <span class="token operator">=</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.获取消息内容模版</span>
        <span class="token class-name">String</span> contentTemplate <span class="token operator">=</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.解析消息模版，得到最终需要发送的消息标题</span>
        <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span>titleTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析消息内容，得到最终需要发送的消息内容</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.发送消息</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>toUserId<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>不同类型的消息决定了消息实际送达的位置不一样，例如：系统通知需要将消息保存到数据库、邮件消息需要发送到用户的邮箱、短信消息需要发送到对方的手机号、微信通知需要发送到对方的微信等等。所以消息发送算法中的第 5 个步骤应该定义成抽象的方法，然后由不同子类型的消息发送器（邮件发送器、系统通知发送器等）去实现该步骤。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO 根据消息接收方的用户ID查询出消息接收方的邮件地址</span>
        <span class="token class-name">String</span> toEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始发送邮件</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件开始：{},{},{}&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 MimeMessage，MIME 协议</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> helper<span class="token punctuation">;</span>
        <span class="token comment">// MimeMessageHelper 帮助我们设置更丰富的内容</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mailProperties<span class="token punctuation">.</span><span class="token function">nickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>messageTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第二个参数 true 代表支持 html</span>
            helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>messageContent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件 to {} 成功&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 邮件发送失败不会重试</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件 to {} 失败&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>不同类型（系统通知、邮件、短信、微信通知等）的消息以及不同发送时机（会员注册成功、代币充值成功、秒杀活动即将开始、账户封禁、小说下架等）的消息决定了不同的消息格式（消息标题格式和消息内容格式），这些消息格式没有规律可循，只有具体的消息发送器才知道，所以消息发送算法中的第 1 个和第 2 个步骤需要定义成抽象的，然后由每个具体的消息发送器来制定消息模版。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;欢迎来到小说精品屋&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    感谢你注册小说精品屋！你的账户现在处于活动状态。
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; 你的账户电子邮件：{}
                    &lt;li&gt; 你的账户用户名：{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        登录我们的网站
                    &lt;/a&gt;
                &lt;/div&gt;
                
                如果你有任何问题，请通过 {} 与我们联系。
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>对于相同类型和相同发送时机的消息来说，虽然消息标题和消息内容的格式相同，但是文本内容可能是不同的，所以还需要第 3 步将消息标题模版解析成最终需要发送的消息标题和第 4 步将消息内容模版解析成最终需要发送的消息内容才能执行真正消息发送的逻辑。</p> <p>虽然如此，但是在这种情况下消息标题的内容大部分都是固定的，所以在抽象的消息发送器 <code>AbstractMessageSender</code>中会实现一个默认的消息标题解析逻辑：直接返回消息模版内容，不做任何解析；消息内容大部分虽然是动态的，但也是有规律可循的，所以在抽象的消息发送器 <code>AbstractMessageSender</code>中会实现一个可以满足大部分需求的消息内容解析逻辑：直接使用动态参数列表替换消息内容模版中的占位符。特定的消息发送器可以自定义消息标题模版和消息内容模版的解析逻辑。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 通过给定的参数列表解析消息标题模版，默认固定标题，不需要解析，可以由子类来拓展它的功能
     *
     * @param titleTemplate 消息标题模版
     * @param arguments     用来解析的参数列表
     * @return 解析后的消息标题
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> titleTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> titleTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通过给定的参数列表解析消息内容模版，默认实现是使用参数列表来替换消息内容模版中的占位符，可以由子类来拓展它的功能
     * &lt;p&gt;
     * 子类可以根据第一个/前几个参数去数据库中查询动态内容，然后重组参数列表
     *
     * @param contentTemplate 消息内容模版
     * @param args            用来解析的参数列表
     * @return 解析后的消息内容
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> contentTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> formattedContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> start <span class="token operator">=</span> formattedContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                formattedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token constant">PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> formattedContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> contentTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;欢迎来到小说精品屋&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    感谢你注册小说精品屋！你的账户现在处于活动状态。
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; 你的账户电子邮件：{}
                    &lt;li&gt; 你的账户用户名：{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        登录我们的网站
                    &lt;/a&gt;
                &lt;/div&gt;
                
                如果你有任何问题，请通过 {} 与我们联系。
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO 去数据库/配置文件中查询网站配置</span>
        <span class="token class-name">String</span> websiteLink <span class="token operator">=</span> <span class="token string">&quot;https://www.xxyopen.com&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> websiteEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span>
            <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>websiteLink<span class="token punctuation">,</span> websiteEmail<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>这个时候，如果需求发生变化，需要新增一个消息类型，或者新增一个需要发送消息的事件，我们只需要创建相应的消息发送器，不需要修改之前的代码，而且新创建的消息发送器可以做到只提供消息标题模版和消息内容模版即可正常工作的程度。大大提高了程序的可拓展性和代码最大程度的复用。</p> <h3 id="实现步骤-2"><a href="#实现步骤-2" class="header-anchor">#</a> 实现步骤</h3> <ol><li>创建消息发送器接口 <code>MessageSender</code>，定义消息发送的模版方法。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消息发送器接口，用来发送各种消息
 * &lt;p&gt;
 * 消息按类型分系统通知、邮件、短信、小程序通知等，按发送时机分注册成功消息、充值成功消息、活动通知消息、账户封禁消息、小说下架消息等
 *
 * @author xiongxiaoyang
 * @date 2023/3/25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 发送消息，支持动态消息标题和动态消息内容
     *
     * @param toUserId 消息接收方的用户ID
     * @param args     用来动态生成消息标题和消息内容的参数列表
     */</span>
    <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>创建抽象的消息发送器 <code>AbstractMessageSender</code>，实现消息发送的算法。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 抽象的消息发送器
 * &lt;p&gt;
 * 遵循松耦合的设计原则，所有的属性都使用构造函数注入，与 Spring 框架解藕
 * &lt;p&gt;
 * 所有的消息发送器既可以注册到 Spring 容器中，作为 Spring 的一个组件使用，也可以直接通过 new 对象的方式使用
 * &lt;p&gt;
 * 每种类型的消息发送时机可能都不一样，不同类型和发送时机的消息格式可能也不一样，所以由各个子类去拓展消息的格式
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PLACEHOLDER</span> <span class="token operator">=</span> <span class="token string">&quot;{}&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定义消息发送的模版，子类不能修改此模版
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取消息标题模版</span>
        <span class="token class-name">String</span> titleTemplate <span class="token operator">=</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.获取消息内容模版</span>
        <span class="token class-name">String</span> contentTemplate <span class="token operator">=</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.解析消息模版，得到最终需要发送的消息标题</span>
        <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span>titleTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.解析消息内容，得到最终需要发送的消息内容</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.发送消息</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span>toUserId<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发送消息，具体发送到哪里由子类决定
     *
     * @param toUserId       消息接收方的用户ID
     * @param messageTitle   消息标题
     * @param messageContent 消息内容
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取消息标题的模版，具体如何制定模版由子类决定
     *
     * @return 消息标题
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取消息内容的模版，具体如何制定模版由子类决定
     *
     * @return 消息内容
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过给定的参数列表解析消息标题模版，默认固定标题，不需要解析，可以由子类来拓展它的功能
     *
     * @param titleTemplate 消息标题模版
     * @param arguments     用来解析的参数列表
     * @return 解析后的消息标题
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> titleTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> arguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> titleTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通过给定的参数列表解析消息内容模版，默认实现是使用参数列表来替换消息内容模版中的占位符，可以由子类来拓展它的功能
     * &lt;p&gt;
     * 子类可以根据第一个/前几个参数去数据库中查询动态内容，然后重组参数列表
     *
     * @param contentTemplate 消息内容模版
     * @param args            用来解析的参数列表
     * @return 解析后的消息内容
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> contentTemplate<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> formattedContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>contentTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> start <span class="token operator">=</span> formattedContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">PLACEHOLDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                formattedContent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token constant">PLACEHOLDER</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> formattedContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> contentTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>创建抽象的邮件发送器 <code>AbstractMailSender</code> 和系统通知发送器 <code>AbstractSysNoticeSender</code>，分别发送邮件和系统通知。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 抽象的邮件消息发送者
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MailProperties</span> mailProperties<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JavaMailSender</span> mailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO 根据消息接收方的用户ID查询出消息接收方的邮件地址</span>
        <span class="token class-name">String</span> toEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始发送邮件</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件开始：{},{},{}&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用 MimeMessage，MIME 协议</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> mailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> helper<span class="token punctuation">;</span>
        <span class="token comment">// MimeMessageHelper 帮助我们设置更丰富的内容</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mailProperties<span class="token punctuation">.</span><span class="token function">nickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>messageTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第二个参数 true 代表支持 html</span>
            helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>messageContent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件 to {} 成功&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 邮件发送失败不会重试</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;发送 HTML 邮件 to {} 失败&quot;</span><span class="token punctuation">,</span> toEmail<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 抽象的系统通知发送者
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractSysNoticeSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> toUserId<span class="token punctuation">,</span> <span class="token class-name">String</span> messageTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> messageContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生成消息的发送时间</span>
        <span class="token class-name">LocalDateTime</span> messageDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO 在数据库系统通知表中插入一条记录</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;系统通知发送成功，{},{},{},{}&quot;</span><span class="token punctuation">,</span> toUserId<span class="token punctuation">,</span> messageDateTime<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token constant">ISO_DATE_TIME</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            messageTitle<span class="token punctuation">,</span> messageContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>创建注册成功的邮件发送器 <code>RegisterMailSender</code> 和秒杀活动的系统通知发送器 <code>SeckillSystemNoticeSender</code>。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 注册成功的邮件发送器
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">REGISTER_MAIL_SENDER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">MailProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterMailSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMailSender</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">RegisterMailSender</span><span class="token punctuation">(</span><span class="token class-name">MailProperties</span> mailProperties<span class="token punctuation">,</span> <span class="token class-name">JavaMailSender</span> mailSender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">,</span> mailSender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;欢迎来到小说精品屋&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;
                &lt;div&gt;
                    感谢你注册小说精品屋！你的账户现在处于活动状态。
                &lt;/div&gt;
                &lt;ul&gt;
                    &lt;li&gt; 你的账户电子邮件：{}
                    &lt;li&gt; 你的账户用户名：{}
                &lt;/ul&gt;
                &lt;div style=&quot;padding: 10px 0 50px 0; text-align: center;&quot;&gt;
                    &lt;a style=&quot;background: #0274be; color: #fff; padding: 12px 30px; text-decoration: none; border-radius: 3px; letter-spacing: 0.3px;&quot; href=&quot;{}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
                        登录我们的网站
                    &lt;/a&gt;
                &lt;/div&gt;
                
                如果你有任何问题，请通过 {} 与我们联系。
            &quot;&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">resolveContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO 去数据库/配置文件中查询网站配置</span>
        <span class="token class-name">String</span> websiteLink <span class="token operator">=</span> <span class="token string">&quot;https://www.xxyopen.com&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> websiteEmail <span class="token operator">=</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span>
            <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>websiteLink<span class="token punctuation">,</span> websiteEmail<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token operator">::</span><span class="token function">stream</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 秒杀活动的系统通知发送器
 *
 * @author xiongxiaoyang
 * @date 2023/3/24
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">SECKILL_SYS_NOTICE_SENDER</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillSystemNoticeSender</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSysNoticeSender</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getTitleTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;秒杀即将开始&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getContentTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;{}秒杀，{}即将开始，不要错过哦！点击 {} 前往。&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>消息发送测试</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">NovelApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageSenderTest</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractMessageSender</span><span class="token punctuation">&gt;</span></span> messageSenders<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> test<span class="token punctuation">{</span>
        <span class="token class-name">MessageSender</span> registerMailSender <span class="token operator">=</span> messageSenders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
            <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">REGISTER_MAIL_SENDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>registerMailSender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registerMailSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token number">11111L</span><span class="token punctuation">,</span> <span class="token string">&quot;xxyopen@foxmail.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xxyopen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">MessageSender</span> seckillSysNoticeSender <span class="token operator">=</span> messageSenders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
            <span class="token class-name">MessageSenderTypeConsts</span><span class="token punctuation">.</span><span class="token constant">SECKILL_SYS_NOTICE_SENDER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>registerMailSender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            seckillSysNoticeSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token number">11111L</span><span class="token punctuation">,</span> <span class="token string">&quot;全场商品&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;今晚 9 点&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;www.xxyopen.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="一行代码解决-json-形式传参的-xss-攻击"><a href="#一行代码解决-json-形式传参的-xss-攻击" class="header-anchor">#</a> 一行代码解决 JSON 形式传参的 XSS 攻击</h2> <h3 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h3> <p>前后端分离项目，对于 POST 和 PUT 类型的请求方法，后端基本都是通过 @RequestBody 注解接收 application/json 格式的请求数据，所以以前通过过滤器 + 装饰器 HttpServletRequestWrapper 来解决 XSS 攻击的方式并不适用。在 Spring Boot 中，我们可以通过配置全局的 Json 反序列化器转义特殊字符来解决 XSS 攻击。</p> <h3 id="实现代码"><a href="#实现代码" class="header-anchor">#</a> 实现代码</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * JSON 全局反序列化器
 *
 * @author xiongxiaoyang
 * @date 2022/5/21
 */</span>
<span class="token annotation punctuation">@JsonComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalJsonDeserializer</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 字符串反序列化器
     * 过滤特殊字符，解决 XSS 攻击
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StringDeserializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">JsonParser</span> jsonParser<span class="token punctuation">,</span> <span class="token class-name">DeserializationContext</span> deserializationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">JacksonException</span> <span class="token punctuation">{</span>
		<span class="token comment">// 实际代码就这一行</span>
            <span class="token keyword">return</span> jsonParser<span class="token punctuation">.</span><span class="token function">getValueAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;lt;&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&amp;gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="集成-elasticsearch-8-实现搜索引擎动态切换"><a href="#集成-elasticsearch-8-实现搜索引擎动态切换" class="header-anchor">#</a> 集成 Elasticsearch 8，实现搜索引擎动态切换</h2> <ol><li><p><a href="/course/novel/4.html#搜索引擎-elasticsearch-集成与配置">Elasticsearch 集成与配置</a></p></li> <li><p>在 application.yml 中增加 <code>spring.elasticsearch.enable</code> 配置项用来控制 Elasticsearch 搜索引擎功能是否开启：</p></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否开启 elasticsearch 搜索引擎功能：true-开启 false-不开启</span>
    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><ol start="3"><li>新建搜索服务类：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 搜索 服务类
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 小说搜索
     *
     * @param condition 搜索条件
     * @return 搜索结果
     */</span>
    <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>新建<code>数据库搜索</code>服务实现类，实现从数据库中检索小说的业务逻辑，由配置项<code>spring.elasticsearch.enable</code>控制当 elasticsearch 关闭时生效：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 数据库搜索 服务实现类
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> bookInfos <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">searchBooks</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">PageRespDto</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">,</span> bookInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token class-name">BookInfoRespDto</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bookName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">categoryId</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">categoryName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCategoryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">authorId</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getAuthorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">authorName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getAuthorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">wordCount</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">lastChapterName</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getLastChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>新建<code>Elasticsearch 搜索引擎搜索</code>服务实现类，实现从 Elasticsearch 中检索小说的业务逻辑，由配置项<code>spring.elasticsearch.enable</code>控制当 elasticsearch 开启时生效：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Elasticsearch 搜索 服务实现类
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> esClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

                    <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span> searchBuilder <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>IndexEnum</span><span class="token punctuation">.</span><span class="token constant">BOOK</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">buildSearchCondition</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> searchBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 排序</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        searchBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span>
                                o<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span>
                                                <span class="token punctuation">.</span><span class="token function">underlineToCamel</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder<span class="token punctuation">.</span>Desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 分页</span>
                    searchBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> searchBuilder<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TotalHits</span> total <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EsBookDto</span><span class="token punctuation">&gt;</span></span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">EsBookDto</span> book <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span> book <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bookName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getBookName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">categoryId</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">categoryName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getCategoryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">authorId</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getAuthorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">authorName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getAuthorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">wordCount</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">lastChapterName</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getLastChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">assert</span> total <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">PageRespDto</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> condition<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 构建查询条件
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildSearchCondition</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">,</span> <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span> searchBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">BoolQuery</span> boolQuery <span class="token operator">=</span> <span class="token class-name">BoolQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 关键词匹配</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">multiMatch</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t
                        <span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token string">&quot;bookName^2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;authorName^1.8&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;bookDesc^0.1&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 精确查询</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWorkDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">TermQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;workDirection&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWorkDirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">TermQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;categoryId&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 范围查询</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;wordCount&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;wordCount&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getWordCountMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getUpdateTimeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;lastChapterUpdateTime&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>condition<span class="token punctuation">.</span><span class="token function">getUpdateTimeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> b<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        searchBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q<span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li><code>BookController</code> 中注入 <code>SearchService</code> bean，调用<code>searchBooks</code>方法实现按配置动态切换搜索引擎的功能：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SearchService</span> searchService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 小说搜索接口
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;search_list&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageRespDto</span><span class="token punctuation">&lt;</span><span class="token class-name">BookInfoRespDto</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchBooks</span><span class="token punctuation">(</span><span class="token class-name">BookSearchReqDto</span> condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> searchService<span class="token punctuation">.</span><span class="token function">searchBooks</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="使用-rabbitmq-刷新-es-redis-caffeine-等小说副本数据"><a href="#使用-rabbitmq-刷新-es-redis-caffeine-等小说副本数据" class="header-anchor">#</a> 使用 RabbitMQ 刷新 ES/Redis/Caffeine 等小说副本数据</h2> <p>在 novel 分布式环境中，数据库中的小说信息可能会在多个地方保存一份副本数据。例如，为了减轻数据库压力，提高并发和系统性能的本地缓存 Caffeine 和分布式缓存 Redis、为了实现小说全文高级检索的 Elasticsearch 搜索引擎等。有时为了应对小说详情页的高并发访问和 SEO 优化，我们还会选择为每一本小说生成静态化的页面，通过 Nginx 或 CDN 来访问。</p> <p>此时，如果小说信息发生变更，那么如何通知所有的副本数据和静态页面更新呢？如果随着业务的发展和系统的演进，我们需要在 MongoDB 中增加一份存储副本，那么怎么在不修改调用方（所有小说信息发生变更的地方。例如，作家更新小说信息、作家发布新的章节或平台下架违规小说等场景）代码，不影响原先功能（其它副本数据的刷新）的同时，又能及时刷新 MongoDB 中的副本数据，实现模块间的解耦呢？</p> <p>我们通过消息中间件来解决以上问题，实现步骤如下：</p> <ol><li><p><a href="/course/novel/4.html#spring-amqp-集成与配置">Spring AMQP 集成与配置</a></p></li> <li><p>在<code>io.github.xxyopen.novel.core.constant</code>包下创建 AMQP 相关常量类：</p></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP 相关常量
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpConsts</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 小说信息改变 MQ
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BookChangeMq</span><span class="token punctuation">{</span>

        <span class="token comment">/**
         * 小说信息改变交换机
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;EXCHANGE-BOOK-CHANGE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Elasticsearch book 索引更新的队列
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_ES_UPDATE</span> <span class="token operator">=</span> <span class="token string">&quot;QUEUE-ES-BOOK-UPDATE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Redis book 缓存更新的队列
         * */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_REDIS_UPDATE</span> <span class="token operator">=</span> <span class="token string">&quot;QUEUE-REDIS-BOOK-UPDATE&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// ... 其它的更新队列</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>在<code>io.github.xxyopen.novel.core.config</code>包下创建 AMQP 配置类，配置各个交换机、队列以及绑定关系：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP 配置类
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 小说信息改变交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">bookChangeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Elasticsearch book 索引更新队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">esBookUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ES_UPDATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Elasticsearch book 索引更新队列绑定到小说信息改变交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">esBookUpdateQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">esBookUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">bookChangeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... 其它的更新队列以及绑定关系</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>在<code>io.github.xxyopen.novel.manager.mq</code>包下创建 AMQP 消息管理类，用来发送各种 AMQP 消息：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AMQP 消息管理类
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmqpMsgManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AmqpTemplate</span> amqpTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.amqp.enable}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> enableAmqp<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发送小说信息改变消息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBookChangeMsg</span><span class="token punctuation">(</span><span class="token class-name">Long</span> bookId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>enableAmqp<span class="token punctuation">,</span> <span class="token class-name">CommonConsts</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sendAmqpMessage</span><span class="token punctuation">(</span>amqpTemplate<span class="token punctuation">,</span> <span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendAmqpMessage</span><span class="token punctuation">(</span><span class="token class-name">AmqpTemplate</span> amqpTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> routingKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果在事务中则在事务执行完成后再发送，否则可以直接发送</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        amqpTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>在小说信息更新后，发送 AMQP 消息：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveBookChapter</span><span class="token punctuation">(</span><span class="token class-name">ChapterAddReqDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1) 保存章节相关信息到小说章节表</span>
    <span class="token comment">//  a) 查询最新章节号</span>
    <span class="token keyword">int</span> chapterNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookChapter</span><span class="token punctuation">&gt;</span></span> chapterQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chapterQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>BookChapterTable</span><span class="token punctuation">.</span><span class="token constant">COLUMN_BOOK_ID</span><span class="token punctuation">,</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>BookChapterTable</span><span class="token punctuation">.</span><span class="token constant">COLUMN_CHAPTER_NUM</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>SqlEnum</span><span class="token punctuation">.</span><span class="token constant">LIMIT_1</span><span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BookChapter</span> bookChapter <span class="token operator">=</span> bookChapterMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>chapterQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>bookChapter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        chapterNum <span class="token operator">=</span> bookChapter<span class="token punctuation">.</span><span class="token function">getChapterNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//  b) 设置章节相关信息并保存</span>
    <span class="token class-name">BookChapter</span> newBookChapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookChapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setBookId</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setChapterName</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setChapterNum</span><span class="token punctuation">(</span>chapterNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setWordCount</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setIsVip</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getIsVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookChapterMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2) 保存章节内容到小说内容表</span>
    <span class="token class-name">BookContent</span> bookContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getChapterContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setChapterId</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContent<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookContentMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>bookContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3) 更新小说表最新章节信息和小说总字数信息</span>
    <span class="token comment">//  a) 更新小说表关于最新章节的信息</span>
    <span class="token class-name">BookInfoRespDto</span> bookInfo <span class="token operator">=</span> bookInfoCacheManager<span class="token punctuation">.</span><span class="token function">getBookInfo</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BookInfo</span> newBookInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterId</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterName</span><span class="token punctuation">(</span>newBookChapter<span class="token punctuation">.</span><span class="token function">getChapterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setLastChapterUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookInfo<span class="token punctuation">.</span><span class="token function">setWordCount</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> newBookChapter<span class="token punctuation">.</span><span class="token function">getWordCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newBookChapter<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bookInfoMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>newBookInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  b) 刷新小说信息缓存</span>
    bookInfoCacheManager<span class="token punctuation">.</span><span class="token function">cachePutBookInfo</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  c) 发送小说信息更新的 MQ 消息</span>
    amqpMsgManager<span class="token punctuation">.</span><span class="token function">sendBookChangeMsg</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBookId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="6"><li>在<code>io.github.xxyopen.novel.core.listener</code>包下创建 Rabbit 队列监听器，监听各个 RabbitMQ 队列的消息并处理：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Rabbit 队列监听器
 *
 * @author xiongxiaoyang
 * @date 2022/5/25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitQueueListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> esClient<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 监听小说信息改变的 ES 更新队列，更新最新小说信息到 ES
     * */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">AmqpConsts<span class="token punctuation">.</span>BookChangeMq</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ES_UPDATE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateEsBook</span><span class="token punctuation">(</span><span class="token class-name">Long</span> bookId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BookInfo</span> bookInfo <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>bookId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>BookIndex</span><span class="token punctuation">.</span><span class="token constant">INDEX_NAME</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>bookInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ... 监听其它队列，刷新其它副本数据</span>

<span class="token punctuation">}</span>
</code></pre></div><p>此时，如果需要更新其它副本数据，只需要配置更新队列和增加监听器，不需要修改任何业务代码，而且任意副本的数据刷新互不影响，真正实现了模块间的解耦。</p> <p><strong>注：当服务集群部署时，由于多个消费者绑定同一个队列是无法同时消费的，一个消息只能被一个消费者消费，所以刷新本地缓存的 MQ 队列命名应该使用<code>固定名 + 唯一随机值</code>这种动态形式。这样每次启动会生成一个新的队列，我们需要设置该队列的 autoDelete = true，让所有消费客户端连接断开时自动删除该队列。</strong></p> <h2 id="使用-xxl-job-优化-elasticsearch-数据同步任务"><a href="#使用-xxl-job-优化-elasticsearch-数据同步任务" class="header-anchor">#</a> 使用 XXL-JOB 优化 Elasticsearch 数据同步任务</h2> <ol><li><p><a href="/course/novel/4.html#分布式任务调度平台-xxl-job-集成与配置">XXL-JOB 集成与配置</a></p></li> <li><p>登录调度中心后台，新增 novel 项目任务执行器：</p></li></ol> <p><img src="/img/novel/xxljobexe.png" alt="创建任务执行器"></p> <p><strong>注：AppName 的值需要和 novel 项目 application.yml 配置文件中配置的值保持一致。</strong></p> <ol start="3"><li>新增 Elasticsearch 数据同步任务：</li></ol> <p><img src="/img/novel/xxljobtask.png" alt="创建任务"></p> <ol start="4"><li>修改<code>io.github.xxyopen.novel.core.task</code>包下的 Elasticsearch 数据同步任务（<code>@Scheduled</code> 注解 替换为 <code>@XxlJob</code>​ 注解）：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 小说数据同步到 Elasticsearch 任务
 *
 * @author xiongxiaoyang
 * @date 2022/5/23
 */</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.elasticsearch&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enable&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookToEsTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookInfoMapper</span> bookInfoMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ElasticsearchClient</span> elasticsearchClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;saveToEsJobHandler&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 此处需要和调度中心创建任务时填写的 JobHandler 值保持一致</span>
    <span class="token keyword">public</span> <span class="token class-name">ReturnT</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveToEs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BookInfo</span><span class="token punctuation">&gt;</span></span> bookInfos<span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queryWrapper<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                queryWrapper
                        <span class="token punctuation">.</span><span class="token function">orderByAsc</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>CommonColumnEnum</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>CommonColumnEnum</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token class-name">DatabaseConsts<span class="token punctuation">.</span>SqlEnum</span><span class="token punctuation">.</span><span class="token constant">LIMIT_30</span><span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bookInfos <span class="token operator">=</span> bookInfoMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bookInfos<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BookInfo</span> book <span class="token operator">:</span> bookInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    br<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op
                            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx
                                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">EsConsts<span class="token punctuation">.</span>BookIndex</span><span class="token punctuation">.</span><span class="token constant">INDEX_NAME</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token class-name">EsBookDto</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;10s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    maxId <span class="token operator">=</span> book<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">BulkResponse</span> result <span class="token operator">=</span> elasticsearchClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Log errors, if any</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Bulk had errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BulkResponseItem</span> item <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">ReturnT</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ReturnT</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><ol start="5"><li>查看任务执行器，可以发现已经有一台机器自动注册：</li></ol> <p><img src="/img/novel/xxljobonline.png" alt="在线注册机器"></p> <ol start="6"><li>进入任务管理，我们可以启动 Elasticsearch 数据同步任务，由配置的 Cron 表达式进行任务调度；也可以选择手动触发一次任务执行：</li></ol> <p><img src="/img/novel/xxljobtaskexe.png" alt="任务启动"></p> <p>此时，我们可以在任意时刻手动同步数据库的小说数据到 Elasticsearch 搜索引擎中，极大的方便了我们的开发测试工作。</p> <h2 id="使用-sentinel-实现接口防刷和限流"><a href="#使用-sentinel-实现接口防刷和限流" class="header-anchor">#</a> 使用 Sentinel 实现接口防刷和限流</h2> <h3 id="问题-2"><a href="#问题-2" class="header-anchor">#</a> 问题</h3> <p>novel 作为一个互联网系统，经常会遇到非法爬虫（例如，盗版小说网站）来爬取我们系统的小说数据，这种爬虫行为有时会高达每秒几百甚至上千次访问。防刷的目的是为了限制这些爬虫请求我们接口的频率，如果我们不做接口防刷限制的话，我们系统很容易就会被爬虫干倒。</p> <p>限流的目的是在流量高峰期间，根据我们系统的承受能力，限制同时请求的数量，保证多余的请求会阻塞一段时间再处理，不简单粗暴的直接返回错误信息让客户端重试，同时又能起到流量削峰的作用。</p> <p>很多时候，我们都是尽量将请求拦截在系统上游，比如在反向代理层通过 Nginx + Lua + Redis 来实现限流功能，这个在后面部署篇章里面会详细地讲解如何实现。如果我们系统还没有使用类似于 Nginx 一样的反向代理，又或者我们想实现更复杂的流量控制，想要一个人性化的控制面板来动态限流和实时监控，那么我们可以使用阿里巴巴开源的高可用流控防护组件 Sentinel 来实现。</p> <h3 id="sentinel-介绍"><a href="#sentinel-介绍" class="header-anchor">#</a> Sentinel 介绍</h3> <p>Sentinel 是一个面向云原生微服务的高可用流控防护组件，以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p> <p>Sentinel 有两个重要的概念，<code>资源</code>和<code>规则</code>：</p> <p><strong>资源</strong>是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> <p><strong>规则</strong>是围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。</p> <p>Sentinel 具有以下特征:</p> <ul><li><p>丰富的应用场景：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p></li> <li><p>完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p></li> <li><p>广泛的开源生态：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。</p></li> <li><p>完善的 SPI 扩展机制：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p></li></ul> <p>Sentinel 分为<code>核心库</code>和<code>控制台</code>两部分，<code>核心库</code>不依赖<code>控制台</code>，但是结合<code>控制台</code>可以取得最好的效果:</p> <ul><li><p>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</p></li> <li><p>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</p></li></ul> <h3 id="使用-sentinel-核心库实现接口防刷和限流"><a href="#使用-sentinel-核心库实现接口防刷和限流" class="header-anchor">#</a> 使用 Sentinel 核心库实现接口防刷和限流</h3> <ol><li>引入 Sentinel 相关依赖：</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sentinel.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-parameter-flow-control<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${sentinel.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>在<code>io.github.xxyopen.novel.core.config.WebConfig</code>中注册一个全局的拦截器拦截所有的请求：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 流量限制拦截器</span>
registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>flowLimitInterceptor<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>拦截器中定义资源和规则，资源在<code>preHandle</code>方法中定义，为所有请求的入口，<code>接口限流规则</code>和<code>接口防刷规则</code>通过<code>static 代码块</code>在类加载时初始化：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 流量限制 拦截器
 * 实现接口防刷和限流
 *
 * @author xiongxiaoyang
 * @date 2022/6/1
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * novel 项目所有的资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NOVEL_RESOURCE</span> <span class="token operator">=</span> <span class="token string">&quot;novelResource&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// 接口限流规则：所有的请求，限制每秒最多只能通过 2000 个，超出限制匀速排队</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowRule</span> rule1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Set limit QPS to 2000.</span>
        rule1<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rule1<span class="token punctuation">.</span><span class="token function">setControlBehavior</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_RATE_LIMITER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 接口防刷规则 1：所有的请求，限制每个 IP 每秒最多只能通过 50 个，超出限制直接拒绝</span>
        <span class="token class-name">ParamFlowRule</span> rule2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 接口防刷规则 2：所有的请求，限制每个 IP 每分钟最多只能通过 1000 个，超出限制直接拒绝</span>
        <span class="token class-name">ParamFlowRule</span> rule3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDurationInSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>rule2<span class="token punctuation">,</span> rule3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getRealIp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 若需要配置例外项，则传入的参数只支持基本类型。</span>
            <span class="token comment">// EntryType 代表流量类型，其中系统规则只对 IN 类型的埋点生效</span>
            <span class="token comment">// count 大多数情况都填 1，代表统计为一次调用。</span>
            entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token constant">NOVEL_RESOURCE</span><span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Your logic here.</span>
            <span class="token keyword">return</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Handle request rejection.</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;IP:{}被限流了！&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">RestResp</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeEnum</span><span class="token punctuation">.</span><span class="token constant">USER_REQ_MANY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注意：exit 的时候也一定要带上对应的参数，否则可能会有统计错误。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>规则属性说明：</p> <table><thead><tr><th>属性</th> <th>说明</th> <th>默认值</th></tr></thead> <tbody><tr><td>resource</td> <td>资源名，必填</td> <td></td></tr> <tr><td>count</td> <td>限流阈值，必填</td> <td></td></tr> <tr><td>grade</td> <td>限流模式</td> <td>QPS 模式</td></tr> <tr><td>durationInSec</td> <td>统计窗口时间长度（单位为秒），1.6.0 版本开始支持</td> <td>1s</td></tr> <tr><td>controlBehavior</td> <td>流控效果（支持快速失败和匀速排队模式），1.6.0 版本开始支持</td> <td>快速失败</td></tr> <tr><td>maxQueueingTimeMs</td> <td>最大排队等待时长（仅在匀速排队模式生效），1.6.0 版本开始支持</td> <td>0ms</td></tr> <tr><td>paramIdx</td> <td>热点参数的索引，必填，对应 <code>SphU.entry(xxx, args)</code> 中的参数索引位置</td> <td></td></tr> <tr><td>paramFlowItemList</td> <td>参数例外项，可以针对指定的参数值单独设置限流阈值，不受前面 <code>count</code> 阈值的限制。<strong>仅支持基本类型和字符串类型</strong></td> <td></td></tr> <tr><td>clusterMode</td> <td>是否是集群参数流控规则</td> <td><code>false</code></td></tr> <tr><td>clusterConfig</td> <td>集群流控相关配置</td> <td></td></tr></tbody></table> <p>我们还可以通过 Sentinel 提供的<code>注解支持模块</code>来定义我们的资源，如下所示，helloWorld() 方法成了我们的一个资源：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 资源中的逻辑</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注：注解支持模块需要配合 Spring AOP 或者 AspectJ 一起使用。</strong></p> <p>此时，我们已经实现了接口防刷和限流的功能，如果我们需要实时监控和管理限流规则，那么我们可以按如下步骤接入 Sentinel 开源控制台：</p> <ul><li><p>下载控制台 jar 包并在本地启动</p></li> <li><p>novel 项目引入 Transport 模块来与 Sentinel 控制台进行通信</p></li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-transport-simple-http<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.8.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>novel 项目启动时加入 JVM 参数 -Dcsp.sentinel.dashboard.server=consoleIp:port 指定控制台地址和端口</li> <li>确保 novel 项目有访问量</li></ul> <p>完成以上步骤后即可在 Sentinel 控制台上看到对应的应用，机器列表页面可以看到对应的机器。</p> <h2 id="集成-shardingsphere-jdbc-优化小说内容存储"><a href="#集成-shardingsphere-jdbc-优化小说内容存储" class="header-anchor">#</a> 集成 ShardingSphere-JDBC 优化小说内容存储</h2> <h3 id="背景-2"><a href="#背景-2" class="header-anchor">#</a> 背景</h3> <p>传统的将数据集中存储至单一节点的解决方案，在性能、可用性和运维成本这三方面已经难于满足海量数据的场景。</p> <p>从性能方面来说，由于关系型数据库大多采用 B+ 树类型的索引，在数据量超过阈值的情况下，索引深度的增加也将使得磁盘访问的 IO 次数增加，进而导致查询性能的下降； 同时，高并发访问请求也使得集中式数据库成为系统的最大瓶颈。</p> <p>从可用性的方面来讲，服务化的无状态性，能够达到较小成本的随意扩容，这必然导致系统的最终压力都落在数据库之上。 而单一的数据节点，或者简单的主从架构，已经越来越难以承担。数据库的可用性，已成为整个系统的关键。</p> <p>从运维成本方面考虑，当一个数据库实例中的数据达到阈值以上，对于 DBA 的运维压力就会增大。 数据备份和恢复的时间成本都将随着数据量的大小而愈发不可控。一般来讲，单一数据库实例的数据的阈值在 1TB 之内，是比较合理的范围。</p> <p>数据分片指按照某个维度将存放在单一数据库中的数据分散地存放至多个数据库或表中以达到提升性能瓶颈以及可用性的效果。通过分库和分表进行数据的拆分来使得各个表的数据量保持在阈值以下，以及对流量进行疏导应对高访问量，是应对高并发和海量数据系统的有效手段。分库和分表均可以有效的避免由数据量超过可承受阈值而产生的查询瓶颈。</p> <p>小说数据有着内容多、增长速度快的特点，一本主流的完结小说一般所需存储空间大概在 5MB 以上。一个主流的小说网站在发展中后期，数据量是远远超过单一数据库实例的阈值的，所以我们对小说内容进行分库分表存储是非常有必要的。在发展初期，我们的数据量还不是很大，可以先将小说内容分表存储以减轻数据库单表压力以及为后期的数据库分库做准备。等数据量即将超过阈值时，再迁移到不同的数据库实例上。</p> <p><strong>注：数据分片分为按照业务将表进行归类，分布到不同的数据库中的垂直分片和通过某个字段（或某几个字段）按照某种规则将数据分散至多个库或表中的水平分片。</strong></p> <h3 id="apache-shardingsphere-介绍"><a href="#apache-shardingsphere-介绍" class="header-anchor">#</a> Apache ShardingSphere 介绍</h3> <p>Apache ShardingSphere 产品定位为 Database Plus，它关注如何充分合理地利用数据库的计算和存储能力，而并非实现一个全新的数据库。ShardingSphere 站在数据库的上层视角，关注他们之间的协作多于数据库自身，由 JDBC、Proxy 和 Sidecar（规划中）这 3 款既能够独立部署，又支持混合部署配合使用的产品组成。 它们均提供标准化的基于数据库作为存储节点的增量功能，可适用于如 Java 同构、异构语言、云原生等各种多样化的应用场景。</p> <p>ShardingSphere-JDBC 定位为轻量级 Java 框架，在 Java 的 JDBC 层提供额外服务。 它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架。</p> <p>ShardingSphere-Proxy 定位为透明化的数据库代理端，提供封装了数据库二进制协议的服务端版本，用于完成对异构语言的支持。</p> <p>ShardingSphere-Sidecar 定位为 Kubernetes 的云原生数据库代理，以 Sidecar 的形式代理所有对数据库的访问。 通过无中心、零侵入的方案提供与数据库交互的啮合层，即 Database Mesh，又可称数据库网格。</p> <p>连接、增量 和 可插拔 是 Apache ShardingSphere 的核心概念：</p> <ul><li><p>连接：通过对数据库协议、SQL 方言以及数据库存储的灵活适配，快速的连接应用与多模式的异构数据库；</p></li> <li><p>增量：获取数据库的访问流量，并提供流量重定向（数据分片、读写分离、影子库）、流量变形（数据加密、数据脱敏）、流量鉴权（安全、审计、权限）、流量治理（熔断、限流）以及流量分析（服务质量分析、可观察性）等透明化增量功能；</p></li> <li><p>可插拔：项目采用微内核 + 三层可插拔模型，使内核、功能组件以及生态对接完全能够灵活的方式进行插拔式扩展，开发者能够像使用积木一样定制属于自己的独特系统。</p></li></ul> <p>Apache ShardingSphere 的数据分片模块透明化了分库分表所带来的影响，让使用方尽量像使用一个数据库一样使用水平分片之后的数据库集群。</p> <h3 id="集成步骤"><a href="#集成步骤" class="header-anchor">#</a> 集成步骤</h3> <ol><li>MySQL 执行以下的数据迁移脚本：</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> createBookChapterTable<span class="token punctuation">;</span>
<span class="token comment">-- 创建小说章节表的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> createBookChapterTable <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义变量</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
			i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">DO</span>
			
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_chapter'</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'create table '</span><span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> <span class="token string">'(
				`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
				`book_id` bigint(20) unsigned NOT NULL COMMENT \'小说ID\',
				`chapter_num` smallint(5) unsigned NOT NULL COMMENT \'章节号\',
				`chapter_name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT \'章节名\',
				`word_count` int(10) unsigned NOT NULL COMMENT \'章节字数\',
				`is_vip` tinyint(3) unsigned NOT NULL DEFAULT \'0\' COMMENT \'是否收费;1-收费 0-免费\',
				`create_time` datetime DEFAULT NULL,
				`update_time` datetime DEFAULT NULL,
				PRIMARY KEY (`id`) USING BTREE,
				UNIQUE KEY `uk_bookId_chapterNum` (`book_id`,`chapter_num`) USING BTREE,
				UNIQUE KEY `pk_id` (`id`) USING BTREE,
				KEY `idx_bookId` (`book_id`) USING BTREE
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\'小说章节\''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> createBookChapterTable <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> createBookContentTable<span class="token punctuation">;</span>
<span class="token comment">-- 创建小说内容表的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> createBookContentTable <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义变量</span>
	<span class="token keyword">DECLARE</span>
		i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">WHILE</span>
			i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">DO</span>
			
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_content'</span><span class="token punctuation">,</span> i <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'create table '</span><span class="token punctuation">,</span> tableName<span class="token punctuation">,</span> <span class="token string">'(
				`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT \'主键\',
				`chapter_id` bigint(20) unsigned NOT NULL COMMENT \'章节ID\',
				`content` mediumtext CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT \'小说章节内容\',
				`create_time` datetime DEFAULT NULL,
				`update_time` datetime DEFAULT NULL,
				PRIMARY KEY (`id`) USING BTREE,
				UNIQUE KEY `uk_chapterId` (`chapter_id`) USING BTREE,
				UNIQUE KEY `pk_id` (`id`) USING BTREE
			) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT=\'小说内容\''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> createBookContentTable <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> copyBookChapterData<span class="token punctuation">;</span>
<span class="token comment">-- 迁移小说章节数据的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> copyBookChapterData <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义变量</span>
	<span class="token keyword">DECLARE</span>
		s <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		bookId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterNum <span class="token keyword">SMALLINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterName <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		wordCount <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		isVip <span class="token keyword">TINYINT</span> <span class="token punctuation">(</span> <span class="token number">64</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		createTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		updateTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableNumber <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义游标</span>
	<span class="token keyword">DECLARE</span>
		report <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span>
		id<span class="token punctuation">,</span>
		book_id<span class="token punctuation">,</span>
		chapter_num<span class="token punctuation">,</span>
		chapter_name<span class="token punctuation">,</span>
		word_count<span class="token punctuation">,</span>
		is_vip<span class="token punctuation">,</span>
		create_time<span class="token punctuation">,</span>
		update_time 
	<span class="token keyword">FROM</span>
		book_chapter<span class="token punctuation">;</span>
	<span class="token comment">-- 声明当游标遍历完后将标志变量置成某个值</span>
	<span class="token keyword">DECLARE</span>
		<span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND 
		<span class="token keyword">SET</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- 打开游标</span>
	<span class="token keyword">OPEN</span> report<span class="token punctuation">;</span>
	<span class="token comment">-- 将游标中的值赋值给变量，注意：变量名不要和返回的列名同名，变量顺序要和sql结果列的顺序一致</span>
	<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> chapterId<span class="token punctuation">,</span>
	bookId<span class="token punctuation">,</span>
	chapterNum<span class="token punctuation">,</span>
	chapterName<span class="token punctuation">,</span>
	wordCount<span class="token punctuation">,</span>
	isVip<span class="token punctuation">,</span>
	createTime<span class="token punctuation">,</span>
	updateTime<span class="token punctuation">;</span>
	<span class="token comment">-- 循环遍历</span>
	<span class="token keyword">WHILE</span>
			s <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token keyword">DO</span>
			<span class="token comment">-- 执行业务逻辑</span>
			
			<span class="token keyword">SET</span> tableNumber <span class="token operator">=</span> bookId <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_chapter'</span><span class="token punctuation">,</span> tableNumber <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span>
				<span class="token string">'insert into '</span><span class="token punctuation">,</span>
				tableName<span class="token punctuation">,</span>
				<span class="token string">'(`id`, `book_id`, `chapter_num`, `chapter_name`, `word_count`, `is_vip`, `create_time`, `update_time`) VALUES ('</span><span class="token punctuation">,</span>
				chapterId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				bookId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				chapterNum<span class="token punctuation">,</span>
				<span class="token string">', \''</span><span class="token punctuation">,</span>
				chapterName<span class="token punctuation">,</span>
				<span class="token string">'\', '</span><span class="token punctuation">,</span>
				wordCount<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				isVip<span class="token punctuation">,</span>
				<span class="token string">', \''</span><span class="token punctuation">,</span>
				createTime<span class="token punctuation">,</span>
				<span class="token string">'\', \''</span><span class="token punctuation">,</span>
				updateTime<span class="token punctuation">,</span>
				<span class="token string">'\')'</span> 
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> chapterId<span class="token punctuation">,</span>
			bookId<span class="token punctuation">,</span>
			chapterNum<span class="token punctuation">,</span>
			chapterName<span class="token punctuation">,</span>
			wordCount<span class="token punctuation">,</span>
			isVip<span class="token punctuation">,</span>
			createTime<span class="token punctuation">,</span>
			updateTime<span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token comment">-- 关闭游标</span>
	<span class="token keyword">CLOSE</span> report<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> copyBookChapterData <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">IF</span>
	<span class="token keyword">EXISTS</span> copyBookContentData<span class="token punctuation">;</span>
<span class="token comment">-- 迁移小说内容数据的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> copyBookContentData <span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">BEGIN</span>
	<span class="token comment">-- 定义变量</span>
	<span class="token keyword">DECLARE</span>
		s <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		contentId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		chapterId <span class="token keyword">BIGINT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		bookContent <span class="token keyword">MEDIUMTEXT</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		createTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		updateTime <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableNumber <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">DECLARE</span>
		tableName <span class="token keyword">CHAR</span> <span class="token punctuation">(</span> <span class="token number">13</span> <span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">-- 定义游标</span>
	<span class="token keyword">DECLARE</span>
		report <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span>
		id<span class="token punctuation">,</span>
		chapter_id<span class="token punctuation">,</span>
		content<span class="token punctuation">,</span>
		create_time<span class="token punctuation">,</span>
		update_time 
	<span class="token keyword">FROM</span>
		book_content<span class="token punctuation">;</span>
	<span class="token comment">-- 声明当游标遍历完后将标志变量置成某个值</span>
	<span class="token keyword">DECLARE</span>
		<span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND 
		<span class="token keyword">SET</span> s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">-- 打开游标</span>
	<span class="token keyword">OPEN</span> report<span class="token punctuation">;</span>
	<span class="token comment">-- 将游标中的值赋值给变量，注意：变量名不要和返回的列名同名，变量顺序要和sql结果列的顺序一致</span>
	<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> contentId<span class="token punctuation">,</span>
	chapterId<span class="token punctuation">,</span>
	bookContent<span class="token punctuation">,</span>
	createTime<span class="token punctuation">,</span>
	updateTime<span class="token punctuation">;</span>
	<span class="token comment">-- 循环遍历</span>
	<span class="token keyword">WHILE</span>
			s <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token keyword">DO</span>
			<span class="token comment">-- 执行业务逻辑</span>
			
			<span class="token keyword">SET</span> tableNumber <span class="token operator">=</span> chapterId <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
		
			<span class="token keyword">SET</span> tableName <span class="token operator">=</span> concat<span class="token punctuation">(</span> <span class="token string">'book_content'</span><span class="token punctuation">,</span> tableNumber <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> bookContent <span class="token operator">=</span> <span class="token keyword">REPLACE</span> <span class="token punctuation">(</span> bookContent<span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">&quot;\\'&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">SET</span> <span class="token variable">@stmt</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span>
				<span class="token string">'insert into '</span><span class="token punctuation">,</span>
				tableName<span class="token punctuation">,</span>
				<span class="token string">'(`id`, `chapter_id`, `content`) VALUES ('</span><span class="token punctuation">,</span>
				contentId<span class="token punctuation">,</span>
				<span class="token string">', '</span><span class="token punctuation">,</span>
				chapterId<span class="token punctuation">,</span>
				<span class="token string">',\''</span><span class="token punctuation">,</span>
				bookContent<span class="token punctuation">,</span>
				<span class="token string">'\')'</span> 
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">PREPARE</span> stmt 
			<span class="token keyword">FROM</span>
				<span class="token variable">@stmt</span><span class="token punctuation">;</span>
			<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
			<span class="token keyword">FETCH</span> report <span class="token keyword">INTO</span> contentId<span class="token punctuation">,</span>
			chapterId<span class="token punctuation">,</span>
			bookContent<span class="token punctuation">,</span>
			createTime<span class="token punctuation">,</span>
			updateTime<span class="token punctuation">;</span>
		
	<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
	<span class="token comment">-- 关闭游标</span>
	<span class="token keyword">CLOSE</span> report<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> copyBookContentData <span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>引入 ShardingSphere-JDBC 官方提供的 Spring Boot Starter 依赖：</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shardingsphere<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shardingsphere-jdbc-core-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>application.yml 中添加 ShardingSphere-JDBC 的配置：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">shardingsphere</span><span class="token punctuation">:</span>
    <span class="token comment"># 是否开启 shardingsphere</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">props</span><span class="token punctuation">:</span>
      <span class="token comment"># 是否在日志中打印 SQL</span>
      <span class="token key atrule">sql-show</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 模式配置</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span>
      <span class="token comment"># 单机模式</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Standalone
      <span class="token key atrule">repository</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件持久化</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> File
        <span class="token key atrule">props</span><span class="token punctuation">:</span>
          <span class="token comment"># 元数据存储路径</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> .shardingsphere
      <span class="token comment"># 使用本地配置覆盖持久化配置</span>
      <span class="token key atrule">overwrite</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 数据源配置</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span> ds_0
      <span class="token key atrule">ds_0</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
        <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">jdbcUrl</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/novel_test<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> test123456
    <span class="token comment"># 规则配置</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据分片</span>
      <span class="token key atrule">sharding</span><span class="token punctuation">:</span>
        <span class="token key atrule">tables</span><span class="token punctuation">:</span>
          <span class="token comment"># book_content 表</span>
          <span class="token key atrule">book_content</span><span class="token punctuation">:</span>
            <span class="token comment"># 数据节点</span>
            <span class="token key atrule">actual-data-nodes</span><span class="token punctuation">:</span> ds_$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>.book_content$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>0..9<span class="token punctuation">}</span>
            <span class="token comment"># 分表策略</span>
            <span class="token key atrule">table-strategy</span><span class="token punctuation">:</span>
              <span class="token key atrule">standard</span><span class="token punctuation">:</span>
                <span class="token comment"># 分片列名称</span>
                <span class="token key atrule">sharding-column</span><span class="token punctuation">:</span> chapter_id
                <span class="token comment"># 分片算法名称</span>
                <span class="token key atrule">sharding-algorithm-name</span><span class="token punctuation">:</span> bookContentSharding
        <span class="token key atrule">sharding-algorithms</span><span class="token punctuation">:</span>
          <span class="token key atrule">bookContentSharding</span><span class="token punctuation">:</span>
            <span class="token comment"># 行表达式分片算法，使用 Groovy 的表达式，提供对 SQL 语句中的 = 和 IN 的分片操作支持</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> INLINE
            <span class="token key atrule">props</span><span class="token punctuation">:</span>
              <span class="token comment"># 分片算法的行表达式</span>
              <span class="token key atrule">algorithm-expression</span><span class="token punctuation">:</span> book_content$<span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">{</span>chapter_id % 10<span class="token punctuation">}</span>
</code></pre></div><p>配置是 ShardingSphere-JDBC 中唯一与应用开发者交互的模块，通过它可以快速清晰的理解 ShardingSphere-JDBC 所提供的功能。</p> <ul><li><p>模式配置： Apache ShardingSphere 提供的 3 种运行模式分别是适用于集成测试的环境启动，方便开发人员在整合功能测试中集成 Apache ShardingSphere 而无需清理运行痕迹<code>内存模式</code>、能够将数据源和规则等元数据信息持久化，但无法将元数据同步至多个 Apache ShardingSphere 实例，无法在集群环境中相互感知的<code>单机模式</code>和提供了多个 Apache ShardingSphere 实例之间的元数据共享和分布式场景下状态协调能力的<code>集群模式</code>。</p></li> <li><p>数据源配置：包括使用本地数据源配置（本项目中）和使用 JNDI 数据源的配置。如果计划使用 JNDI 配置数据库，在应用容器（如 Tomcat）中使用 ShardingSphere-JDBC 时， 可使用 spring.shardingsphere.datasource.${datasourceName}.jndiName 来代替数据源的一系列配置。</p></li> <li><p>规则配置：规则是 Apache ShardingSphere 面向可插拔的一部分，包括数据分片、读写分离、高可用、数据加密、影子库、SQL 解析、混合规则等。</p></li></ul> <p>以下是数据分片的配置项说明：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 标准分片表配置</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.actual-data-nodes</span><span class="token punctuation">=</span> <span class="token value attr-value"># 由数据源名 + 表名组成，以小数点分隔。多个表以逗号分隔，支持 inline 表达式。缺省表示使用已知数据源与逻辑表名称生成数据节点，用于广播表（即每个库中都需要一个同样的表用于关联查询，多为字典表）或只分库不分表且所有库的表结构完全一致的情况</span>

<span class="token comment"># 分库策略，缺省表示使用默认分库策略，以下的分片策略只能选其一</span>

<span class="token comment"># 用于单分片键的标准分片场景</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.standard.sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片列名称</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.standard.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片算法名称</span>

<span class="token comment"># 用于多分片键的复合分片场景</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.complex.sharding-columns</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片列名称，多个列以逗号分隔</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.complex.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片算法名称</span>

<span class="token comment"># 用于 Hint 的分片策略</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.database-strategy.hint.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片算法名称</span>

<span class="token comment"># 分表策略，同分库策略</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.table-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 省略</span>

<span class="token comment"># 自动分片表配置</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.actual-data-sources</span><span class="token punctuation">=</span> <span class="token value attr-value"># 数据源名</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.sharding-strategy.standard.sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片列名称</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.auto-tables.&lt;auto-table-name&gt;.sharding-strategy.standard.sharding-algorithm-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># 自动分片算法名称</span>

<span class="token comment"># 分布式序列策略配置</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.key-generate-strategy.column</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分布式序列列名称</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.tables.&lt;table-name&gt;.key-generate-strategy.key-generator-name</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分布式序列算法名称</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[0]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 绑定表规则列表</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[1]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 绑定表规则列表</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.binding-tables[x]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 绑定表规则列表</span>

<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[0]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 广播表规则列表</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[1]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 广播表规则列表</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.broadcast-tables[x]</span><span class="token punctuation">=</span> <span class="token value attr-value"># 广播表规则列表</span>

<span class="token key attr-name">spring.shardingsphere.sharding.default-database-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 默认数据库分片策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-table-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 默认表分片策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-key-generate-strategy.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 默认分布式序列策略</span>
<span class="token key attr-name">spring.shardingsphere.sharding.default-sharding-column</span><span class="token punctuation">=</span> <span class="token value attr-value"># 默认分片列名称</span>

<span class="token comment"># 分片算法配置</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.sharding-algorithms.&lt;sharding-algorithm-name&gt;.type</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片算法类型</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.sharding-algorithms.&lt;sharding-algorithm-name&gt;.props.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分片算法属性配置</span>

<span class="token comment"># 分布式序列算法配置</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.key-generators.&lt;key-generate-algorithm-name&gt;.type</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分布式序列算法类型</span>
<span class="token key attr-name">spring.shardingsphere.rules.sharding.key-generators.&lt;key-generate-algorithm-name&gt;.props.xxx</span><span class="token punctuation">=</span> <span class="token value attr-value"># 分布式序列算法属性配置</span>
</code></pre></div><p>其中，分片算法分为包含取模分片、哈希取模分片、基于分片容量的范围分片、基于分片边界的范围分片、自动时间段分片在内的<code>自动分片算法</code>和包含行表达式分片、时间范围分片在内的<code>标准分片算法</code>以及<code>复合分片算法</code>和<code>Hint 分片算法</code>。我们还可以自定义类分片算法，通过配置分片策略类型和算法类名，实现自定义扩展。</p> <p>分布式序列算法包括雪花算法和 UUID。</p> <h2 id="集成-spring-boot-admin-实现应用管理和监控功能"><a href="#集成-spring-boot-admin-实现应用管理和监控功能" class="header-anchor">#</a> 集成 Spring Boot Admin 实现应用管理和监控功能</h2> <h3 id="spring-boot-actuator-介绍"><a href="#spring-boot-actuator-介绍" class="header-anchor">#</a> Spring Boot Actuator 介绍</h3> <p>当我们将应用程序投入生产时，Spring Boot 包含了许多可以帮助我们对其进行监控和管理的<code>生产就绪功能</code>，我们可以选择使用 HTTP 端点或 JMX 来管理和监控我们的应用程序。</p> <p>Spring Boot Actuator 模块提供了 Spring Boot 的所有<code>生产就绪功能</code>，我们通过添加 spring-boot-starter-actuator <code>Starter</code>依赖来启用这些功能。</p> <p><code>端点</code>（endpoints）让我们可以监控应用程序并与之交互。Spring Boot 包含许多内置端点，并允许我们添加自己的端点。例如，health 端点提供基本的应用程序健康信息。我们可以单独<code>启用</code>或<code>禁用</code>每一个端点并通过 HTTP 或 JMX <code>公开</code>它们（使它们可以远程访问）。当端点被<code>启用</code>和<code>公开</code>时，它被认为是<code>可用</code>的，内置端点仅在可用时才会自动配置。</p> <p>大多数应用程序选择通过 HTTP 公开端点，其中端点的 ID 和前缀 /actuator 被映射到一个 URL 地址。例如，默认情况下，health 端点映射到 /actuator/health。</p> <p>默认情况下，除了 shutdown 之外的所有端点都是启用的，如果要配置一个端点的启用，需要使用 <code>management.endpoint.&lt;id&gt;.enabled</code> 配置属性。</p> <p>由于端点可能包含敏感信息，我们应该仔细考虑何时公开它们。下表显示了内置端点的默认公开情况：</p> <table><thead><tr><th style="text-align:left;">ID</th> <th style="text-align:left;">JMX</th> <th style="text-align:left;">Web</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>auditevents</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>beans</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>caches</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>conditions</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>configprops</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>env</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>flyway</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>health</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">Yes</td></tr> <tr><td style="text-align:left;"><code>heapdump</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>httptrace</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>info</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>integrationgraph</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>jolokia</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>logfile</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>loggers</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>liquibase</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>metrics</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>mappings</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>prometheus</code></td> <td style="text-align:left;">N/A</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>quartz</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>scheduledtasks</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>sessions</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>shutdown</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>startup</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr> <tr><td style="text-align:left;"><code>threaddump</code></td> <td style="text-align:left;">Yes</td> <td style="text-align:left;">No</td></tr></tbody></table> <p>如果想要更改公开的端点，可以使用以下特定技术的 <code>include</code>和<code>exclude</code>配置属性：</p> <table><thead><tr><th style="text-align:left;">Property</th> <th style="text-align:left;">Default</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>management.endpoints.jmx.exposure.exclude</code></td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.jmx.exposure.include</code></td> <td style="text-align:left;"><code>*</code></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.web.exposure.exclude</code></td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>management.endpoints.web.exposure.include</code></td> <td style="text-align:left;"><code>health</code></td></tr></tbody></table> <p>include 属性列出需要公开的端点 ID。exclude 属性列出不应公开的端点 ID，exclude 优先于 include。我们还可以使用端点 ID 列表来配置 include 和 exclude 属性。</p> <p><code>应用程序信息</code>（Application Information）公开了 ApplicationContext 中定义的所有 InfoContributor bean 收集的各种信息。 Spring Boot 包含许多自动配置的 InfoContributor bean，我们也可以编写自己的 InfoContributor bean。</p> <p>在适当的时候，Spring Boot 会自动配置以下的 InfoContributor bean：</p> <table><thead><tr><th style="text-align:left;">ID</th> <th style="text-align:left;">Bean</th> <th style="text-align:left;">描述</th> <th style="text-align:left;">先决条件</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>build</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/BuildInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>BuildInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">公开构建信息</td> <td style="text-align:left;">资源文件<code>META-INF/build-info.properties</code> 存在</td></tr> <tr><td style="text-align:left;"><code>env</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/EnvironmentInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>EnvironmentInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">公开所有以 <code>info.</code>开头的环境属性</td> <td style="text-align:left;">无</td></tr> <tr><td style="text-align:left;"><code>git</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/GitInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>GitInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">公开 git 信息</td> <td style="text-align:left;">资源文件<code>git.properties</code> 存在</td></tr> <tr><td style="text-align:left;"><code>java</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/JavaInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>JavaInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">公开 Java 运行时信息</td> <td style="text-align:left;">无</td></tr> <tr><td style="text-align:left;"><code>os</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/info/OsInfoContributor.java" target="_blank" rel="noopener noreferrer"><code>OsInfoContributor</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">公开操作系统信息</td> <td style="text-align:left;">无</td></tr></tbody></table> <p><code>management.info.&lt;id&gt;.enabled</code> 属性控制单个 InfoContributor bean 是否启用，不同的 InfoContributor bean 对此属性有不同的默认值，这取决于它们的先决条件和它们公开信息的性质。默认情况下 env、java 和 os 被禁用，我们可以通过将其 <code>management.info.&lt;id&gt;.enabled</code> 属性设置为 true 来开启。build 和 git 默认是开启的，我们可以通过将其 <code>management.info.&lt;id&gt;.enabled</code> 属性设置为 false 来禁用。</p> <p><code>健康信息</code>（Health Information）可以用来检查正在运行的应用程序状态。当生产系统出现故障时，监控软件经常使用它来提醒某人。</p> <p>健康信息是从 HealthContributorRegistry 的内容中收集的（默认情况下，所有在 ApplicationContext 中定义的 HealthContributor 实例）。 Spring Boot 包含许多自动配置的 HealthContributor，我们也可以编写自己的。</p> <p>在适当的时候，Spring Boot 会自动配置以下的 HealthIndicator bean：</p> <table><thead><tr><th style="text-align:left;">Key</th> <th style="text-align:left;">Bean</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>cassandra</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/cassandra/CassandraDriverHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>CassandraDriverHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Cassandra 数据库是否已启动。</td></tr> <tr><td style="text-align:left;"><code>couchbase</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/couchbase/CouchbaseHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>CouchbaseHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Couchbase 集群是否已启动。</td></tr> <tr><td style="text-align:left;"><code>db</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/jdbc/DataSourceHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>DataSourceHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查是否可以获得<code>DataSource</code>连接。</td></tr> <tr><td style="text-align:left;"><code>diskspace</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/system/DiskSpaceHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>DiskSpaceHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查磁盘空间是否不足。</td></tr> <tr><td style="text-align:left;"><code>elasticsearch</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/elasticsearch/ElasticsearchRestHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>ElasticsearchRestHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Elasticsearch 集群是否已启动。</td></tr> <tr><td style="text-align:left;"><code>hazelcast</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/hazelcast/HazelcastHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>HazelcastHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Hazelcast 服务是否已启动。</td></tr> <tr><td style="text-align:left;"><code>influxdb</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/influx/InfluxDbHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>InfluxDbHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 InfluxDB 服务是否已启动。</td></tr> <tr><td style="text-align:left;"><code>jms</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/jms/JmsHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>JmsHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 JMS 代理是否已启动。</td></tr> <tr><td style="text-align:left;"><code>ldap</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/ldap/LdapHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>LdapHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 LDAP 服务是否已启动。</td></tr> <tr><td style="text-align:left;"><code>mail</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mail/MailHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>MailHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查邮件服务是否已启动。</td></tr> <tr><td style="text-align:left;"><code>mongo</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mongo/MongoHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>MongoHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Mongo 数据库是否已启动。</td></tr> <tr><td style="text-align:left;"><code>neo4j</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/neo4j/Neo4jHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>Neo4jHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Neo4j 数据库是否已启动。</td></tr> <tr><td style="text-align:left;"><code>ping</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/health/PingHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>PingHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">始终以 <code>UP</code>响应。</td></tr> <tr><td style="text-align:left;"><code>rabbit</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/amqp/RabbitHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>RabbitHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Rabbit 服务是否已启动。</td></tr> <tr><td style="text-align:left;"><code>redis</code></td> <td style="text-align:left;"><a href="https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/redis/RedisHealthIndicator.java" target="_blank" rel="noopener noreferrer"><code>RedisHealthIndicator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">检查 Redis 服务是否已启动。</td></tr></tbody></table> <p>我们可以通过 <code>management.health.&lt;key&gt;.enabled</code> 配置来启用或禁用选定的健康检查。</p> <h3 id="spring-boot-admin-介绍"><a href="#spring-boot-admin-介绍" class="header-anchor">#</a> Spring Boot Admin 介绍</h3> <p>Spring Boot Admin 是一个用于管理和监控我们 Spring Boot 应用程序的开源项目，由服务端（Spring Boot Admin Server）和客户端（Spring Boot Admin Client）两部分构成。</p> <p>应用程序使用 Spring Boot Admin Client（通过 HTTP）或使用 Spring Cloud 自动发现（例如 Eureka、Consul、Nacos 等）向 Spring Boot Admin Server 注册。</p> <p>Spring Boot Admin Server UI 是构建在 Spring Boot Actuator 端点之上的 Vue.js 应用程序，Spring Boot Admin Server 的监控信息均来自 Spring Boot Actuator 端点，并且通过端点来管理我们的应用程序。</p> <h3 id="构建-spring-boot-admin-server"><a href="#构建-spring-boot-admin-server" class="header-anchor">#</a> 构建 Spring Boot Admin Server</h3> <ol><li>使用 <a href="https://start.spring.io/" target="_blank" rel="noopener noreferrer">Spring Initializr<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 初始化一个 Spring Boot 项目，并加入以下依赖：</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0-M1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>在 application.properties 配置文件中添加 Spring Security 用户名、密码的配置属性，用于登录 Spring Boot Admin Server：</li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token key attr-name">spring.security.user.name</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>
<span class="token key attr-name">spring.security.user.password</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>
</code></pre></div><ol start="3"><li>在启动类上添加 @EnableAdminServer 注解：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableAdminServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitorApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MonitorApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>添加 Spring Security 配置类：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Spring Security 配置
 *
 * @author xiongxiaoyang
 * @date 2022/6/8
 */</span>
<span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecuritySecureConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AdminServerProperties</span> adminServer<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityProperties</span> security<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecuritySecureConfig</span><span class="token punctuation">(</span><span class="token class-name">AdminServerProperties</span> adminServer<span class="token punctuation">,</span> <span class="token class-name">SecurityProperties</span> security<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>adminServer <span class="token operator">=</span> adminServer<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>security <span class="token operator">=</span> security<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span> successHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        successHandler<span class="token punctuation">.</span><span class="token function">setTargetUrlParameter</span><span class="token punctuation">(</span><span class="token string">&quot;redirectTo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        successHandler<span class="token punctuation">.</span><span class="token function">setDefaultTargetUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>
                        authorizeRequests <span class="token operator">-&gt;</span> authorizeRequests
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/assets/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/health&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span>
                        formLogin <span class="token operator">-&gt;</span> formLogin
                                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>successHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>
                        logout <span class="token operator">-&gt;</span> logout<span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>csrf <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">csrfTokenRepository</span><span class="token punctuation">(</span><span class="token class-name">CookieCsrfTokenRepository</span><span class="token punctuation">.</span><span class="token function">withHttpOnlyFalse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ignoringRequestMatchers</span><span class="token punctuation">(</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/instances&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/instances/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/actuator/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span>rememberMe <span class="token operator">-&gt;</span> rememberMe
                        <span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">tokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">1209600</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Required to provide UserDetailsService for &quot;remember functionality&quot;
     * */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span>security<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;{noop}&quot;</span> <span class="token operator">+</span> security<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>此时，运行应用程序，浏览器中访问 8080 端口，输入上面配置的用户名和密码即可进入 Spring Boot Admin Server 控制台管理和监控我们的应用程序。</p> <h3 id="通过-spring-boot-admin-client-注册-novel-服务"><a href="#通过-spring-boot-admin-client-注册-novel-服务" class="header-anchor">#</a> 通过 Spring Boot Admin Client 注册 novel 服务</h3> <ol><li>在我们 novel 项目中加入以下依赖：</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0-M1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>在 novel 项目的 application.yml 配置文件中加入以下配置：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># Spring Boot 应用管理和监控</span>
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token comment"># 是否开启 Spring Boot Admin 客户端</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># Spring Boot Admin 服务端注册地址</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token comment"># Spring Boot Admin 服务端认证用户名</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> novel
        <span class="token comment"># Spring Boot Admin 服务端认证密码</span>
        <span class="token key atrule">password</span><span class="token punctuation">:</span> novel
        <span class="token key atrule">instance</span><span class="token punctuation">:</span>
          <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
            <span class="token comment"># SBA Client</span>
            <span class="token key atrule">user.name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.security.user.name<span class="token punctuation">}</span>
            <span class="token key atrule">user.password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.security.user.password<span class="token punctuation">}</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token comment"># Actuator 端点保护配置</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ENDPOINT_ADMIN
      <span class="token key atrule">password</span><span class="token punctuation">:</span> ENDPOINT_ADMIN
      <span class="token key atrule">roles</span><span class="token punctuation">:</span> ENDPOINT_ADMIN

<span class="token comment"># Actuator 端点管理</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token comment"># 端点公开配置</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token comment"># 通过 HTTP 公开的 Web 端点</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token comment"># 公开所有的 Web 端点</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>

  <span class="token comment"># 端点启用配置</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">logfile</span><span class="token punctuation">:</span>
      <span class="token comment"># 启用返回日志文件内容的端点</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 外部日志文件路径</span>
      <span class="token key atrule">external-file</span><span class="token punctuation">:</span> logs/novel.log

  <span class="token key atrule">info</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># 公开所有以 info. 开头的环境属性</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">health</span><span class="token punctuation">:</span>
    <span class="token key atrule">rabbit</span><span class="token punctuation">:</span>
      <span class="token comment"># 关闭 rabbitmq 的健康检查</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
      <span class="token comment"># 关闭 elasticsearch 的健康检查</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

</code></pre></div><ol start="3"><li>novel 项目启动类中添加 Spring Boot Actuator 端点保护的 Spring Security 配置：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">requestMatcher</span><span class="token punctuation">(</span><span class="token class-name">EndpointRequest</span><span class="token punctuation">.</span><span class="token function">toAnyEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span>requests <span class="token operator">-&gt;</span> requests<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;ENDPOINT_ADMIN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时，启动 novel 项目，登录 Spring Boot Admin Server 控制台可以看到如下监控信息：</p> <p><img src="/img/novel/springbootadmin1.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin2.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin3.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin4.png" alt="Spring Boot Admin"> <img src="/img/novel/springbootadmin5.png" alt="Spring Boot Admin"></p> <p>踩坑：在启动 Spring Boot Admin Server 之前有个 node 程序监听了 8080 端口没有释放，然后启动 Spring Boot Admin Server（默认也是 8080 端口），此时浏览器中可以正常访问到 Spring Boot Admin Server 的界面，但是 novel 服务无法注册到 Spring Boot Admin Server 上，提示404 错误。后来发现 novel 服务的注册被监听 8080 端口的 node 程序处理了，关闭该 node 程序即可正常注册。 该机制请参考 <a href="https://segmentfault.com/a/1190000014701988" target="_blank" rel="noopener noreferrer">Node.Js 的端口重用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="使用-docker-compose-一键安装开发环境"><a href="#使用-docker-compose-一键安装开发环境" class="header-anchor">#</a> 使用 Docker Compose 一键安装开发环境</h2> <ol><li>Docker Compose 安装。（除了第一步需要根据自己的平台去安装 Docker Compose 以外，其它步骤都一样）</li></ol> <p>在 Ubuntu 下执行如下的安装命令：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-y</span>
</code></pre></div><p>查看 Docker Compose 和 Docker 的版本信息：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">docker-compose</span> version

<span class="token function">docker</span> <span class="token parameter variable">--version</span>

<span class="token function">docker</span> version
</code></pre></div><ol start="2"><li>创建 <code>.env</code> 文件，用来设置容器编排的环境变量。</li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># MYSQL 配置</span>
<span class="token key attr-name">MYSQL_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.0</span>
<span class="token key attr-name">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>

<span class="token comment"># Redis 配置</span>
<span class="token key attr-name">REDIS_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">7.0</span>
<span class="token key attr-name">REDIS_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>

<span class="token comment"># RabbitMQ 配置</span>
<span class="token key attr-name">RABBITMQ_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">3-management</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_USER</span><span class="token punctuation">=</span><span class="token value attr-value">xxyopen</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_PASS</span><span class="token punctuation">=</span><span class="token value attr-value">test123456</span>
<span class="token key attr-name">RABBITMQ_DEFAULT_VHOST</span><span class="token punctuation">=</span><span class="token value attr-value">novel</span>

<span class="token comment"># Elasticsearch 配置</span>
<span class="token key attr-name">ELASTIC_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.6.2</span>
<span class="token comment"># 'elastic' 账户的密码 (至少 6 个字符)</span>
<span class="token key attr-name">ELASTIC_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">Fy2JWjJ1hcO2mi1USFL1</span>
<span class="token comment"># 'kibana_system' 账号的密码 (至少 6 个字符)</span>
<span class="token key attr-name">KIBANA_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">5JbbVsW9TkYcJu9Y9</span>

<span class="token comment"># Kibana 配置</span>
<span class="token key attr-name">KIBANA_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">8.6.2</span>

<span class="token comment"># XXL-JOB 配置</span>
<span class="token key attr-name">XXLJOB_VERSION</span><span class="token punctuation">=</span><span class="token value attr-value">2.3.1</span>
<span class="token key attr-name">XXLJOB_ACCESSTOKEN</span><span class="token punctuation">=</span><span class="token value attr-value">123</span>

</code></pre></div><ol start="3"><li>创建 Docker Compose 的容器编排文件 <code>docker-compose.yml</code>。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.9'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">novel-mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>$<span class="token punctuation">{</span>MYSQL_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=$<span class="token punctuation">{</span>MYSQL_ROOT_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;/data/docker/mysql/data:/var/lib/mysql&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;/data/docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>max_allowed_packet=100M
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;3306:3306&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>redis
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>$<span class="token punctuation">{</span>REDIS_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>redis
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>save 60 1 <span class="token punctuation">-</span><span class="token punctuation">-</span>loglevel warning <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass &quot;$<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">}</span>&quot;
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;6379:6379&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>rabbitmq
    <span class="token key atrule">image</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">:</span>$<span class="token punctuation">{</span>RABBITMQ_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>rabbitmq
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_USER=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_USER<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_PASS=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_PASS<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> RABBITMQ_DEFAULT_VHOST=$<span class="token punctuation">{</span>RABBITMQ_DEFAULT_VHOST<span class="token punctuation">}</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;15672:15672&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5672:5672&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-elasticsearch-setup</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>$<span class="token punctuation">{</span>ELASTIC_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">&quot;0&quot;</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
      bash -c '
        echo &quot;Waiting for Elasticsearch availability&quot;;
        until curl -s http://novel-elasticsearch:9200 | grep -q &quot;missing authentication credentials&quot;; do sleep 30; done;
        echo &quot;Setting kibana_system password&quot;;
        until curl -s -X POST -u &quot;elastic:${ELASTIC_PASSWORD}&quot; -H &quot;Content-Type: application/json&quot; http://novel-elasticsearch:9200/_security/user/kibana_system/_password -d &quot;{\&quot;password\&quot;:\&quot;${KIBANA_PASSWORD}\&quot;}&quot; | grep -q &quot;^{}&quot;; do sleep 10; done;
        echo &quot;All done!&quot;;
      '</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>$<span class="token punctuation">{</span>ELASTIC_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms125m -Xmx512m&quot;</span>
      <span class="token punctuation">-</span> discovery.type=single<span class="token punctuation">-</span>node
      <span class="token punctuation">-</span> ELASTIC_PASSWORD=$<span class="token punctuation">{</span>ELASTIC_PASSWORD<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> KIBANA_PASSWORD=$<span class="token punctuation">{</span>KIBANA_PASSWORD<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> xpack.security.http.ssl.enabled=false
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">-</span>setup
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>kibana
    <span class="token key atrule">image</span><span class="token punctuation">:</span> kibana<span class="token punctuation">:</span>$<span class="token punctuation">{</span>KIBANA_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>kibana
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ELASTICSEARCH_HOSTS=http<span class="token punctuation">:</span>//novel<span class="token punctuation">-</span>elasticsearch<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> ELASTICSEARCH_USERNAME=kibana_system
      <span class="token punctuation">-</span> ELASTICSEARCH_PASSWORD=$<span class="token punctuation">{</span>KIBANA_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

  <span class="token key atrule">novel-xxl-job-admin</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">image</span><span class="token punctuation">:</span> xuxueli/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin<span class="token punctuation">:</span>$<span class="token punctuation">{</span>XXLJOB_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> novel<span class="token punctuation">-</span>xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> PARAMS=<span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.url=jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//novel<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span>3306/xxl_job<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.username=root <span class="token punctuation">-</span><span class="token punctuation">-</span>spring.datasource.password=$<span class="token punctuation">{</span>MYSQL_ROOT_PASSWORD<span class="token punctuation">}</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>xxl.job.accessToken=$<span class="token punctuation">{</span>XXLJOB_ACCESSTOKEN<span class="token punctuation">}</span>
      <span class="token punctuation">-</span> JAVA_OPTS=<span class="token punctuation">-</span>Xmx512m
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/docker/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin/data/applogs<span class="token punctuation">:</span>/data/applogs
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8080:8080&quot;</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novel<span class="token punctuation">-</span>mysql
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> novelnet

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">novelnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre></div><blockquote><p>注意：Elasticsearch 容器挂载本地目录或文件时，需要修改目录或文件的读写权限，否则启动不成功。官方原文如下：</p> <p>If you are bind-mounting a local directory or file, it must be readable by the elasticsearch user. In addition, this user must have write access to the data and log dirs. A good strategy is to grant group access to gid 1000 or 0 for the local directory.</p> <p>For example, to prepare a local directory for storing data through a bind-mount:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> esdatadir
<span class="token function">chmod</span> g+rwx esdatadir
<span class="token function">chgrp</span> <span class="token number">1000</span> esdatadir
</code></pre></div></blockquote> <ol start="4"><li>在后台运行所有编排文件中的容器。</li></ol> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre></div><ol start="5"><li>使用 <code>.env</code> 环境文件中配置的 <code>elastic</code> 账号密码来登录 kibana 控制台。</li></ol> <div class="language- extra-class"><pre class="language-text"><code>elastic
Fy2JWjJ1hcO2mi1USFL1
</code></pre></div><blockquote><p><strong>注意：需要先将 xxl-job 的数据库文件导入 MySQL 后，xxl-job-admin 才能正常访问。</strong></p></blockquote> <h2 id="集成-flyway-实现数据库的版本管理"><a href="#集成-flyway-实现数据库的版本管理" class="header-anchor">#</a> 集成 Flyway 实现数据库的版本管理</h2> <p>你是否时常为以下问题所困扰：</p> <ul><li>我的数据库当前处于哪个版本？</li> <li>哪些 SQL 脚本已经被执行？</li> <li>如何高效地创建新的数据库实例？</li></ul> <p>数据库迁移一直是 Java 开发者在软件开发周期中面临的重要挑战之一。随着业务需求的不断扩展和功能的持续迭代，数据库结构通常需要进行相应的调整和优化。为了保障数据库与应用程序版本之间的一致性，同时简化数据库变更的管理流程，<a href="https://github.com/flyway/flyway" target="_blank" rel="noopener noreferrer">Flyway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这一工具应运而生，成为了解决上述问题的得力助手。</p> <p>Flyway 引入了数据库版本控制的概念，使开发者能够轻松实现从任意版本（包括全新的空白数据库）到最新数据库状态的迁移。无论你是经验丰富的数据库管理员还是具备基础 SQL 知识的开发者，Flyway 的直观性和易用性都使得数据库迁移过程变得简单而高效。因此，Flyway 在 Spring Boot 团队中备受推崇，成为了许多项目中不可或缺的数据库迁移工具。</p> <p>由于 Spring Boot 官方已经对 Flyway 数据库迁移工具进行了集成，因此在 Spring Boot 项目中利用 Flyway 进行数据库版本管理变得极为简便：</p> <p>1.添加 Flyway 的 Maven 依赖项。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2.创建迁移脚本目录<code>src/main/resources/db/migration</code>。</p> <p>Spring Boot 配置的默认迁移脚本目录是<code>src/main/resources/db/migration</code>，可以通过<code>spring.flyway.locations</code>配置项进行修改。</p> <p>3.在迁移脚本目录下面创建迁移脚本。</p> <p>Flyway 允许我们通过编写简单的 SQL 脚本来定义数据库的变更集。这些脚本按照特定的命名规则进行排序和执行，从而确保数据库迁移的顺序性和可追踪性。</p> <p>迁移脚本有两种命名规则：</p> <ul><li><code>V&lt;version&gt;__&lt;description&gt;.sql</code>：这些是内容不可以变更，只会执行一次的迁移脚本，按照版本号从小到大执行。</li> <li><code>R__&lt;description&gt;.sql</code>：这些是内容可以变更且支持重复执行的迁移脚本。Flyway 能够精准地识别脚本内容是否有所变动，并在检测到任何变动时自动重复执行相应的脚本。例如，R_novel_data.sql 就是这样一个专门设计的脚本，它负责定期向数据库中插入新的小说测试数据。为了有效管理脚本文件的数量和大小，我们采用了一种策略，即每次执行时都会用新的插入脚本覆盖掉旧的插入脚本，从而保持数据更新的同时，也保证了脚本文件的简洁和高效。</li></ul> <div align="center"><img src="/img/novel/flyway1.png"></div> <p>4.在 IntelliJ IDEA 中启动 novel 项目时，控制台会清晰地显示 Flyway 的迁移日志。Flyway 会智能地检测尚未应用的数据库迁移脚本，并按照其版本号的顺序自动执行这些脚本，从而确保数据库结构的准确性和一致性。由于这是我第二次启动项目，Flyway 已经识别到所有必要的迁移都已成功应用，因此它不会再次执行这些脚本，从而避免了不必要的重复操作。这种机制大大提高了开发效率，并确保了数据库迁移过程的可靠性和可维护性。</p> <div align="center"><img src="/img/novel/flyway2.png"></div> <p>当你检查数据库时，会注意到存在一个名为 flyway_schema_history 的自动生成数据表。这张表详细记录了 Flyway 所执行的所有迁移操作，包括每次迁移的详细信息和状态。通过查阅这张表，你可以清晰地追踪到数据库结构的演变历程，并验证迁移后的数据表结构是否已正确应用。这种详尽的记录机制为你提供了对数据库变更的深入洞察和强大的审计能力。</p> <div align="center"><img src="/img/novel/flyway3.png"></div> <p>如果需要，我们还可以使用 Flyway 提供的命令行工具或 API 来验证迁移的正确性，甚至在必要时进行回滚操作。</p> <p>通过以上步骤，Flyway 在 novel 项目中帮助我们实现了数据库迁移的版本管理和自动迁移，大大提高了开发效率和数据库变更的可控性。</p> <p>随着持续交付等技术的普及，数据库迁移的自动化已经成为许多软件团队不可或缺的一部分。Flyway 可以与 CI/CD 工具集成，如 Jenkins、Travis CI、GitLab CI 等，实现数据库迁移的自动化。</p> <h2 id="开启虚拟线程-提高项目的并发能力"><a href="#开启虚拟线程-提高项目的并发能力" class="header-anchor">#</a> 开启虚拟线程，提高项目的并发能力</h2> <p>虚拟线程是在 Java 21 中引入的一种线程抽象。它提供了轻量级的线程实现方式，由 JVM 来调度，可以实现用户级别的线程调度和管理。它和操作系统进行线程调度和管理一样，但是它不需要系统内核介入，不需要进行开销非常大的上下文切换，能够大幅度提高 Java 的并发能力。因此，虚拟线程在 Java 21 中被很多人称作是史诗级的更新。</p> <p>Spring Boot 3.2.0 开始支持虚拟线程（Project Loom），可以通过将属性 spring.threads.virtual.enabled 设置为 true 来启用虚拟线程。 如果启用了虚拟线程，配置线程池的属性将不再起作用，因为虚拟线程是在 JVM 范围的平台线程池上而不是在专用线程池上调度的。</p> <p>由于 novel 使用的 Spring Boot 版本是 3.3.0，所以我们可以在 novel 项目中通过开启虚拟线程来提高项目的并发能力，但是首先必须在 Java 21 上运行虚拟线程才能生效，然后将属性 spring.threads.virtual.enabled 设置为 true。启用虚拟线程后，Tomcat 和 Jetty 将使用虚拟线程进行请求处理（Undertow 暂不支持）。这意味着处理 Web 请求的应用程序代码（如控制器中的方法）将在虚拟线程上运行。</p> <blockquote><p>注意：虚拟线程的一个潜在副作用是它们作为守护线程运行。如果 JVM 中的所有线程都是守护线程，则 JVM 会直接退出，不会等待这些线程完成其执行。如果应用程序是依赖 <code>@Scheduled bean</code> 的调度任务线程来保持 JVM 运行的话，开启虚拟线程后，<code>@Scheduled bean</code> 调度任务线程就是一个虚拟线程，是一个守护线程，无法阻止 JVM 的关闭，其他依赖于线程存活的技术也会如此。为了在所有情况下都保持 JVM 运行，建议将属性 <code>spring.main.keep-alive</code> 设置为 <code>true</code>。这会确保 JVM 保持运行状态，即使所有线程都是虚拟线程。</p></blockquote> <p>如下所示，我们直接在<code>application.yml</code>配置文件中加入如下属性即可开启虚拟线程：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># 启用虚拟线程</span>
  <span class="token key atrule">threads</span><span class="token punctuation">:</span>
    <span class="token key atrule">virtual</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 即使所有的用户线程（包括虚拟线程）都是守护线程的情况下，JVM 也不会立即退出，</span>
  <span class="token comment"># Spring Boot 官方建议在开启虚拟线程时设置该属性</span>
  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5 months ago</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/course/novel/4.html" class="prev">
        项目开发
      </a></span> <span class="next"><a href="/course/novel/6.html">
        项目部署
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6280180d.js" defer></script><script src="/assets/js/3.64ef1717.js" defer></script><script src="/assets/js/2.954998af.js" defer></script><script src="/assets/js/20.2d84071d.js" defer></script>
  </body>
</html>
